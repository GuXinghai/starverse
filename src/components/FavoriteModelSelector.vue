<template>
  <div class="favorite-model-selector">
    <!-- æ”¶è—æ¨¡å‹å¿«é€Ÿé€‰æ‹©å™¨ -->
    <div v-if="favoriteModels.length > 0" class="favorites-list">
      <button
        v-for="model in favoriteModels"
        :key="model.id"
        @click="selectModel(model.id)"
        :class="[
          'favorite-model-btn',
          { 'active': isCurrentModel(model.id) }
        ]"
        :title="`åˆ‡æ¢åˆ° ${model.name}\nä¸Šä¸‹æ–‡: ${formatContextLength(model.context_length)}\nä»·æ ¼: $${model.pricing.prompt}/$${model.pricing.completion}`"
      >
        <div class="model-info">
          <!-- æ¨¡å‹åç§°æ»šåŠ¨å®¹å™¨ -->
          <div 
            class="model-name-container"
            :class="{ 'scrolling': scrollingModels[model.id] }"
          >
            <!-- 
              ç¯å¸¦å¼æ»šåŠ¨ç»“æ„
              ==================
              å½“æ–‡æœ¬éœ€è¦æ»šåŠ¨æ—¶ï¼Œä½¿ç”¨"ç¯å¸¦"ç»“æ„å®ç°æ— ç¼å¾ªç¯ï¼š
              [æ–‡æœ¬A] + [ç©ºç™½åŒºG] + [æ–‡æœ¬Aå‰¯æœ¬]
              
              åŠ¨ç”»ä»ä½ç½® 0 æ»šåŠ¨åˆ° -(C+G)ï¼Œç„¶åè·³å› 0
              ç”±äºæ–‡æœ¬é‡å¤ï¼Œè·³è·ƒæ˜¯è§†è§‰æ— ç¼çš„
              
              æ³¨æ„ï¼šåªåœ¨ scrollingModels[model.id] å­˜åœ¨æ—¶æ˜¾ç¤ºï¼ˆå³åˆ¤æ–­éœ€è¦æ»šåŠ¨ï¼‰
            -->
            <span 
              v-if="scrollingModels[model.id]"
              class="model-name-belt"
              :style="{
                animationName: scrollingModels[model.id].animName,      // åŠ¨æ€ç”Ÿæˆçš„ @keyframes åç§°
                animationDuration: `${scrollingModels[model.id].T}ms`,  // åŠ¨ç”»å‘¨æœŸï¼ˆmsï¼‰
                animationTimingFunction: 'linear',                       // çº¿æ€§æ—¶é—´å‡½æ•°ï¼ˆå…³é”®å¸§å†…éƒ¨æ§åˆ¶é€Ÿåº¦ï¼‰
                animationIterationCount: 'infinite'                      // æ— é™å¾ªç¯
              }"
            >
              <!-- ç¬¬ä¸€ä»½æ–‡æœ¬ï¼šæ€»æ˜¯æ˜¾ç¤º -->
              <span class="belt-text">{{ formatModelName(model.name) }}</span>
              
              <!-- ç©ºç™½åŒºï¼šåªåœ¨éœ€è¦æ»šåŠ¨æ—¶æ˜¾ç¤ºï¼Œå®½åº¦åŠ¨æ€è®¡ç®— -->
              <span 
                class="belt-gap"
                :style="{ width: `${scrollingModels[model.id].G}px` }"
              ></span>
              
              <!-- ç¬¬äºŒä»½æ–‡æœ¬ï¼šåªåœ¨éœ€è¦æ»šåŠ¨æ—¶æ˜¾ç¤ºï¼Œç”¨äºæ— ç¼å¾ªç¯ -->
              <span class="belt-text">{{ formatModelName(model.name) }}</span>
            </span>
            
            <!-- 
              é™æ€æ–‡æœ¬æ˜¾ç¤º
              ==================
              å½“æ–‡æœ¬ä¸éœ€è¦æ»šåŠ¨æ—¶ï¼ˆæ–‡æœ¬å®½åº¦ <= å®¹å™¨å®½åº¦ï¼‰ï¼Œ
              ä½¿ç”¨æ™®é€šçš„ text-overflow: ellipsis æˆªæ–­
              
              æ³¨æ„ï¼šref ç»‘å®šç”¨äºæµ‹é‡æ–‡æœ¬å®½åº¦ï¼Œå³ä½¿åœ¨é™æ€æ¨¡å¼ä¸‹ä¹Ÿéœ€è¦
            -->
            <span 
              v-if="!scrollingModels[model.id]" 
              :ref="el => setNameRef(model.id, el)"
              class="model-name-static"
            >
              <!-- æ·»åŠ éšè—çš„ .belt-text ç”¨äºå®½åº¦æµ‹é‡ -->
              <span class="belt-text" style="position: absolute; visibility: hidden; white-space: nowrap;">{{ formatModelName(model.name) }}</span>
              <!-- å®é™…æ˜¾ç¤ºçš„æ–‡æœ¬ -->
              {{ formatModelName(model.name) }}
            </span>
          </div>
          <span class="model-series">{{ model.series }}</span>
        </div>
        <div class="model-meta">
          <span class="context-badge" v-if="model.context_length">
            {{ formatContextLength(model.context_length) }}
          </span>
          <span class="modality-badge" v-if="hasMultimodal(model)">
            ğŸ¨
          </span>
        </div>
      </button>
    </div>
  </div>
</template>

<script setup>
import { computed, ref, onMounted, onUnmounted, nextTick, watch } from 'vue'
import { useChatStore } from '../stores/chatStore'

const chatStore = useChatStore()

// ä» store è·å–æ”¶è—æ¨¡å‹åˆ—è¡¨
const favoriteModels = computed(() => chatStore.favoriteModels)

// å­˜å‚¨æ¯ä¸ªæ¨¡å‹åç§°çš„ DOM å¼•ç”¨
// key: modelId, value: .model-name-belt å…ƒç´ 
const nameRefs = ref({})

// å­˜å‚¨éœ€è¦æ»šåŠ¨çš„æ¨¡å‹ ID åŠå…¶åŠ¨ç”»å‚æ•°
// key: modelId, value: { C, W, G, L, T, animName }
// C: æ–‡å­—åŒºé•¿åº¦ï¼ˆpxï¼‰
// W: çª—å£å¯ç”¨å®½åº¦ï¼ˆpxï¼‰
// G: ç©ºç™½åŒºé•¿åº¦ï¼ˆpxï¼‰
// L: æ€»ç¯é•¿ = C + Gï¼ˆpxï¼‰
// T: åŠ¨ç”»æ€»å‘¨æœŸï¼ˆmsï¼‰
// animName: CSS åŠ¨ç”»åç§°
const scrollingModels = ref({})

/**
 * è®¾ç½®æ¨¡å‹åç§°å…ƒç´ çš„ DOM å¼•ç”¨
 * 
 * è¿™æ˜¯ Vue çš„ ref å›è°ƒå‡½æ•°ï¼Œåœ¨æ¨¡æ¿ä¸­é€šè¿‡ :ref="el => setNameRef(model.id, el)" è°ƒç”¨
 * æ¯å½“ç»„ä»¶æ¸²æŸ“æˆ–æ›´æ–°æ—¶ï¼ŒVue ä¼šä¸ºæ¯ä¸ªå…ƒç´ è°ƒç”¨æ­¤å‡½æ•°
 * 
 * @param {string} modelId - æ¨¡å‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
 * @param {HTMLElement|null} el - DOM å…ƒç´ å¼•ç”¨ï¼ˆå¸è½½æ—¶ä¸º nullï¼‰
 */
const setNameRef = (modelId, el) => {
  if (el) {
    nameRefs.value[modelId] = el
  }
}

/**
 * æ£€æµ‹å“ªäº›æ¨¡å‹åç§°éœ€è¦æ»šåŠ¨æ’­æ”¾
 * 
 * =====================
 * æ ¸å¿ƒåŠŸèƒ½è¯´æ˜
 * =====================
 * 
 * 1. éå†æ‰€æœ‰æ”¶è—æ¨¡å‹çš„åç§°å…ƒç´ 
 * 2. æµ‹é‡æ–‡æœ¬å®é™…å®½åº¦ï¼ˆCï¼‰å’Œå®¹å™¨å¯ç”¨å®½åº¦ï¼ˆWï¼‰
 * 3. å¦‚æœ C > Wï¼Œè¯´æ˜æ–‡æœ¬æº¢å‡ºï¼Œéœ€è¦æ»šåŠ¨
 * 4. ä¸ºæº¢å‡ºçš„æ–‡æœ¬ç”Ÿæˆå››é˜¶æ®µ CSS åŠ¨ç”»
 * 5. ä½¿ç”¨"ç¯å¸¦"ç»“æ„å®ç°æ— ç¼å¾ªç¯æ»šåŠ¨
 * 
 * =====================
 * ç¯å¸¦ç»“æ„åŸç†
 * =====================
 * 
 * ç»“æ„ï¼š[æ–‡æœ¬A] + [ç©ºç™½åŒºG] + [æ–‡æœ¬Aå‰¯æœ¬]
 * 
 * æ€»é•¿åº¦ L = C + Gï¼Œå…¶ä¸­ï¼š
 *   C = æ–‡å­—åŒºé•¿åº¦ï¼ˆå•ä»½æ–‡æœ¬çš„å®½åº¦ï¼‰
 *   G = ç©ºç™½åŒºé•¿åº¦ï¼ˆè®¾è®¡ä¸º max(40px, 0.5*C)ï¼‰
 * 
 * åŠ¨ç”»ä»ä½ç½® 0 æ»šåŠ¨åˆ° -(C+G)ï¼Œç„¶åç¬é—´è·³å› 0
 * ç”±äºç¯å¸¦ä¸­æœ‰ä¸¤ä»½ç›¸åŒæ–‡æœ¬ï¼Œè·³è·ƒæ—¶è§†è§‰ä¸Šæ˜¯è¿ç»­çš„
 * 
 * =====================
 * å››é˜¶æ®µåŠ¨ç”»è®¾è®¡
 * =====================
 * 
 * æ ¹æ® BELT_SCROLL_IMPLEMENTATION.md æ–‡æ¡£è¦æ±‚ï¼š
 * 
 * ç¬¬1é˜¶æ®µï¼ˆåœé¡¿ï¼‰ï¼š0% â†’ p_delay%
 *   - ä½ç½®ä¿æŒåœ¨ 0
 *   - æ—¶é•¿ tau0 = 500msï¼ˆå›ºå®šï¼‰
 *   - è®©ç”¨æˆ·æœ‰æ—¶é—´çœ‹æ¸…å¼€å¤´
 * 
 * ç¬¬2é˜¶æ®µï¼ˆé˜…è¯»ï¼‰ï¼šp_delay% â†’ p_read%
 *   - ä½ç½®ä» 0 åŒ€é€Ÿç§»åŠ¨åˆ° -C
 *   - é€Ÿåº¦ v1 = 50px/sï¼ˆå¯è¯»é€Ÿåº¦ï¼‰
 *   - æ—¶é•¿ t_read = C / v1 * 1000ï¼ˆmsï¼‰
 * 
 * ç¬¬3é˜¶æ®µï¼ˆå‹ç¼©ï¼‰ï¼šp_read% â†’ 100%
 *   - ä½ç½®ä» -C å¿«é€Ÿç§»åŠ¨åˆ° -(C+G)
 *   - é€Ÿåº¦ä¸ºé˜…è¯»é€Ÿåº¦çš„ 4 å€ï¼ˆå‹ç¼©ç³»æ•° 0.25ï¼‰
 *   - æ—¶é•¿ tau_gap = 0.25 * t_read
 * 
 * ç¬¬4é˜¶æ®µï¼ˆå¾ªç¯ï¼‰ï¼š100% â†’ 0%
 *   - ç¬é—´ä» -(C+G) è·³å› 0
 *   - ç”±äºç¯å¸¦ç»“æ„ï¼Œè§†è§‰æ— ç¼
 * 
 * =====================
 * æ•°å­¦å…¬å¼
 * =====================
 * 
 * è®¾è®¡å‚æ•°ï¼š
 *   v1 = 50 px/sï¼ˆé˜…è¯»é€Ÿåº¦ï¼‰
 *   tau0 = 500 msï¼ˆåœé¡¿æ—¶é—´ï¼‰
 *   compression_ratio = 0.25ï¼ˆå‹ç¼©ç³»æ•°ï¼Œå³ 4 å€é€Ÿï¼‰
 * 
 * è®¡ç®—å…¬å¼ï¼š
 *   t_read = C / v1 * 1000ï¼ˆmsï¼‰
 *   tau_gap = compression_ratio * t_readï¼ˆmsï¼‰
 *   T = tau0 + t_read + tau_gapï¼ˆæ€»å‘¨æœŸï¼Œmsï¼‰
 *   G = max(40, 0.5 * C)ï¼ˆç©ºç™½åŒºé•¿åº¦ï¼Œpxï¼‰
 *   L = C + Gï¼ˆç¯å¸¦æ€»é•¿ï¼Œpxï¼‰
 * 
 * å…³é”®å¸§ç™¾åˆ†æ¯”ï¼š
 *   p_delay = tau0 / T * 100ï¼ˆ%ï¼‰
 *   p_read = (tau0 + t_read) / T * 100ï¼ˆ%ï¼‰
 * 
 * @async
 * @returns {Promise<void>}
 */
const detectOverflow = async () => {
  // ç­‰å¾… Vue å®Œæˆ DOM æ›´æ–°
  await nextTick()
  
  // å­˜å‚¨æ–°çš„æ»šåŠ¨æ¨¡å‹é…ç½®
  const newScrollingModels = {}
  
  // æ¸…é™¤æ—§çš„åŠ¨ç”»æ ·å¼è¡¨ï¼Œé¿å…æ ·å¼ç´¯ç§¯å¯¼è‡´å†…å­˜æ³„æ¼
  const oldStyle = document.getElementById('favorite-scroll-animations')
  if (oldStyle) {
    oldStyle.remove()
  }
  
  // åˆ›å»ºæ–°çš„æ ·å¼å…ƒç´ ç”¨äºå­˜æ”¾åŠ¨æ€ç”Ÿæˆçš„ @keyframes
  const styleEl = document.createElement('style')
  styleEl.id = 'favorite-scroll-animations'
  let animations = ''
  
  // éå†æ‰€æœ‰å·²æ³¨å†Œçš„æ¨¡å‹åç§°å…ƒç´ 
  for (const [modelId, el] of Object.entries(nameRefs.value)) {
    if (!el) continue
    
    try {
      // ==================== æ­¥éª¤1ï¼šæµ‹é‡å®¹å™¨å’Œæ–‡æœ¬å®½åº¦ ====================
      
      // è·å– .model-name-container å®¹å™¨ï¼ˆæ–‡æœ¬çš„ç›´æ¥çˆ¶å®¹å™¨ï¼‰
      // è¿™æ˜¯æ–‡æœ¬æ»šåŠ¨çš„"è§‚å¯Ÿçª—å£"ï¼Œåº”è¯¥æµ‹é‡è¿™ä¸ªå®¹å™¨çš„å®½åº¦
      // å¸ƒå±€ç»“æ„ï¼š.model-info > .model-name-container > .model-name-belt/.model-name-static
      const container = el.closest('.model-name-container')
      if (!container) continue
      
      // è®¡ç®—æ–‡æœ¬å¯ç”¨å®½åº¦
      // .model-name-container çš„ offsetWidth å°±æ˜¯æ–‡æœ¬æ»šåŠ¨åŒºåŸŸçš„å®é™…å®½åº¦
      // è¿™ä¸ªå®½åº¦å·²ç»åŒ…å«äº†æ‰€æœ‰éœ€è¦è€ƒè™‘çš„å› ç´ ï¼ˆpaddingã€border ç­‰ï¼‰
      const W = container.offsetWidth  // W = Window width (çª—å£/å®¹å™¨å¯ç”¨å®½åº¦)
      
      // è¾¹ç•Œæ£€æŸ¥ï¼šå¯ç”¨å®½åº¦å¿…é¡»è¶³å¤Ÿå¤§æ‰æœ‰æ„ä¹‰
      // å°äº 30px çš„ç©ºé—´æ— æ³•æœ‰æ•ˆæ˜¾ç¤ºæ–‡æœ¬ï¼Œè·³è¿‡è¯¥å…ƒç´ 
      if (W < 30) continue
      
      // è·å–å®é™…æ–‡æœ¬å…ƒç´ ï¼ˆ.belt-textï¼‰
      // è¿™æ˜¯ç¬¬ä¸€ä»½æ–‡æœ¬ï¼Œç”¨äºæµ‹é‡å®é™…æ¸²æŸ“å®½åº¦
      const textSpan = el.querySelector('.belt-text')
      if (!textSpan) continue
      
      // æµ‹é‡æ–‡æœ¬çš„å®é™…æ¸²æŸ“å®½åº¦
      const C = textSpan.offsetWidth  // C = Content width (æ–‡å­—åŒºé•¿åº¦)
      
      // è¾¹ç•Œæ£€æŸ¥ï¼šæ–‡å­—å®½åº¦å¿…é¡»åœ¨åˆç†èŒƒå›´å†…
      // C <= 0ï¼šå…ƒç´ å¯èƒ½æœªæ¸²æŸ“æˆ–éšè—
      // C > 2000ï¼šå¼‚å¸¸æƒ…å†µï¼Œå¯èƒ½æ˜¯ CSS é—®é¢˜
      if (C <= 0 || C > 2000) continue
      
      // ==================== æ­¥éª¤2ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨ ====================
      
      // åªæœ‰å½“æ–‡æœ¬å®½åº¦æ˜æ˜¾è¶…å‡ºå®¹å™¨æ—¶æ‰å¯ç”¨æ»šåŠ¨
      // ç•™ 5px å®¹å·®ï¼Œé¿å…è¾¹ç•Œæƒ…å†µä¸‹çš„è¯¯åˆ¤å’Œé¢‘ç¹åˆ‡æ¢
      if (C > W + 5) {
        
        // ==================== æ­¥éª¤3ï¼šè®¡ç®—ç¯å¸¦å‡ ä½•å‚æ•° ====================
        
        // G = Gap width (ç©ºç™½åŒºé•¿åº¦)
        // ç©ºç™½åŒºç”¨äºåˆ†éš”ç¯å¸¦ä¸­çš„ä¸¤ä»½æ–‡æœ¬ï¼Œé¿å…å®ƒä»¬è¿åœ¨ä¸€èµ·
        // è®¾è®¡åŸåˆ™ï¼š
        //   - è‡³å°‘ 40pxï¼Œç¡®ä¿æœ‰æ˜æ˜¾çš„è§†è§‰åˆ†éš”
        //   - æˆ–å–æ–‡å­—åŒºé•¿åº¦çš„ä¸€åŠï¼Œè®©é—´éš”æ›´è‡ªç„¶
        const G = Math.max(40, 0.5 * C)
        
        // L = Loop length (æ€»ç¯é•¿)
        // ç¯å¸¦æ€»é•¿åº¦ = æ–‡å­—åŒºé•¿åº¦ + ç©ºç™½åŒºé•¿åº¦
        const L = C + G
        
        // ==================== æ­¥éª¤4ï¼šè®¡ç®—æ—¶é—´å‚æ•° ====================
        
        // é˜…è¯»é€Ÿåº¦ï¼ˆè®¾è®¡å¸¸é‡ï¼‰
        // v1 = åŒ€é€Ÿé˜…è¯»é€Ÿåº¦ï¼ˆpx/sï¼‰
        // æ¨èèŒƒå›´ï¼š30-72 px/s
        // 50 px/s æ˜¯ä¸€ä¸ªå¹³è¡¡å€¼ï¼Œæ—¢ä¸å¤ªå¿«ä¹Ÿä¸å¤ªæ…¢
        const v1 = 50
        
        // ç¬¬1é˜¶æ®µï¼šåœé¡¿æ—¶é—´ï¼ˆè®¾è®¡å¸¸é‡ï¼‰
        // tau0 = åˆå§‹åœé¡¿æ—¶é•¿ï¼ˆmsï¼‰
        // è®©ç”¨æˆ·æœ‰æ—¶é—´çœ‹æ¸…æ–‡æœ¬å¼€å¤´
        // æ¨èèŒƒå›´ï¼š300-600ms
        const tau0 = 500
        
        // ç¬¬2é˜¶æ®µï¼šé˜…è¯»æ—¶é—´
        // t_read = åŒ€é€Ÿé˜…è¯»é˜¶æ®µçš„æ—¶é•¿ï¼ˆmsï¼‰
        // æ—¶é•¿ = æ–‡å­—åŒºé•¿åº¦ / é˜…è¯»é€Ÿåº¦
        // ä¹˜ä»¥ 1000 è½¬æ¢ä¸ºæ¯«ç§’
        const t_read = C / v1 * 1000
        
        // ç¬¬3é˜¶æ®µï¼šç©ºç™½åŒºå‹ç¼©æ—¶é—´
        // tau_gap = ç©ºç™½åŒºå‹ç¼©é˜¶æ®µçš„æ—¶é•¿ï¼ˆmsï¼‰
        // å‹ç¼©ç³»æ•° 0.25 æ„å‘³ç€ 4 å€é€Ÿåº¦å¿«é€Ÿè·³è¿‡ç©ºç™½åŒº
        // è¿™æ ·å¯ä»¥å‡å°‘ç­‰å¾…æ—¶é—´ï¼ŒåŒæ—¶ä¿æŒæ–‡å­—åŒºçš„å¯è¯»æ€§
        const tau_gap = 0.25 * t_read
        
        // æ€»å‘¨æœŸ = åœé¡¿ + é˜…è¯» + å‹ç¼©
        // T = å®Œæ•´åŠ¨ç”»å¾ªç¯çš„æ€»æ—¶é•¿ï¼ˆmsï¼‰
        const T = tau0 + t_read + tau_gap
        
        // ==================== æ­¥éª¤5ï¼šè®¡ç®—å…³é”®å¸§ç™¾åˆ†æ¯” ====================
        
        // è®¡ç®—å„é˜¶æ®µåœ¨åŠ¨ç”»æ—¶é—´è½´ä¸Šçš„ç™¾åˆ†æ¯”ä½ç½®
        // è¿™äº›ç™¾åˆ†æ¯”å°†ç”¨äº CSS @keyframes è§„åˆ™
        
        // p_delayï¼šåœé¡¿é˜¶æ®µç»“æŸçš„æ—¶é—´ç‚¹ï¼ˆç™¾åˆ†æ¯”ï¼‰
        // ä» 0% åˆ° p_delay% æœŸé—´ï¼Œä½ç½®ä¿æŒåœ¨ 0
        const p_delay = (tau0 / T) * 100
        
        // p_readï¼šé˜…è¯»é˜¶æ®µç»“æŸçš„æ—¶é—´ç‚¹ï¼ˆç™¾åˆ†æ¯”ï¼‰
        // ä» p_delay% åˆ° p_read% æœŸé—´ï¼Œä½ç½®ä» 0 ç§»åŠ¨åˆ° -C
        const p_read = ((tau0 + t_read) / T) * 100
        
        // ä» p_read% åˆ° 100% æœŸé—´ï¼Œä½ç½®ä» -C ç§»åŠ¨åˆ° -(C+G)
        // åˆ°è¾¾ 100% åç¬é—´è·³å› 0%ï¼Œå¼€å§‹æ–°ä¸€è½®å¾ªç¯
        
        // ==================== æ­¥éª¤6ï¼šç”ŸæˆåŠ¨ç”»åç§° ====================
        
        // ä¸ºæ¯ä¸ªæ¨¡å‹ç”Ÿæˆå”¯ä¸€çš„åŠ¨ç”»åç§°
        // å°†ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œç¡®ä¿ CSS æ ‡è¯†ç¬¦çš„åˆæ³•æ€§
        // ä¾‹å¦‚ï¼šgoogle/gemini-1.5-pro -> scroll-google_gemini_1_5_pro
        const animName = `scroll-${modelId.replace(/[^a-zA-Z0-9]/g, '_')}`
        
        // ==================== æ­¥éª¤7ï¼šç”Ÿæˆ CSS @keyframes è§„åˆ™ ====================
        
        // ç”Ÿæˆå››é˜¶æ®µæ»šåŠ¨åŠ¨ç”»çš„å…³é”®å¸§
        // 
        // åŠ¨ç”»é˜¶æ®µè¯¦è§£ï¼š
        // 
        // 0%: åˆå§‹ä½ç½®
        //   - transform: translateX(0)
        //   - æ–‡æœ¬åœ¨å®¹å™¨æœ€å·¦ä¾§ï¼Œç¬¬ä¸€ä»½æ–‡æœ¬çš„å¼€å¤´å¯è§
        // 
        // p_delay%: åœé¡¿ç»“æŸ
        //   - transform: translateX(0)
        //   - ä½ç½®ä¸å˜ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´çœ‹æ¸…å¼€å¤´
        // 
        // p_read%: é˜…è¯»å®Œæˆ
        //   - transform: translateX(-C px)
        //   - æ–‡æœ¬å·²æ»šåŠ¨ä¸€ä¸ªæ–‡å­—åŒºçš„è·ç¦»
        //   - ç¬¬ä¸€ä»½æ–‡æœ¬å®Œå…¨ç¦»å¼€è§†é‡ï¼Œç¬¬äºŒä»½æ–‡æœ¬æ­£å¥½è¿›å…¥
        // 
        // 100%: å¾ªç¯ç‚¹
        //   - transform: translateX(-(C+G) px)
        //   - æ•´ä¸ªç¯å¸¦æ»šåŠ¨å®Œæ¯•
        //   - å³å°†è·³å› 0% å¼€å§‹æ–°å¾ªç¯
        // 
        // ç”±äº 0% å’Œ 100% å¤„çš„è§†è§‰å†…å®¹ç›¸åŒï¼ˆéƒ½æ˜¯æ–‡æœ¬å¼€å¤´ï¼‰ï¼Œ
        // è·³è·ƒæ˜¯è§†è§‰ä¸Šæ— ç¼çš„
        animations += `
@keyframes ${animName} {
  0% { transform: translateX(0); }
  ${p_delay.toFixed(2)}% { transform: translateX(0); }
  ${p_read.toFixed(2)}% { transform: translateX(${-C}px); }
  100% { transform: translateX(${-(C + G)}px); }
}
`
        
        // ==================== æ­¥éª¤8ï¼šä¿å­˜åŠ¨ç”»é…ç½® ====================
        
        // å°†è¿™ä¸ªæ¨¡å‹çš„åŠ¨ç”»å‚æ•°å­˜å‚¨åˆ°ç»“æœå¯¹è±¡ä¸­
        // è¿™äº›å‚æ•°ä¼šåœ¨æ¨¡æ¿ä¸­è¢«ä½¿ç”¨ï¼Œåº”ç”¨åˆ°å¯¹åº”çš„å…ƒç´ ä¸Š
        newScrollingModels[modelId] = {
          C,        // æ–‡å­—åŒºé•¿åº¦ï¼ˆpxï¼‰
          W,        // çª—å£å¯ç”¨å®½åº¦ï¼ˆpxï¼‰
          G,        // ç©ºç™½åŒºé•¿åº¦ï¼ˆpxï¼‰
          L,        // æ€»ç¯é•¿ï¼ˆpxï¼‰
          T,        // åŠ¨ç”»æ€»å‘¨æœŸï¼ˆmsï¼‰
          animName  // CSS åŠ¨ç”»åç§°
        }
      }
    } catch (error) {
      // å•ä¸ªæ¨¡å‹çš„æµ‹é‡å¤±è´¥ä¸åº”å½±å“å…¶ä»–æ¨¡å‹çš„å¤„ç†
      // æ•è·å¼‚å¸¸ï¼Œè®°å½•è­¦å‘Šä¿¡æ¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ¨¡å‹
      // å¯èƒ½çš„å¤±è´¥åŸå› ï¼š
      //   - DOM å…ƒç´ å°šæœªå®Œå…¨æ¸²æŸ“
      //   - CSS æ ·å¼å¼‚å¸¸å¯¼è‡´å®½åº¦ä¸º 0 æˆ– NaN
      //   - å…ƒç´ åœ¨ DOM æ ‘ä¸­çš„ä½ç½®å¼‚å¸¸
      console.warn(`Failed to measure model ${modelId}:`, error)
    }
  }
  
  // ==================== æ­¥éª¤9ï¼šåº”ç”¨ç”Ÿæˆçš„åŠ¨ç”»æ ·å¼ ====================
  
  // å°†æ‰€æœ‰ç”Ÿæˆçš„ @keyframes è§„åˆ™æ·»åŠ åˆ°é¡µé¢çš„ <head> ä¸­
  // åªæœ‰åœ¨ç¡®å®ç”Ÿæˆäº†åŠ¨ç”»è§„åˆ™çš„æƒ…å†µä¸‹æ‰æ·»åŠ  <style> å…ƒç´ 
  if (animations) {
    styleEl.textContent = animations
    document.head.appendChild(styleEl)
  }
  
  // æ›´æ–°å“åº”å¼çŠ¶æ€ï¼Œè§¦å‘ Vue æ¨¡æ¿é‡æ–°æ¸²æŸ“
  // æ¨¡æ¿ä¼šæ ¹æ® scrollingModels çš„å†…å®¹å†³å®šï¼š
  //   - å“ªäº›æ¨¡å‹æ˜¾ç¤ºæ»šåŠ¨åŠ¨ç”»ï¼ˆscrollingModels[model.id] å­˜åœ¨ï¼‰
  //   - å“ªäº›æ¨¡å‹æ˜¾ç¤ºé™æ€æ–‡æœ¬ï¼ˆscrollingModels[model.id] ä¸å­˜åœ¨ï¼‰
  //   - åº”ç”¨ä»€ä¹ˆåŠ¨ç”»å‚æ•°ï¼ˆanimName, T ç­‰ï¼‰
  scrollingModels.value = newScrollingModels
  
}

/**
 * è·å–å½“å‰ä¼šè¯ä½¿ç”¨çš„æ¨¡å‹
 * 
 * ä¼˜å…ˆè¿”å›å½“å‰æ´»åŠ¨ä¼šè¯çš„æ¨¡å‹
 * å¦‚æœæ²¡æœ‰æ´»åŠ¨ä¼šè¯ï¼Œè¿”å›å…¨å±€é€‰ä¸­çš„æ¨¡å‹
 * 
 * @returns {string} å½“å‰æ¨¡å‹çš„ ID
 */
const currentModel = computed(() => {
  const activeConv = chatStore.activeConversation
  return activeConv?.model || chatStore.selectedModel
})

/**
 * æ£€æŸ¥æŒ‡å®šæ¨¡å‹æ˜¯å¦ä¸ºå½“å‰ä½¿ç”¨çš„æ¨¡å‹
 * 
 * ç”¨äºåœ¨ UI ä¸­é«˜äº®æ˜¾ç¤ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„æ¨¡å‹
 * 
 * @param {string} modelId - è¦æ£€æŸ¥çš„æ¨¡å‹ ID
 * @returns {boolean} å¦‚æœæ˜¯å½“å‰æ¨¡å‹è¿”å› trueï¼Œå¦åˆ™è¿”å› false
 */
const isCurrentModel = (modelId) => {
  return modelId === currentModel.value
}

/**
 * æ ¼å¼åŒ–æ¨¡å‹åç§°ï¼Œç§»é™¤æä¾›å•†å‰ç¼€
 * 
 * è®¸å¤šæ¨¡å‹ ID åŒ…å«æä¾›å•†å‰ç¼€ï¼Œä¾‹å¦‚ï¼š
 *   - "google/gemini-1.5-pro" -> "gemini-1.5-pro"
 *   - "anthropic/claude-3-opus" -> "claude-3-opus"
 *   - "openai/gpt-4" -> "gpt-4"
 * 
 * ç§»é™¤å†’å·æˆ–æ–œæ ä¹‹å‰çš„éƒ¨åˆ†ï¼Œè®©æ˜¾ç¤ºæ›´ç®€æ´
 * 
 * @param {string} name - åŸå§‹æ¨¡å‹åç§°
 * @returns {string} æ ¼å¼åŒ–åçš„æ¨¡å‹åç§°
 */
const formatModelName = (name) => {
  // ç§»é™¤è‹±æ–‡å†’å·(:)æˆ–ä¸­æ–‡å†’å·(ï¼š)åŠä¹‹å‰çš„æ‰€æœ‰æ–‡å­—
  // è¿™æ ·å¯ä»¥ç§»é™¤æä¾›å•†å‰ç¼€ï¼Œè®©æ˜¾ç¤ºæ›´ç®€æ´
  // 
  // ç¤ºä¾‹ï¼š
  //   "OpenAI: GPT-4" -> "GPT-4"
  //   "Amazon: Nova Lite" -> "Nova Lite"
  //   "Googleï¼šGemini Pro" -> "Gemini Pro"
  //   "Deepseek Chat" -> "Deepseek Chat" (æ— å†’å·ï¼Œä¿æŒä¸å˜)
  // 
  // æ­£åˆ™è¡¨è¾¾å¼è§£é‡Šï¼š
  //   ^         : ä»å­—ç¬¦ä¸²å¼€å¤´åŒ¹é…
  //   [^:ï¼š]+   : åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªéå†’å·å­—ç¬¦ï¼ˆè‹±æ–‡æˆ–ä¸­æ–‡å†’å·ï¼‰
  //   [:ï¼š]     : åŒ¹é…ä¸€ä¸ªå†’å·ï¼ˆè‹±æ–‡æˆ–ä¸­æ–‡ï¼‰
  //   \s*       : åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªç©ºç™½å­—ç¬¦
  return name.replace(/^[^:ï¼š]+[:ï¼š]\s*/, '')
}

/**
 * æ ¼å¼åŒ–ä¸Šä¸‹æ–‡é•¿åº¦ä¸ºæ˜“è¯»æ ¼å¼
 * 
 * å°†å¤§æ•°å­—è½¬æ¢ä¸º Kï¼ˆåƒï¼‰æˆ– Mï¼ˆç™¾ä¸‡ï¼‰å•ä½
 * 
 * @param {number} length - ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆtoken æ•°é‡ï¼‰
 * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
 * 
 * @example
 * formatContextLength(128000)  // "128K"
 * formatContextLength(2000000) // "2M"
 * formatContextLength(800)     // "800"
 */
const formatContextLength = (length) => {
  if (!length) return ''
  
  // ç™¾ä¸‡çº§åˆ«ï¼š>= 1,000,000
  if (length >= 1000000) {
    return `${Math.floor(length / 1000000)}M`
  }
  
  // åƒçº§åˆ«ï¼š>= 1,000
  if (length >= 1000) {
    return `${Math.floor(length / 1000)}K`
  }
  
  // å°äº 1000ï¼Œç›´æ¥æ˜¾ç¤ºæ•°å­—
  return length.toString()
}

/**
 * æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€è¾“å…¥
 * 
 * å¤šæ¨¡æ€æ¨¡å‹å¯ä»¥æ¥å—å¤šç§ç±»å‹çš„è¾“å…¥ï¼Œå¦‚ï¼š
 *   - æ–‡æœ¬ + å›¾ç‰‡
 *   - æ–‡æœ¬ + éŸ³é¢‘
 *   - æ–‡æœ¬ + è§†é¢‘
 * 
 * @param {Object} model - æ¨¡å‹å¯¹è±¡
 * @param {Array} model.input_modalities - è¾“å…¥æ¨¡æ€åˆ—è¡¨
 * @returns {boolean} å¦‚æœæ”¯æŒå¤šæ¨¡æ€è¿”å› trueï¼Œå¦åˆ™è¿”å› false
 */
const hasMultimodal = (model) => {
  return model.input_modalities && model.input_modalities.length > 1
}

/**
 * é€‰æ‹©æ¨¡å‹
 * 
 * å¦‚æœæœ‰æ´»åŠ¨ä¼šè¯ï¼Œæ›´æ–°è¯¥ä¼šè¯çš„æ¨¡å‹
 * å¦‚æœæ²¡æœ‰æ´»åŠ¨ä¼šè¯ï¼Œè®¾ç½®å…¨å±€é»˜è®¤æ¨¡å‹
 * 
 * @param {string} modelId - è¦é€‰æ‹©çš„æ¨¡å‹ ID
 */
const selectModel = (modelId) => {
  const activeConv = chatStore.activeConversation
  if (activeConv) {
    // æ›´æ–°æ´»åŠ¨ä¼šè¯çš„æ¨¡å‹
    chatStore.updateConversationModel(activeConv.id, modelId)
  } else {
    // è®¾ç½®å…¨å±€é»˜è®¤æ¨¡å‹
    chatStore.setSelectedModel(modelId)
  }
}

/**
 * ç»„ä»¶æŒ‚è½½åçš„åˆå§‹åŒ–é€»è¾‘
 * 
 * =====================
 * ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿæ£€æµ‹
 * =====================
 * 
 * é—®é¢˜ï¼š
 *   åœ¨ç»„ä»¶åˆšæŒ‚è½½æ—¶ï¼ŒDOM å…ƒç´ å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆæ¸²æŸ“å’Œå¸ƒå±€
 *   æ­¤æ—¶æµ‹é‡çš„ offsetWidth å¯èƒ½æ˜¯ 0 æˆ–ä¸å‡†ç¡®çš„å€¼
 * 
 * è§£å†³æ–¹æ¡ˆï¼š
 *   é‡‡ç”¨å¤šæ¬¡å»¶è¿Ÿæ£€æµ‹ç­–ç•¥ï¼Œåœ¨ä¸åŒæ—¶é—´ç‚¹è¿›è¡Œæµ‹é‡
 *   ç¡®ä¿åœ¨å„ç§è®¾å¤‡å’Œæ¸²æŸ“é€Ÿåº¦ä¸‹éƒ½èƒ½è·å¾—æ­£ç¡®çš„å°ºå¯¸
 * 
 * =====================
 * æ£€æµ‹æ—¶æœºè®¾è®¡
 * =====================
 * 
 * 300msï¼šå¿«é€Ÿé¦–æ£€
 *   - åœ¨å¤§å¤šæ•°ç°ä»£è®¾å¤‡ä¸Šï¼Œæ­¤æ—¶å¸ƒå±€å·²åŸºæœ¬å®Œæˆ
 *   - è®©ç”¨æˆ·èƒ½å¤Ÿå¿«é€Ÿçœ‹åˆ°æ»šåŠ¨æ•ˆæœ
 *   - é€‚ç”¨äºå¸¸è§„æ¸²æŸ“é€Ÿåº¦
 * 
 * 1000msï¼šå»¶è¿Ÿå¤æ£€
 *   - ç¡®ä¿åœ¨æ…¢é€Ÿè®¾å¤‡ã€å¤æ‚å¸ƒå±€ã€æˆ–èµ„æºåŠ è½½å»¶è¿Ÿçš„æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£ç¡®å·¥ä½œ
 *   - å¦‚æœæµ‹é‡ç»“æœä¸é¦–æ£€ä¸åŒï¼Œä¼šæ›´æ–°åŠ¨ç”»
 *   - æä¾›å…œåº•ä¿éšœ
 * 
 * resize äº‹ä»¶ï¼šå“åº”çª—å£å˜åŒ–
 *   - ç”¨æˆ·è°ƒæ•´çª—å£å¤§å°æ—¶ï¼Œå®¹å™¨å®½åº¦ä¼šæ”¹å˜
 *   - éœ€è¦é‡æ–°åˆ¤æ–­å“ªäº›æ–‡æœ¬éœ€è¦æ»šåŠ¨
 *   - é‡æ–°ç”ŸæˆåŠ¨ç”»å‚æ•°
 */
onMounted(() => {
  // é¦–æ¬¡å¿«é€Ÿæ£€æµ‹ï¼ˆ300msï¼‰
  setTimeout(() => {
    detectOverflow()
  }, 300)
  
  // äºŒæ¬¡å»¶è¿Ÿæ£€æµ‹ï¼ˆ1000msï¼‰
  setTimeout(() => {
    detectOverflow()
  }, 1000)
  
  // ç›‘å¬çª—å£å¤§å°å˜åŒ–äº‹ä»¶
  const handleResize = () => {
    detectOverflow()
  }
  window.addEventListener('resize', handleResize)
  
  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
  onUnmounted(() => {
    window.removeEventListener('resize', handleResize)
  })
})

/**
 * ç»„ä»¶å¸è½½æ—¶çš„æ¸…ç†é€»è¾‘
 * 
 * ç§»é™¤åŠ¨æ€åˆ›å»ºçš„ <style> å…ƒç´ ï¼Œé¿å…å†…å­˜æ³„æ¼
 * å¦‚æœä¸æ¸…ç†ï¼Œæ¯æ¬¡ç»„ä»¶é‡æ–°æŒ‚è½½éƒ½ä¼šåˆ›å»ºæ–°çš„æ ·å¼å…ƒç´ 
 * é•¿æ—¶é—´è¿è¡Œåä¼šå¯¼è‡´ DOM ä¸­ç§¯ç´¯å¤§é‡æ— ç”¨çš„æ ·å¼èŠ‚ç‚¹
 */
onUnmounted(() => {
  const styleEl = document.getElementById('favorite-scroll-animations')
  if (styleEl) {
    styleEl.remove()
  }
})

/**
 * ç›‘å¬æ”¶è—æ¨¡å‹åˆ—è¡¨çš„å˜åŒ–
 * 
 * =====================
 * è§¦å‘åœºæ™¯
 * =====================
 * 
 * 1. ç”¨æˆ·æ·»åŠ æ”¶è—æ¨¡å‹
 * 2. ç”¨æˆ·ç§»é™¤æ”¶è—æ¨¡å‹
 * 3. æ”¶è—æ¨¡å‹çš„é¡ºåºå‘ç”Ÿå˜åŒ–
 * 4. æ”¶è—æ¨¡å‹çš„å±æ€§è¢«ä¿®æ”¹ï¼ˆå› ä¸ºä½¿ç”¨äº† deep: trueï¼‰
 * 
 * =====================
 * å“åº”é€»è¾‘
 * =====================
 * 
 * é—®é¢˜ï¼š
 *   åˆ—è¡¨å˜åŒ–æ—¶ï¼ŒVue ä¼šé‡æ–°æ¸²æŸ“å…ƒç´ 
 *   æ—§çš„ DOM å¼•ç”¨ï¼ˆnameRefsï¼‰ä¼šå¤±æ•ˆ
 *   å¦‚æœä¸æ¸…ç†ï¼Œå¯èƒ½ä¼šä½¿ç”¨å·²é”€æ¯çš„ DOM å…ƒç´ 
 * 
 * è§£å†³ï¼š
 *   1. æ¸…ç©º nameRefs å’Œ scrollingModels
 *   2. ç­‰å¾… 300ms è®© Vue å®Œæˆé‡æ–°æ¸²æŸ“å’Œ ref æ³¨å†Œ
 *   3. é‡æ–°æ£€æµ‹æº¢å‡ºå’Œç”ŸæˆåŠ¨ç”»
 * 
 * =====================
 * ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿ
 * =====================
 * 
 * Vue çš„ watch å›è°ƒæ˜¯åŒæ­¥è§¦å‘çš„ï¼Œæ­¤æ—¶ï¼š
 *   - æ—§çš„ DOM å…ƒç´ å¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨å¸è½½
 *   - æ–°çš„ DOM å…ƒç´ å¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨æ¸²æŸ“
 *   - ref å›è°ƒå¯èƒ½è¿˜æ²¡æœ‰è¢«è°ƒç”¨
 * 
 * 300ms å»¶è¿Ÿç¡®ä¿ï¼š
 *   - Vue å®Œæˆè™šæ‹Ÿ DOM å¯¹æ¯”å’Œæ›´æ–°
 *   - æµè§ˆå™¨å®Œæˆå¸ƒå±€å’Œæ¸²æŸ“
 *   - ref å›è°ƒå·²ç»å¡«å……äº†æ–°çš„ DOM å¼•ç”¨
 */
watch(favoriteModels, () => {
  // æ¸…ç©ºæ—§çš„ DOM å¼•ç”¨å’Œæ»šåŠ¨çŠ¶æ€
  // é˜²æ­¢ä½¿ç”¨å·²å¤±æ•ˆçš„ DOM å¼•ç”¨
  nameRefs.value = {}
  scrollingModels.value = {}
  
  // å»¶è¿Ÿ 300ms è®© DOM å®Œå…¨æ›´æ–°å¹¶é‡æ–°æ³¨å†Œ refs åå†æµ‹é‡
  setTimeout(() => {
    detectOverflow()
  }, 300)
}, { deep: true })

/**
 * ç›‘å¬ä¼šè¯åˆ—è¡¨çš„å˜åŒ–
 * 
 * =====================
 * è§¦å‘åœºæ™¯
 * =====================
 * 
 * 1. åˆ›å»ºæ–°ä¼šè¯
 * 2. åˆ é™¤ä¼šè¯
 * 3. ä¼šè¯çš„å±æ€§è¢«ä¿®æ”¹ï¼ˆå› ä¸ºä½¿ç”¨äº† deep: trueï¼‰
 * 
 * =====================
 * ä¸ºä»€ä¹ˆéœ€è¦ç›‘å¬
 * =====================
 * 
 * å½“ä¼šè¯åˆ—è¡¨å˜åŒ–æ—¶ï¼Œå·¦ä¾§ä¼šè¯åˆ—è¡¨çš„å®½åº¦å¯èƒ½ä¼šæ”¹å˜
 * è¿™ä¼šé—´æ¥å½±å“å³ä¾§å†…å®¹åŒºåŸŸçš„å®½åº¦
 * ä»è€Œå½±å“ FavoriteModelSelector çš„å¯ç”¨å®½åº¦
 * éœ€è¦é‡æ–°è®¡ç®—å“ªäº›æ¨¡å‹åç§°éœ€è¦æ»šåŠ¨
 * 
 * ç‰¹åˆ«æ˜¯åˆ é™¤ä¼šè¯æ—¶ï¼Œå·²å‘ç°è¿‡æ»šåŠ¨å¤±æ•ˆçš„ bug
 * é€šè¿‡é‡æ–°æ£€æµ‹å¯ä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜
 */
watch(() => chatStore.conversations, () => {
  // å»¶è¿Ÿè®©å¸ƒå±€ç¨³å®šåå†æ£€æµ‹
  setTimeout(() => {
    detectOverflow()
  }, 300)
}, { deep: true })

/**
 * ç›‘å¬æ´»åŠ¨ä¼šè¯çš„å˜åŒ–
 * 
 * =====================
 * è§¦å‘åœºæ™¯
 * =====================
 * 
 * 1. åˆ‡æ¢åˆ°ä¸åŒçš„ä¼šè¯
 * 2. å½“å‰ä¼šè¯è¢«åˆ é™¤ï¼ˆactiveConversation å˜ä¸º nullï¼‰
 * 
 * =====================
 * ä¸ºä»€ä¹ˆéœ€è¦ç›‘å¬
 * =====================
 * 
 * åˆ‡æ¢ä¼šè¯æ—¶ï¼ŒUI ä¸Šçš„é«˜äº®çŠ¶æ€ï¼ˆactive ç±»ï¼‰ä¼šæ”¹å˜
 * æŸäº› CSS æ ·å¼å¯èƒ½å› ä¸º :hover, .active ç­‰ä¼ªç±»è€Œæ”¹å˜
 * å¯¼è‡´å…ƒç´ å°ºå¯¸å‘ç”Ÿå¾®å°å˜åŒ–
 * 
 * è™½ç„¶è¿™ç§å˜åŒ–é€šå¸¸å¾ˆå°ï¼Œä½†ä¸ºäº†ç¡®ä¿æ»šåŠ¨åŠ¨ç”»å§‹ç»ˆæ­£ç¡®
 * åœ¨ä¼šè¯åˆ‡æ¢æ—¶é‡æ–°æ£€æµ‹ä¸€æ¬¡æ˜¯æœ€ä¿é™©çš„åšæ³•
 * 
 * =====================
 * ğŸ”§ ä¿®å¤ï¼šé¿å…åœ¨éšè—çš„ ChatView å®ä¾‹ä¸­æ‰§è¡Œæ£€æµ‹
 * =====================
 * 
 * é—®é¢˜ï¼š
 *   - å¤šä¸ª ChatView å®ä¾‹åŒæ—¶å­˜åœ¨ï¼ˆé€šè¿‡ display: none/flex æ§åˆ¶ï¼‰
 *   - æ¯ä¸ªå®ä¾‹éƒ½æœ‰ç‹¬ç«‹çš„ FavoriteModelSelector
 *   - åˆ‡æ¢æ ‡ç­¾é¡µæ—¶ï¼Œæ‰€æœ‰å®ä¾‹çš„ watch éƒ½ä¼šè§¦å‘
 *   - ä½†éšè—å®ä¾‹ï¼ˆdisplay: noneï¼‰çš„ DOM å…ƒç´  offsetWidth è¿”å› 0
 *   - å¯¼è‡´æ»šåŠ¨åŠ¨ç”»è¢«é”™è¯¯åœ°æ¸…ç©º
 * 
 * è§£å†³æ–¹æ¡ˆï¼š
 *   - åªåœ¨å½“å‰æ¿€æ´»çš„ä¼šè¯å¯¹åº”çš„ FavoriteModelSelector ä¸­æ‰§è¡Œæ£€æµ‹
 *   - é€šè¿‡æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§æ¥åˆ¤æ–­ï¼ˆoffsetParent !== nullï¼‰
 */
watch(() => chatStore.activeConversation?.id, () => {
  // å»¶è¿Ÿè®©å¸ƒå±€ç¨³å®šåå†æ£€æµ‹
  setTimeout(() => {
    // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦å¯è§
    // å¦‚æœçˆ¶å…ƒç´ è¢« display:none éšè—ï¼ŒoffsetParent ä¼šæ˜¯ null
    const firstRef = Object.values(nameRefs.value)[0]
    if (!firstRef || firstRef.offsetParent === null) {
      // ç»„ä»¶å½“å‰ä¸å¯è§ï¼Œè·³è¿‡æ£€æµ‹
      return
    }
    
    detectOverflow()
  }, 300)
})
</script>

<style scoped>
/* 
 * ==================== é¡¶å±‚å®¹å™¨æ ·å¼ ====================
 */

.favorite-model-selector {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* 
 * ==================== æ”¶è—åˆ—è¡¨å®¹å™¨ ====================
 * 
 * æ¨ªå‘æ»šåŠ¨å®¹å™¨ï¼Œå®¹çº³æ‰€æœ‰æ”¶è—æ¨¡å‹æŒ‰é’®
 */
.favorites-list {
  display: flex;
  align-items: center;
  gap: 0.5rem;          /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
  flex: 1;              /* å æ®çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ */
  overflow-x: auto;     /* å½“å†…å®¹è¶…å‡ºæ—¶å…è®¸æ°´å¹³æ»šåŠ¨ */
  overflow-y: hidden;   /* ç¦æ­¢å‚ç›´æ»šåŠ¨ */
  max-width: 100%;      /* ç¡®ä¿ä¸è¶…å‡ºçˆ¶å®¹å™¨ */
  
  /* å¹³æ»‘æ»šåŠ¨æ•ˆæœ */
  scroll-behavior: smooth;                /* ç°ä»£æµè§ˆå™¨æ”¯æŒçš„å¹³æ»‘æ»šåŠ¨ */
  -webkit-overflow-scrolling: touch;      /* iOS Safari çš„è§¦æ‘¸æ»šåŠ¨ä¼˜åŒ– */
}

/* 
 * ==================== æ»šåŠ¨æ¡æ ·å¼ï¼ˆWebKit æµè§ˆå™¨ï¼‰====================
 * é€‚ç”¨äºï¼šChrome, Safari, Edge
 */
.favorites-list::-webkit-scrollbar {
  height: 4px;                            /* æ»šåŠ¨æ¡é«˜åº¦ */
}

.favorites-list::-webkit-scrollbar-track {
  background: transparent;                /* æ»šåŠ¨æ¡è½¨é“é€æ˜ */
}

.favorites-list::-webkit-scrollbar-thumb {
  background: #d1d5db;                    /* æ»šåŠ¨æ¡æ»‘å—é¢œè‰² */
  border-radius: 2px;                     /* åœ†è§’ */
}

.favorites-list::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;                    /* æ‚¬åœæ—¶åŠ æ·±é¢œè‰² */
}

/* 
 * ==================== æ»šåŠ¨æ¡æ ·å¼ï¼ˆFirefoxï¼‰====================
 */
.favorites-list {
  scrollbar-width: thin;                  /* ç»†æ»šåŠ¨æ¡ */
  scrollbar-color: #d1d5db transparent;   /* æ»‘å—é¢œè‰² è½¨é“é¢œè‰² */
}

/* 
 * ==================== æ”¶è—æ¨¡å‹æŒ‰é’® ====================
 * 
 * æ¯ä¸ªæ”¶è—æ¨¡å‹çš„æŒ‰é’®å®¹å™¨
 * å¸ƒå±€ï¼š.model-infoï¼ˆå·¦ä¾§ï¼Œflex: 1ï¼‰+ .model-metaï¼ˆå³ä¾§ï¼Œå›ºå®šå®½åº¦ï¼‰
 */
.favorite-model-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0.75rem;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 140px;                       /* æœ€å°å®½åº¦ï¼Œé¿å…æŒ‰é’®è¿‡å° */
  max-width: 180px;                       /* æœ€å¤§å®½åº¦ï¼Œä¿æŒæŒ‰é’®ç´§å‡‘ */
  flex-shrink: 0;                         /* ä¸å…è®¸æ”¶ç¼©ï¼Œä¿æŒå›ºå®šå°ºå¯¸ */
}

/* æ‚¬åœæ•ˆæœ */
.favorite-model-btn:hover {
  border-color: #667eea;                  /* è¾¹æ¡†å˜ä¸ºç´«è‰² */
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);  /* é˜´å½± */
  transform: translateY(-1px);            /* è½»å¾®ä¸Šæµ® */
}

/* å½“å‰é€‰ä¸­çš„æ¨¡å‹ */
.favorite-model-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  /* æ¸å˜èƒŒæ™¯ */
  color: white;
  border-color: transparent;
}

/* 
 * ==================== æ¨¡å‹ä¿¡æ¯å®¹å™¨ ====================
 * 
 * åŒ…å«æ¨¡å‹åç§°å’Œç³»åˆ—ä¿¡æ¯
 * 
 * å¸ƒå±€å…³é”®ç‚¹ï¼š
 *   - flex: 1 è®©å®ƒå æ®æŒ‰é’®å†…é™¤ .model-meta å¤–çš„æ‰€æœ‰å‰©ä½™ç©ºé—´
 *   - min-width: 0 æ˜¯ CSS Flexbox çš„é‡è¦æŠ€å·§
 *     æ²¡æœ‰å®ƒï¼Œflex å­å…ƒç´ ä¼šåŸºäºå†…å®¹çš„æœ€å°å®½åº¦ï¼Œæ— æ³•çœŸæ­£æ”¶ç¼©
 *     æœ‰äº†å®ƒï¼Œæ‰èƒ½è®©æ–‡æœ¬æ­£ç¡®æº¢å‡ºå’Œæ»šåŠ¨
 */
.model-info {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.125rem;
  flex: 1;                                /* å æ®å‰©ä½™ç©ºé—´ */
  min-width: 0;                           /* å…è®¸æ”¶ç¼©åˆ°å°äºå†…å®¹å®½åº¦ï¼Œå…³é”®ï¼ */
  overflow: hidden;                       /* éšè—æº¢å‡ºå†…å®¹ */
}

/* 
 * ==================== æ¨¡å‹åç§°å®¹å™¨ï¼ˆæ»šåŠ¨çª—å£ï¼‰====================
 * 
 * è¿™æ˜¯æ»šåŠ¨åŠ¨ç”»çš„"è§‚å¯Ÿçª—å£"
 * ç¯å¸¦åœ¨è¿™ä¸ªçª—å£å†…æ»šåŠ¨ï¼Œçª—å£å¤–çš„éƒ¨åˆ†è¢«éšè—
 * 
 * å·¥ä½œåŸç†ï¼š
 *   - width: 100% è®©çª—å£å æ»¡ .model-info çš„å®½åº¦
 *   - overflow: hidden éšè—çª—å£å¤–çš„å†…å®¹ï¼ˆå…³é”®ï¼ï¼‰
 *   - ç¯å¸¦é€šè¿‡ CSS transform: translateX() åœ¨çª—å£å†…æ»šåŠ¨
 */
.model-name-container {
  width: 100%;
  overflow: hidden;                       /* å…³é”®ï¼šåªæ˜¾ç¤ºçª—å£å†…çš„å†…å®¹ */
  position: relative;
}

/* 
 * ==================== é™æ€æ¨¡å‹åç§° ====================
 * 
 * å½“æ–‡æœ¬ä¸éœ€è¦æ»šåŠ¨æ—¶ï¼ˆæ–‡æœ¬å®½åº¦ <= å®¹å™¨å®½åº¦ï¼‰æ˜¾ç¤º
 * ä½¿ç”¨ä¼ ç»Ÿçš„ CSS text-overflow çœç•¥å·æˆªæ–­
 */
.model-name-static {
  font-size: 0.875rem;
  font-weight: 600;
  white-space: nowrap;                    /* å¼ºåˆ¶å•è¡Œæ˜¾ç¤º */
  overflow: hidden;                       /* éšè—æº¢å‡ºéƒ¨åˆ† */
  text-overflow: ellipsis;                /* ç”¨çœç•¥å·è¡¨ç¤ºè¢«æˆªæ–­çš„æ–‡æœ¬ */
}

/* 
 * ==================== ç¯å¸¦å…ƒç´  ====================
 * 
 * å½“æ–‡æœ¬éœ€è¦æ»šåŠ¨æ—¶æ˜¾ç¤ºï¼ŒåŒ…å«å®Œæ•´çš„ç¯å¸¦ç»“æ„ï¼š
 * [æ–‡æœ¬A] + [ç©ºç™½G] + [æ–‡æœ¬Aå‰¯æœ¬]
 * 
 * æŠ€æœ¯è¦ç‚¹ï¼š
 *   - display: inline-flex è®©å­å…ƒç´ ï¼ˆ.belt-text å’Œ .belt-gapï¼‰æ°´å¹³æ’åˆ—
 *   - white-space: nowrap é˜²æ­¢æ–‡æœ¬æ¢è¡Œ
 *   - CSS åŠ¨ç”»å‚æ•°é€šè¿‡ Vue çš„ :style åŠ¨æ€è®¾ç½®ï¼ˆè§æ¨¡æ¿ï¼‰
 * 
 * åŠ¨ç”»å‚æ•°ï¼ˆç”± JavaScript åŠ¨æ€è®¾ç½®ï¼‰ï¼š
 *   - animation-name: scroll-${modelId}ï¼ˆåŠ¨æ€ç”Ÿæˆçš„ @keyframesï¼‰
 *   - animation-duration: ${T}msï¼ˆåŸºäºæ–‡æœ¬é•¿åº¦è®¡ç®—ï¼‰
 *   - animation-timing-function: linear
 *   - animation-iteration-count: infinite
 */
.model-name-belt {
  display: inline-flex;                   /* æ°´å¹³æ’åˆ—å­å…ƒç´  */
  white-space: nowrap;                    /* é˜²æ­¢æ–‡æœ¬æ¢è¡Œ */
  font-size: 0.875rem;
  font-weight: 600;
}

/* 
 * æ»šåŠ¨çŠ¶æ€ä¸‹çš„ç¯å¸¦
 * 
 * å½“ .model-name-container æœ‰ .scrolling ç±»æ—¶ï¼š
 *   - width: max-content è®©ç¯å¸¦å¯ä»¥å»¶ä¼¸åˆ°å†…å®¹çš„å®Œæ•´å®½åº¦
 *   - ä¸å—çˆ¶å®¹å™¨å®½åº¦é™åˆ¶ï¼Œå…è®¸å®Œæ•´çš„ç¯å¸¦ç»“æ„ï¼ˆC + G + Cï¼‰æ˜¾ç¤º
 *   - å¦‚æœæ²¡æœ‰è¿™ä¸ªè®¾ç½®ï¼Œç¯å¸¦ä¼šè¢«å‹ç¼©åˆ°å®¹å™¨å®½åº¦
 */
.model-name-container.scrolling .model-name-belt {
  width: max-content;
}

/* 
 * ==================== ç¯å¸¦çš„æ–‡æœ¬éƒ¨åˆ† ====================
 * 
 * ç¯å¸¦ä¸­çš„å®é™…æ–‡æœ¬ï¼Œä¼šå‡ºç°ä¸¤æ¬¡ï¼ˆç¬¬ä¸€ä»½å’Œå‰¯æœ¬ï¼‰
 * display: inline-block è®©å®ƒä»¬å¯ä»¥è¢«æ­£ç¡®æµ‹é‡å®½åº¦ï¼ˆoffsetWidthï¼‰
 */
.belt-text {
  display: inline-block;
}

/* 
 * ==================== ç¯å¸¦çš„ç©ºç™½åŒº ====================
 * 
 * ç”¨äºåˆ†éš”ç¯å¸¦ä¸­çš„ä¸¤ä»½æ–‡æœ¬
 * å®½åº¦é€šè¿‡ :style åŠ¨æ€è®¾ç½®ä¸º ${G}px
 * 
 * ä½œç”¨ï¼š
 *   - è®©ä¸¤ä»½æ–‡æœ¬ä¹‹é—´æœ‰è¶³å¤Ÿçš„é—´è·
 *   - ä½¿å¾ªç¯è·³è·ƒç‚¹ä¸é‚£ä¹ˆçªå…€
 *   - æä¾›è§†è§‰ç¼“å†²ï¼Œè®©æ»šåŠ¨æ›´è‡ªç„¶
 *   - å¿«é€Ÿæ»šè¿‡è¿™ä¸ªç©ºç™½åŒºï¼ˆ4å€é€Ÿï¼‰å¯ä»¥èŠ‚çœæ—¶é—´
 */
.belt-gap {
  display: inline-block;
}

/* 
 * ==================== æ¨¡å‹ç³»åˆ—æ ‡ç­¾ ====================
 * 
 * æ˜¾ç¤ºæ¨¡å‹æ‰€å±ç³»åˆ—ï¼Œå¦‚ "GPT", "Claude", "Gemini" ç­‰
 */
.model-series {
  font-size: 0.75rem;
  opacity: 0.7;                           /* åŠé€æ˜ï¼Œé™ä½è§†è§‰æƒé‡ */
}

/* å½“æŒ‰é’®è¢«é€‰ä¸­æ—¶ï¼Œç³»åˆ—æ ‡ç­¾ä¸é‚£ä¹ˆé€æ˜ */
.favorite-model-btn.active .model-series {
  opacity: 0.9;
}

/* 
 * ==================== æ¨¡å‹å…ƒæ•°æ®å®¹å™¨ ====================
 * 
 * åŒ…å«ä¸Šä¸‹æ–‡é•¿åº¦å¾½ç« å’Œå¤šæ¨¡æ€å›¾æ ‡
 * ä½äºæŒ‰é’®å³ä¾§ï¼Œå›ºå®šå®½åº¦
 */
.model-meta {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  margin-left: 0.5rem;
}

/* 
 * ==================== ä¸Šä¸‹æ–‡é•¿åº¦å¾½ç«  ====================
 * 
 * æ˜¾ç¤ºæ¨¡å‹æ”¯æŒçš„ä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼ˆå¦‚ "128K", "2M"ï¼‰
 */
.context-badge {
  font-size: 0.7rem;
  padding: 0.125rem 0.375rem;
  background: rgba(0, 0, 0, 0.1);         /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
  border-radius: 0.25rem;
  font-weight: 600;
}

/* å½“æŒ‰é’®è¢«é€‰ä¸­æ—¶ï¼Œå¾½ç« èƒŒæ™¯å˜ä¸ºåŠé€æ˜ç™½è‰² */
.favorite-model-btn.active .context-badge {
  background: rgba(255, 255, 255, 0.2);
}

/* 
 * ==================== å¤šæ¨¡æ€å¾½ç«  ====================
 * 
 * æ˜¾ç¤º ğŸ¨ emojiï¼Œè¡¨ç¤ºæ¨¡å‹æ”¯æŒå›¾ç‰‡ç­‰å¤šæ¨¡æ€è¾“å…¥
 * æ— éœ€é¢å¤–æ ·å¼ï¼Œä½¿ç”¨ .modality-badge ç±»ä»…ä¸ºè¯­ä¹‰åŒ–
 */.modality-badge {
  font-size: 0.875rem;
}
</style>
