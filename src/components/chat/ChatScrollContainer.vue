<!--
  ChatScrollContainer - Stick-to-Bottom æ»šåŠ¨å®¹å™¨ç»„ä»¶
  
  èŒè´£:
  - åŒ…è£…æ¶ˆæ¯åˆ—è¡¨çš„æ»šåŠ¨å®¹å™¨
  - é›†æˆ useChatStickToBottom çŠ¶æ€æœº
  - ç›‘å¬ç”¨æˆ·äº¤äº’äº‹ä»¶(wheel/touch/mousedown)
  - æ¸²æŸ“"å›åˆ°åº•éƒ¨"æµ®åŠ¨æŒ‰é’®
  - æš´éœ²ç»Ÿä¸€çš„æ»šåŠ¨æ§åˆ¶ API
  
  ä½¿ç”¨æ–¹å¼:
  <ChatScrollContainer ref="chatScrollRef">
    <MessageItem v-for="m in messages" :key="m.id" :message="m" />
  </ChatScrollContainer>
  
  çˆ¶ç»„ä»¶è°ƒç”¨:
  - chatScrollRef.value?.onNewContent() // æ–°å†…å®¹åˆ°æ¥æ—¶
  - chatScrollRef.value?.scrollToBottom() // å¼ºåˆ¶æ»šåˆ°åº•éƒ¨
  - chatScrollRef.value?.getScrollTop() // è·å–æ»šåŠ¨ä½ç½®
  - chatScrollRef.value?.setScrollTop(y) // è®¾ç½®æ»šåŠ¨ä½ç½®
-->

<script setup lang="ts">
import { useChatStickToBottom } from '@/composables/useChatStickToBottom'

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ç»§æ‰¿å±æ€§é…ç½®
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// ç¦ç”¨è‡ªåŠ¨ç»§æ‰¿,æ‰‹åŠ¨åœ¨æ ¹å…ƒç´ ä¸Šç»‘å®š $attrs (åŒ…æ‹¬ class)
defineOptions({
  inheritAttrs: false
})

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Props (æœªæ¥å¯æ‰©å±•é…ç½®é¡¹)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// æš‚æ—  props,æœªæ¥å¯æ·»åŠ :
// - lockCooldownMs?: number
// - nearBottomThreshold?: number
// - showBackToBottomButton?: boolean

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Composable: Stick-to-Bottom çŠ¶æ€æœº
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const {
  scrollRef,
  sentinelRef,
  isAtBottom,
  escapedFromLock,
  scrollToBottom,
  onNewContent,
  onUserScrollStart,
  getScrollTop,
  setScrollTop,
} = useChatStickToBottom({
  lockCooldownMs: 800,      // ç”¨æˆ·æ»šåŠ¨åå†·å´æ—¶é—´
  nearBottomThreshold: 40,  // æ¥è¿‘åº•éƒ¨çš„åƒç´ é˜ˆå€¼
})

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// æš´éœ²ç»™çˆ¶ç»„ä»¶çš„ API
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

defineExpose({
  /** æ–°å†…å®¹åˆ°æ¥æ—¶è°ƒç”¨,ç”±çŠ¶æ€æœºå†³å®šæ˜¯å¦æ»šåŠ¨ */
  onNewContent,
  
  /** å¼ºåˆ¶æ»šåˆ°åº•éƒ¨(ä»å—çŠ¶æ€æœºçº¦æŸ) */
  scrollToBottom,
  
  /** è·å–å½“å‰æ»šåŠ¨ä½ç½®(ç”¨äºå¯¹è¯åˆ‡æ¢æ—¶ä¿å­˜) */
  getScrollTop,
  
  /** è®¾ç½®æ»šåŠ¨ä½ç½®(ç”¨äºå¯¹è¯åˆ‡æ¢æ—¶æ¢å¤,ä¼šè§¦å‘ escapedFromLock) */
  setScrollTop,
  
  /** åªè¯»çŠ¶æ€:å½“å‰æ˜¯å¦åœ¨åº•éƒ¨ */
  isAtBottom,
  
  /** åªè¯»çŠ¶æ€:ç”¨æˆ·æ˜¯å¦å·²é€ƒç¦»é”å®š */
  escapedFromLock,
})

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// äº‹ä»¶å¤„ç†
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/**
 * @scroll äº‹ä»¶å¯é€‰ç›‘å¬,ç”¨äº debug æˆ–æœªæ¥æ‰©å±•
 * å½“å‰ç”¨æˆ·æ„å›¾åˆ¤æ–­ä¸»è¦é€šè¿‡ wheel/touchstart/mousedown
 */
const handleScroll = () => {
  // é¢„ç•™æ‰©å±•ç‚¹
  // ä¾‹å¦‚: è®°å½•æ»šåŠ¨æ–¹å‘ã€é€Ÿåº¦ç­‰
}
</script>

<template>
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- æ»šåŠ¨å®¹å™¨ -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div
    ref="scrollRef"
    class="chat-scroll-container"
    v-bind="$attrs"
    @scroll="handleScroll"
    @wheel.passive="onUserScrollStart"
    @touchstart.passive="onUserScrollStart"
    @mousedown="onUserScrollStart"
  >
    <!-- æ¶ˆæ¯å†…å®¹(é€šè¿‡ slot æ³¨å…¥) -->
    <slot />

    <!-- åº•éƒ¨å“¨å…µå…ƒç´ (IntersectionObserver ç›‘æ§ç›®æ ‡) -->
    <div 
      ref="sentinelRef" 
      class="chat-scroll-sentinel"
      aria-hidden="true"
    />
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- "å›åˆ°åº•éƒ¨"æµ®åŠ¨æŒ‰é’® -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <Transition name="fade">
    <button
      v-if="!isAtBottom"
      class="chat-scroll-to-bottom-btn"
      @click="scrollToBottom({ force: true })"
      aria-label="å›åˆ°åº•éƒ¨"
    >
      <svg 
        xmlns="http://www.w3.org/2000/svg" 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        stroke-width="2" 
        stroke-linecap="round" 
        stroke-linejoin="round"
        class="w-4 h-4"
      >
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
      <span class="ml-1">å›åˆ°åº•éƒ¨</span>
    </button>
  </Transition>
</template>

<style scoped>
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* æ»šåŠ¨å®¹å™¨æ ·å¼ */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.chat-scroll-container {
  /* é«˜åº¦ç”±çˆ¶ç»„ä»¶(ChatView)çš„ flex å¸ƒå±€æ§åˆ¶ */
  height: 100%;
  
  /* å‚ç›´æ»šåŠ¨ */
  overflow-y: auto;
  overflow-x: hidden;
  
  /* ğŸ”’ å…³é”®: ç¦ç”¨æµè§ˆå™¨åŸç”Ÿæ»šåŠ¨é”šå®š,é¿å…ä¸çŠ¶æ€æœºå†²çª */
  overflow-anchor: none;
  
  /* ç¬¬ä¸€ç‰ˆä½¿ç”¨ç¬æ—¶æ»šåŠ¨,ç”± JS æ§åˆ¶ */
  scroll-behavior: auto;
  
  /* ç›¸å¯¹å®šä½,ä¸ºæµ®åŠ¨æŒ‰é’®æä¾›å®šä½ä¸Šä¸‹æ–‡ */
  position: relative;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* å“¨å…µå…ƒç´ æ ·å¼ */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.chat-scroll-sentinel {
  /* 1px é«˜åº¦å³å¯è¢« IntersectionObserver æ£€æµ‹ */
  height: 1px;
  
  /* ä¸å å¸ƒå±€ç©ºé—´,é¿å…è§†è§‰å½±å“ */
  pointer-events: none;
  
  /* å®Œå…¨é€æ˜ */
  opacity: 0;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* "å›åˆ°åº•éƒ¨"æµ®åŠ¨æŒ‰é’®æ ·å¼ */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.chat-scroll-to-bottom-btn {
  /* ç»å¯¹å®šä½,æµ®åŠ¨åœ¨å†…å®¹ä¹‹ä¸Š */
  position: absolute;
  right: 1rem;
  bottom: 1rem;
  
  /* å¸ƒå±€ */
  display: flex;
  align-items: center;
  gap: 0.25rem;
  
  /* é—´è· */
  padding: 0.5rem 0.75rem;
  
  /* åœ†è§’ */
  border-radius: 9999px;
  
  /* å­—ä½“ */
  font-size: 0.875rem;
  font-weight: 500;
  
  /* é¢œè‰²(ä½¿ç”¨ Tailwind ä¸»é¢˜è‰²,å¯æ ¹æ®é¡¹ç›®è°ƒæ•´) */
  background-color: rgba(0, 0, 0, 0.75);
  color: white;
  
  /* é˜´å½± */
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 
              0 2px 4px -1px rgba(0, 0, 0, 0.06);
  
  /* äº¤äº’ */
  cursor: pointer;
  transition: all 0.2s ease;
  
  /* å±‚çº§ */
  z-index: 10;
}

.chat-scroll-to-bottom-btn:hover {
  background-color: rgba(0, 0, 0, 0.85);
  transform: translateY(-1px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
              0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.chat-scroll-to-bottom-btn:active {
  transform: translateY(0);
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* è¿‡æ¸¡åŠ¨ç”» */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
  transform: translateY(0.5rem);
}
</style>
