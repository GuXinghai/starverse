# Assistant æ¶ˆæ¯åˆ›å»ºæ—¶æœºä¿®æ­£ - é›†æˆæµ‹è¯•æ£€æŸ¥æ¸…å•

## æµ‹è¯•æ—¥æœŸ
2025å¹´12æœˆ9æ—¥ 23:45

## æµ‹è¯•ç›®æ ‡
éªŒè¯ assistant æ¶ˆæ¯åœ¨å»¶æ—¶ç»“æŸåç«‹å³åˆ›å»ºï¼Œç”¨æˆ·å¯ä»¥åœ¨ requesting é˜¶æ®µçœ‹åˆ°å®Œæ•´å¯¹è¯å†å²ã€‚

---

## å‰ç½®å‡†å¤‡

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```powershell
npm run dev
```
âœ… **çŠ¶æ€**: å·²å¯åŠ¨

### 2. é…ç½®å»¶æ—¶å‚æ•°
- è¿›å…¥è®¾ç½®é¡µé¢
- å°†"æ¶ˆæ¯å‘é€å»¶æ—¶"è®¾ç½®ä¸º **3000ms (3ç§’)**
- ä¿å­˜è®¾ç½®
- éªŒè¯é…ç½®ç”Ÿæ•ˆ: `appStore.sendDelayMs === 3000`

---

## æ ¸å¿ƒæµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å»¶æ—¶ç»“æŸæ—¶çš„çŠ¶æ€æ£€æŸ¥ â­ æ ¸å¿ƒéªŒæ”¶ç‚¹

**æ­¥éª¤:**
1. åœ¨èŠå¤©è¾“å…¥æ¡†è¾“å…¥æµ‹è¯•æ¶ˆæ¯ï¼š"æµ‹è¯• assistant åˆ›å»ºæ—¶æœº"
2. ç‚¹å‡»å‘é€æŒ‰é’®
3. è§‚å¯Ÿå€’è®¡æ—¶ï¼ˆ3s... 2s... 1s...ï¼‰
4. **åœ¨å€’è®¡æ—¶ç»“æŸçš„ç¬é—´**ï¼Œç«‹å³è§‚å¯Ÿå¯¹è¯å†å²åŒºåŸŸ

**é¢„æœŸç»“æœ:**
- âœ… ç”¨æˆ·æ¶ˆæ¯ç«‹å³æ˜¾ç¤ºï¼ˆè“è‰²æ°”æ³¡ï¼Œç”¨æˆ·å¤´åƒï¼‰
- âœ… ç³»ç»Ÿæç¤ºæ¶ˆæ¯æ˜¾ç¤ºï¼š"æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…æµå¼å›å¤â€¦â€¦"
- âœ… **ç©ºçš„ assistant æ¶ˆæ¯å ä½ç¬¦å¯è§**ï¼ˆç°è‰²æ°”æ³¡ï¼ŒAI å¤´åƒï¼Œå†…å®¹ä¸ºç©ºæˆ–æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼‰
- âœ… æ­¤æ—¶å°šæœªæ”¶åˆ°ä»»ä½• AI å›å¤å†…å®¹

**éªŒè¯æ–¹æ³•:**
- æ‰“å¼€å¼€å‘è€…å·¥å…· (F12) â†’ Console æ ‡ç­¾
- æŸ¥æ‰¾æ—¥å¿—: `[useMessageSending] âœ… assistant å ä½ç¬¦å·²åˆ›å»º: branch-xxxxx`
- ç¡®è®¤è¯¥æ—¥å¿—åœ¨ `ğŸš€ å‡†å¤‡è°ƒç”¨ sendMessageCore` **ä¹‹å‰**å‡ºç°

---

### åœºæ™¯ 2: Requesting é˜¶æ®µä¸­æ­¢æµ‹è¯•

**æ­¥éª¤:**
1. å‘é€æ¶ˆæ¯è§¦å‘å»¶æ—¶
2. ç­‰å¾…å€’è®¡æ—¶ç»“æŸï¼ˆè¿›å…¥ requesting é˜¶æ®µï¼‰
3. **åœ¨ AI å›å¤å†…å®¹å‡ºç°ä¹‹å‰**ï¼Œç«‹å³ç‚¹å‡»"ä¸­æ­¢"æŒ‰é’®

**é¢„æœŸç»“æœ:**
- âœ… ç©º assistant æ¶ˆæ¯ä¿ç•™åœ¨å†å²ä¸­
- âœ… æ¶ˆæ¯æ ‡è®°ä¸º"å·²ä¸­æ­¢"æˆ–"å¯é‡è¯•"
- âœ… æ²¡æœ‰äº§ç”Ÿå¤šä½™çš„ç©ºæ¶ˆæ¯èŠ‚ç‚¹
- âœ… Console æ—¥å¿—æ˜¾ç¤º: `ğŸ“‹ Phase = requesting: åˆ›å»ºç©ºæ¶ˆæ¯å£³ä¾›é‡è¯•`

**éªŒè¯æ–¹æ³•:**
- æ£€æŸ¥å¯¹è¯å†å²ï¼Œåº”è¯¥çœ‹åˆ°:
  1. ç”¨æˆ·æ¶ˆæ¯
  2. ç©º assistant æ¶ˆæ¯ï¼ˆå¸¦ä¸­æ­¢æ ‡è®°ï¼‰
- æ£€æŸ¥åˆ†æ”¯æ ‘ç»“æ„ï¼Œç¡®è®¤åªæœ‰ä¸€ä¸ª assistant èŠ‚ç‚¹

---

### åœºæ™¯ 3: Streaming é˜¶æ®µä¸­æ­¢æµ‹è¯•

**æ­¥éª¤:**
1. å‘é€æ¶ˆæ¯è§¦å‘å»¶æ—¶
2. ç­‰å¾… AI å¼€å§‹æµå¼å›å¤ï¼ˆçœ‹åˆ°éƒ¨åˆ†å†…å®¹ï¼‰
3. åœ¨æµå¼è¿‡ç¨‹ä¸­ç‚¹å‡»"ä¸­æ­¢"æŒ‰é’®

**é¢„æœŸç»“æœ:**
- âœ… assistant æ¶ˆæ¯ä¿ç•™å·²ç”Ÿæˆçš„éƒ¨åˆ†å†…å®¹
- âœ… æ¶ˆæ¯æ ‡è®°ä¸º"æµå¼å·²ä¸­æ­¢"
- âœ… å·²ç”Ÿæˆçš„å†…å®¹ä¸ä¼šä¸¢å¤±
- âœ… Console æ—¥å¿—æ˜¾ç¤º: `ğŸŒŠ Phase = streaming: æ ‡è®°æµå¼è¢«ä¸­æ­¢`

---

### åœºæ™¯ 4: æ­£å¸¸å®Œæˆæµå¼è¾“å‡º

**æ­¥éª¤:**
1. å‘é€æ¶ˆæ¯è§¦å‘å»¶æ—¶
2. ç­‰å¾…å€’è®¡æ—¶ç»“æŸ
3. è§‚å¯Ÿ AI æµå¼å›å¤è¿‡ç¨‹
4. ç­‰å¾…æµå¼å®Œæˆ

**é¢„æœŸç»“æœ:**
- âœ… å»¶æ—¶ç»“æŸæ—¶çœ‹åˆ°ç©º assistant å ä½ç¬¦
- âœ… é¦–ä¸ª chunk åˆ°è¾¾æ—¶ï¼Œå†…å®¹å¼€å§‹åœ¨åŒä¸€ä¸ª assistant æ¶ˆæ¯ä¸Šç´¯ç§¯
- âœ… æµå¼å®Œæˆåï¼Œassistant æ¶ˆæ¯æ˜¾ç¤ºå®Œæ•´å›å¤
- âœ… Console æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„é˜¶æ®µè½¬æ¢:
  - `åˆ›å»º assistant æ¶ˆæ¯å ä½ç¬¦`
  - `ğŸ“ é˜¶æ®µè½¬æ¢: requesting -> streaming`
  - `â­ é˜¶æ®µè½¬æ¢ï¼šstreaming -> completed`

---

### åœºæ™¯ 5: é›¶å»¶æ—¶å³æ—¶å‘é€

**æ­¥éª¤:**
1. å°†å‘é€å»¶æ—¶è®¾ç½®ä¸º **0ms**
2. å‘é€æ¶ˆæ¯

**é¢„æœŸç»“æœ:**
- âœ… ä¸ç»è¿‡ delay é˜¶æ®µ
- âœ… assistant æ¶ˆæ¯åœ¨å‘é€ç¬é—´åˆ›å»º
- âœ… ç«‹å³è¿›å…¥ requesting é˜¶æ®µ
- âœ… è¡Œä¸ºä¸æœ‰å»¶æ—¶çš„æƒ…å†µä¸€è‡´ï¼ˆåªæ˜¯è·³è¿‡å€’è®¡æ—¶ï¼‰

---

### åœºæ™¯ 6: æ’¤å›åŠŸèƒ½é™åˆ¶

**æ­¥éª¤:**
1. å‘é€æ¶ˆæ¯è§¦å‘å»¶æ—¶
2. **åœ¨å€’è®¡æ—¶æœŸé—´**ï¼ˆdelay é˜¶æ®µï¼‰ç‚¹å‡»"æ’¤å›"æŒ‰é’® â†’ åº”è¯¥æˆåŠŸ
3. å†æ¬¡å‘é€ï¼Œç­‰å¾…å€’è®¡æ—¶ç»“æŸ
4. **åœ¨ requesting é˜¶æ®µ**å°è¯•ç‚¹å‡»"æ’¤å›"æŒ‰é’®

**é¢„æœŸç»“æœ:**
- âœ… delay é˜¶æ®µå¯ä»¥æ’¤å›ï¼ˆæ¢å¤è¾“å…¥æ¡†å†…å®¹å’Œé™„ä»¶ï¼‰
- âœ… requesting/streaming é˜¶æ®µ**ä¸æ˜¾ç¤º**æ’¤å›æŒ‰é’®ï¼Œåªæ˜¾ç¤ºä¸­æ­¢æŒ‰é’®
- âœ… ç•Œé¢ UI æ­£ç¡®åæ˜ å½“å‰å¯ç”¨æ“ä½œ

---

## æ€§èƒ½ä¸æ—¥å¿—éªŒè¯

### Console æ—¥å¿—æ£€æŸ¥

**å…³é”®æ—¥å¿—åºåˆ—ï¼ˆæ­£å¸¸æµç¨‹ï¼‰:**
```
[useMessageSending] performSendMessage è°ƒç”¨
[useMessageSending] åˆ›å»º assistant æ¶ˆæ¯å ä½ç¬¦
[useMessageSending] âœ… assistant å ä½ç¬¦å·²åˆ›å»º: branch-xxxxx
[useMessageSending] ğŸš€ å‡†å¤‡è°ƒç”¨ sendMessageCore {
  assistantMessageId: 'branch-xxxxx'  // â­ å¿…é¡»å­˜åœ¨
}
[useMessageSending] ä½¿ç”¨å·²åˆ›å»ºçš„ assistant æ¶ˆæ¯ [send-...]: branch-xxxxx
[useMessageSending] ğŸ“ é˜¶æ®µè½¬æ¢: requesting -> streaming
```

**ç¦æ­¢å‡ºç°çš„æ—¥å¿—:**
```
âŒ [useMessageSending] åˆ›å»º AI æ¶ˆæ¯åˆ†æ”¯ [send-...]  // æ—§é€»è¾‘ï¼Œåº”è¯¥å·²åˆ é™¤
```

### æ€§èƒ½æŒ‡æ ‡ï¼ˆSendTimingï¼‰

æŸ¥æ‰¾åŒ…å« TTFB çš„æ—¥å¿—:
```
[useMessageSending] æ€§èƒ½æŒ‡æ ‡ {
  requestedAt: ...,
  httpRequestStartedAt: ...,
  firstChunkAt: ...,
  ttfb: ...  // Time To First Byte
}
```

éªŒè¯ TTFB è®¡ç®—æ­£ç¡®: `firstChunkAt - httpRequestStartedAt`

---

## è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### 1. è¿ç»­å‘é€å¤šæ¡æ¶ˆæ¯
- å¿«é€Ÿè¿ç»­ç‚¹å‡»å‘é€æŒ‰é’®
- éªŒè¯å¹¶å‘ä¿æŠ¤ç”Ÿæ•ˆ
- ç¡®è®¤æ¯æ¡æ¶ˆæ¯éƒ½æœ‰æ­£ç¡®çš„ assistant å ä½ç¬¦

### 2. ç½‘ç»œå¼‚å¸¸æ¨¡æ‹Ÿ
- æ–­å¼€ç½‘ç»œè¿æ¥
- å‘é€æ¶ˆæ¯
- éªŒè¯ requesting é˜¶æ®µè¶…æ—¶å¤„ç†
- ç¡®è®¤ç©º assistant æ¶ˆæ¯æœ‰é”™è¯¯æ ‡è®°

### 3. é¡µé¢åˆ·æ–°åæ¢å¤
- å‘é€æ¶ˆæ¯åˆ° requesting é˜¶æ®µ
- åˆ·æ–°é¡µé¢
- éªŒè¯çŠ¶æ€æ¢å¤é€»è¾‘

---

## å›å½’æµ‹è¯•

ç¡®ä¿ä¿®æ”¹ä¸å½±å“ç°æœ‰åŠŸèƒ½:

- âœ… å›¾ç‰‡ä¸Šä¼ ä»ç„¶æ­£å¸¸
- âœ… æ–‡ä»¶é™„ä»¶ä»ç„¶æ­£å¸¸
- âœ… åˆ†æ”¯åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- âœ… å¤šæ ‡ç­¾é¡µç®¡ç†æ­£å¸¸
- âœ… å¯¹è¯åˆ—è¡¨å’Œæœç´¢æ­£å¸¸

---

## æµ‹è¯•ç»“æœè®°å½•

### âœ… é€šè¿‡çš„åœºæ™¯
- [ ] åœºæ™¯ 1: å»¶æ—¶ç»“æŸæ—¶çš„çŠ¶æ€æ£€æŸ¥
- [ ] åœºæ™¯ 2: Requesting é˜¶æ®µä¸­æ­¢
- [ ] åœºæ™¯ 3: Streaming é˜¶æ®µä¸­æ­¢
- [ ] åœºæ™¯ 4: æ­£å¸¸å®Œæˆæµå¼è¾“å‡º
- [ ] åœºæ™¯ 5: é›¶å»¶æ—¶å³æ—¶å‘é€
- [ ] åœºæ™¯ 6: æ’¤å›åŠŸèƒ½é™åˆ¶

### âŒ å‘ç°çš„é—®é¢˜
ï¼ˆè®°å½•ä»»ä½•ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºï¼‰

---

## å¼€å‘è€…å·¥å…·å¿«æ·æ“ä½œ

### å¿«é€Ÿæ£€æŸ¥ pendingSend çŠ¶æ€
æ‰“å¼€ Consoleï¼Œæ‰§è¡Œ:
```javascript
// æ£€æŸ¥å½“å‰ pendingSend
window.__vueApp__?.config?.globalProperties?.$root?._instance?.provides?.useSendingComposable?.pendingSend?.value

// æ£€æŸ¥ phase
window.__vueApp__?.config?.globalProperties?.$root?._instance?.provides?.useSendingComposable?.pendingSend?.value?.phase
```

### å¿«é€Ÿä¿®æ”¹å»¶æ—¶é…ç½®
```javascript
// ä¸´æ—¶è®¾ç½® 3 ç§’å»¶æ—¶ï¼ˆéœ€é‡æ–°å‘é€æ¶ˆæ¯ç”Ÿæ•ˆï¼‰
const appStore = window.__vueApp__?.config?.globalProperties?.$pinia?.state?.value?.app
if (appStore) {
  appStore.sendDelayMs = 3000
}
```

---

## å®Œæˆæ ‡å‡†

æ‰€æœ‰ 6 ä¸ªæ ¸å¿ƒåœºæ™¯æµ‹è¯•é€šè¿‡ï¼Œä¸”:
1. Console æ—¥å¿—åºåˆ—å®Œå…¨ç¬¦åˆé¢„æœŸ
2. UI äº¤äº’æµç•…æ— å¡é¡¿
3. æ²¡æœ‰å‡ºç°é‡å¤çš„ assistant æ¶ˆæ¯
4. çŠ¶æ€è½¬æ¢æ¸…æ™°æ˜ç¡®
5. é”™è¯¯å¤„ç†å¥å£®

æµ‹è¯•å®Œæˆåï¼Œæ›´æ–°æœ¬æ–‡æ¡£çš„"æµ‹è¯•ç»“æœè®°å½•"éƒ¨åˆ†ã€‚
