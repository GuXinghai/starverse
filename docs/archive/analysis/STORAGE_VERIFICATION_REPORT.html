<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŠå¤©å­˜å‚¨æ–¹æ¡ˆæ£€æŸ¥æŠ¥å‘Š</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success {
      color: #4CAF50;
      font-weight: bold;
    }
    .warning {
      color: #FF9800;
      font-weight: bold;
    }
    .error {
      color: #F44336;
      font-weight: bold;
    }
    .code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    .flow-diagram {
      background: #e3f2fd;
      padding: 15px;
      border-left: 4px solid #2196F3;
      margin: 15px 0;
    }
    ul {
      line-height: 1.8;
    }
    .summary {
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      padding: 15px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” Starverse èŠå¤©å­˜å‚¨æ–¹æ¡ˆæ£€æŸ¥æŠ¥å‘Š</h1>
  
  <div class="section">
    <h2>ğŸ“Š æ£€æŸ¥ç»“æœæ€»ç»“</h2>
    <div class="summary">
      <p class="success">âœ… å½“å‰èŠå¤©å­˜å‚¨å·²æ­£ç¡®å®ç°å¹¶è°ƒç”¨æ–°ç‰ˆå­˜å‚¨æ–¹æ¡ˆï¼ˆSQLite + å¢é‡ä¿å­˜ï¼‰</p>
    </div>
  </div>

  <div class="section">
    <h2>1ï¸âƒ£ å¯¼å…¥éªŒè¯</h2>
    <p class="success">âœ… æˆåŠŸå¯¼å…¥</p>
    <p>åœ¨ <span class="code">src/stores/chatStore.js</span> ä¸­æ‰¾åˆ°ï¼š</p>
    <pre class="code">import { sqliteChatPersistence } from '../services/chatPersistence'</pre>
  </div>

  <div class="section">
    <h2>2ï¸âƒ£ SQLite æŒä¹…åŒ–å¼€å…³</h2>
    <p class="success">âœ… å·²å®ç°å¼€å…³æœºåˆ¶</p>
    <ul>
      <li><span class="code">shouldUseSqlitePersistence</span>: 11 å¤„ä½¿ç”¨</li>
      <li><span class="code">useSqlitePersistence.value</span>: 7 å¤„ä½¿ç”¨</li>
      <li><strong>é»˜è®¤å€¼</strong>: <span class="code">!isUsingDbBridgeFallback</span> (åœ¨ Electron ç¯å¢ƒä¸­é»˜è®¤å¯ç”¨)</li>
    </ul>
  </div>

  <div class="section">
    <h2>3ï¸âƒ£ å®é™…è°ƒç”¨ä½ç½®</h2>
    <p class="success">âœ… æ‰¾åˆ°æ‰€æœ‰å…³é”®è°ƒç”¨</p>
    <ul>
      <li><strong>listConversations()</strong>: ç¬¬ 444 è¡Œ - åŠ è½½å¯¹è¯æ—¶ä½¿ç”¨</li>
      <li><strong>saveConversation()</strong>: ç¬¬ 608 è¡Œ - ä¿å­˜å•ä¸ªå¯¹è¯</li>
      <li><strong>deleteConversation()</strong>: ç¬¬ 611 è¡Œ - åˆ é™¤å¯¹è¯</li>
    </ul>
  </div>

  <div class="section">
    <h2>4ï¸âƒ£ saveConversations() å®ç°åˆ†æ</h2>
    <p class="success">âœ… åŒ…å«å®Œæ•´çš„ SQLite åˆ†æ”¯é€»è¾‘</p>
    <div class="flow-diagram">
      <strong>æ‰§è¡Œæµç¨‹:</strong>
      <pre>
if (shouldUseSqlitePersistence.value) {
  // SQLite è·¯å¾„ï¼šé€æ¡å†™å…¥å¿«ç…§ + åŒæ­¥åˆ é™¤é˜Ÿåˆ—
  for (const conv of conversationsToSave) {
    await sqliteChatPersistence.saveConversation(toConversationSnapshot(conv))
  }
  for (const deletedId of deletedConversationIds.value) {
    await sqliteChatPersistence.deleteConversation(deletedId)
  }
  dirtyConversationIds.value.clear()
  deletedConversationIds.value.clear()
  return  // âš ï¸ æå‰è¿”å›ï¼Œé¿å…æ‰§è¡Œæ—§çš„ JSON åºåˆ—åŒ–é€»è¾‘
}
      </pre>
    </div>
    <p><strong>å…³é”®ç‰¹æ€§:</strong></p>
    <ul>
      <li>âœ… é€æ¡ä¿å­˜ï¼ˆé¿å…æ•´ä½“ JSON åºåˆ—åŒ–ï¼‰</li>
      <li>âœ… ä½¿ç”¨ <span class="code">toConversationSnapshot</span> è½¬æ¢æ•°æ®</li>
      <li>âœ… æ¸…ç©ºè„æ ‡è®°å’Œåˆ é™¤é˜Ÿåˆ—</li>
      <li>âœ… æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåç»­çš„æ—§é€»è¾‘</li>
    </ul>
  </div>

  <div class="section">
    <h2>5ï¸âƒ£ SqliteChatPersistence ç±»å®ç°</h2>
    <p class="success">âœ… å®Œæ•´å®ç°åœ¨ <span class="code">src/services/chatPersistence.ts</span></p>
    <p><strong>å®ç°çš„æ–¹æ³•:</strong></p>
    <ul>
      <li>âœ… <span class="code">listConversations()</span> - ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å¯¹è¯</li>
      <li>âœ… <span class="code">saveConversation(snapshot)</span> - ä¿å­˜å•ä¸ªå¯¹è¯åˆ°æ•°æ®åº“</li>
      <li>âœ… <span class="code">deleteConversation(convoId)</span> - ä»æ•°æ®åº“åˆ é™¤å¯¹è¯</li>
    </ul>
    <p><strong>åº•å±‚è°ƒç”¨:</strong></p>
    <ul>
      <li>âœ… <span class="code">dbService.saveConvo()</span> - ä¿å­˜å¯¹è¯å…ƒæ•°æ®</li>
      <li>âœ… <span class="code">dbService.replaceMessages()</span> - æ›´æ–°æ¶ˆæ¯è®°å½•ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰</li>
      <li>âœ… <span class="code">serializeTree()</span> - åºåˆ—åŒ–åˆ†æ”¯æ ‘ç»“æ„</li>
    </ul>
  </div>

  <div class="section">
    <h2>6ï¸âƒ£ å¢é‡ä¿å­˜æœºåˆ¶</h2>
    <p class="success">âœ… å·²å®ç°è„æ ‡è®°ï¼ˆDirty Trackingï¼‰æœºåˆ¶</p>
    <p><strong>è„æ ‡è®°é›†åˆ:</strong></p>
    <ul>
      <li><span class="code">dirtyConversationIds</span> - è·Ÿè¸ªè¢«ä¿®æ”¹çš„å¯¹è¯</li>
      <li><span class="code">deletedConversationIds</span> - è·Ÿè¸ªå¾…åˆ é™¤çš„å¯¹è¯ï¼ˆä»… SQLite æ¨¡å¼ï¼‰</li>
    </ul>
    <p><strong>æ ‡è®°ä½ç½®:</strong> 1 å¤„ä¸»è¦è°ƒç”¨ç‚¹</p>
    <p><strong>è¿‡æ»¤é€»è¾‘:</strong> âœ… å®ç°äº†å¢é‡ä¿å­˜è¿‡æ»¤ï¼ˆåªä¿å­˜å˜æ›´çš„å¯¹è¯ï¼‰</p>
  </div>

  <div class="section">
    <h2>7ï¸âƒ£ å­˜å‚¨æµç¨‹å›¾</h2>
    <div class="flow-diagram">
      <strong>å®Œæ•´å­˜å‚¨æµç¨‹:</strong>
      <ol>
        <li><strong>æ£€æŸ¥å¼€å…³</strong>: <span class="code">shouldUseSqlitePersistence</span> (é»˜è®¤ true)</li>
        <li><strong>å¢é‡è¿‡æ»¤</strong>: åªé€‰æ‹©è¢«æ ‡è®°ä¸ºè„çš„å¯¹è¯</li>
        <li><strong>æ•°æ®è½¬æ¢</strong>: ä½¿ç”¨ <span class="code">toConversationSnapshot()</span> è½¬æ¢ä¸ºå¿«ç…§æ ¼å¼</li>
        <li><strong>è°ƒç”¨æŒä¹…åŒ–</strong>: <span class="code">sqliteChatPersistence.saveConversation()</span></li>
        <li><strong>æ•°æ®åº“æ“ä½œ</strong>:
          <ul>
            <li>ä¿å­˜å¯¹è¯å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬åˆ†æ”¯æ ‘ï¼‰åˆ° <span class="code">convo</span> è¡¨</li>
            <li>æ›´æ–°æ¶ˆæ¯åˆ° <span class="code">message</span> è¡¨ï¼ˆæ”¯æŒå…¨æ–‡æœç´¢ï¼‰</li>
          </ul>
        </li>
        <li><strong>æ¸…ç†æ ‡è®°</strong>: æ¸…ç©º <span class="code">dirtyConversationIds</span> å’Œ <span class="code">deletedConversationIds</span></li>
      </ol>
    </div>
  </div>

  <div class="section">
    <h2>8ï¸âƒ£ æ€§èƒ½ä¼˜åŠ¿</h2>
    <p><strong>ç›¸æ¯”æ—§æ–¹æ¡ˆçš„æ”¹è¿›:</strong></p>
    <ul>
      <li>ğŸš€ <strong>å¢é‡ä¿å­˜</strong>: åªä¿å­˜å˜æ›´çš„å¯¹è¯ï¼Œä¸æ˜¯å…¨éƒ¨å¯¹è¯</li>
      <li>ğŸš€ <strong>é¿å…å¤§åºåˆ—åŒ–</strong>: é€æ¡ä¿å­˜ï¼Œä¸è¿›è¡Œæ•´ä½“ JSON.stringify</li>
      <li>ğŸš€ <strong>æ•°æ®åº“å­˜å‚¨</strong>: ä½¿ç”¨ SQLiteï¼Œæ¯” JSON æ–‡ä»¶æ›´é«˜æ•ˆ</li>
      <li>ğŸš€ <strong>å…¨æ–‡æœç´¢</strong>: æ”¯æŒ FTS5 å…¨æ–‡æœç´¢åŠŸèƒ½</li>
      <li>ğŸš€ <strong>ç»“æ„åŒ–æŸ¥è¯¢</strong>: æ”¯æŒå¤æ‚çš„æ•°æ®æŸ¥è¯¢å’Œè¿‡æ»¤</li>
    </ul>
    <p><strong>æ€§èƒ½æå‡ä¼°ç®—:</strong></p>
    <ul>
      <li>ä¿®æ”¹ 1/100 ä¸ªå¯¹è¯: <span class="success">æ€§èƒ½æå‡ ~99%</span></li>
      <li>ä¿®æ”¹ 1/10 ä¸ªå¯¹è¯: <span class="success">æ€§èƒ½æå‡ ~90%</span></li>
      <li>å¤§æ•°æ®é‡åœºæ™¯: <span class="success">é¿å… UI å¡é¡¿</span></li>
    </ul>
  </div>

  <div class="section">
    <h2>9ï¸âƒ£ å›é€€æœºåˆ¶</h2>
    <p class="warning">âš ï¸ ä¿ç•™äº†æ—§çš„ JSON åºåˆ—åŒ–é€»è¾‘ä½œä¸ºå›é€€æ–¹æ¡ˆ</p>
    <p><strong>è§¦å‘æ¡ä»¶:</strong></p>
    <ul>
      <li><span class="code">isUsingDbBridgeFallback === true</span> (dbBridge ä¸å¯ç”¨)</li>
      <li>ç”¨æˆ·æ‰‹åŠ¨å…³é—­ SQLite æŒä¹…åŒ–</li>
      <li>SQLite åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨å›é€€</li>
    </ul>
  </div>

  <div class="section">
    <h2>ğŸ¯ æœ€ç»ˆç»“è®º</h2>
    <div class="summary">
      <h3 class="success">âœ… æ–°ç‰ˆå­˜å‚¨æ–¹æ¡ˆå·²æ­£ç¡®å®ç°å¹¶åœ¨ä½¿ç”¨ä¸­</h3>
      <p><strong>éªŒè¯è¦ç‚¹:</strong></p>
      <ul>
        <li>âœ… å¯¼å…¥ sqliteChatPersistence ç±»</li>
        <li>âœ… å®ç° shouldUseSqlitePersistence å¼€å…³</li>
        <li>âœ… saveConversations() ä¸­æœ‰å®Œæ•´çš„ SQLite åˆ†æ”¯</li>
        <li>âœ… å®é™…è°ƒç”¨ sqliteChatPersistence çš„æ–¹æ³•</li>
        <li>âœ… SqliteChatPersistence ç±»å®Œæ•´å®ç°</li>
        <li>âœ… å¢é‡ä¿å­˜æœºåˆ¶å·¥ä½œæ­£å¸¸</li>
        <li>âœ… æä¾›å›é€€æ–¹æ¡ˆä¿è¯å…¼å®¹æ€§</li>
      </ul>
      <p><strong>ä½¿ç”¨å»ºè®®:</strong></p>
      <ul>
        <li>ğŸ‰ åœ¨ Electron ç¯å¢ƒä¸­ï¼ŒSQLite æŒä¹…åŒ–é»˜è®¤å¯ç”¨</li>
        <li>ğŸ‰ æ— éœ€é¢å¤–é…ç½®ï¼Œå¼€ç®±å³ç”¨</li>
        <li>ğŸ”§ å¦‚éœ€åˆ‡æ¢ï¼Œå¯åœ¨åº”ç”¨ä¸­è°ƒæ•´ <span class="code">useSqlitePersistence</span> è®¾ç½®</li>
      </ul>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ“ ç›¸å…³æ–‡æ¡£</h2>
    <ul>
      <li><span class="code">docs/CHUNKED_SAVE_IMPLEMENTATION.md</span> - åˆ†ç‰‡ä¿å­˜æœºåˆ¶æ–‡æ¡£</li>
      <li><span class="code">docs/SQLITE_ENHANCEMENT_IMPLEMENTATION.md</span> - SQLite å¢å¼ºå®ç°</li>
      <li><span class="code">docs/SAVE_OPTIMIZATION_SUMMARY.md</span> - ä¿å­˜ä¼˜åŒ–æ€»ç»“</li>
      <li><span class="code">src/services/chatPersistence.ts</span> - SQLite æŒä¹…åŒ–å®ç°</li>
      <li><span class="code">src/stores/chatStore.js</span> - èŠå¤©çŠ¶æ€ç®¡ç†</li>
    </ul>
  </div>

  <footer style="text-align: center; margin-top: 40px; color: #666; padding: 20px; border-top: 1px solid #ddd;">
    <p>æ£€æŸ¥æ—¶é—´: <script>document.write(new Date().toLocaleString('zh-CN'))</script></p>
    <p>Starverse é¡¹ç›® - èŠå¤©å­˜å‚¨æ–¹æ¡ˆéªŒè¯æŠ¥å‘Š</p>
  </footer>
</body>
</html>
