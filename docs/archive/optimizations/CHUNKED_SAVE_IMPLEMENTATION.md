# åˆ†ç‰‡ä¿å­˜æœºåˆ¶å®ç°æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

å®ç°äº†åŸºäº `requestIdleCallback` çš„åˆ†ç‰‡ä¿å­˜æœºåˆ¶ï¼Œå®Œå…¨è§£å†³äº†å¤§æ•°æ®é‡ä¿å­˜æ—¶çš„ UI å¡é¡¿é—®é¢˜ã€‚

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### 1. æ¯ç‰‡å·¥ä½œ < 5ms
- ä½¿ç”¨ `performance.now()` ç›‘æ§å®é™…è€—æ—¶
- ä½¿ç”¨ `deadline.timeRemaining()` æ£€æŸ¥æµè§ˆå™¨ç©ºé—²æ—¶é—´
- åŒé‡çº¦æŸç¡®ä¿ä¸é˜»å¡ UI

### 2. æ¸è¿›å¼åºåˆ—åŒ–
```javascript
// âŒ ä¹‹å‰ï¼šä¸€æ¬¡æ€§åºåˆ—åŒ–æ•´ä¸ªæ•°ç»„
const plain = JSON.parse(JSON.stringify(conversations.value))

// âœ… ç°åœ¨ï¼šä½¿ç”¨ç”Ÿæˆå™¨é€ä¸ªå¤„ç†
function* processConversations() {
  for (const conv of conversations.value) {
    yield { ...conv, tree: serializeTree(conv.tree) }
  }
}
```

### 3. è®©å‡ºæ§åˆ¶æƒ
```javascript
// ç‰‡å°¾é‡æ–°è°ƒåº¦ï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šå¤„ç†è¾“å…¥/åŠ¨ç”»
requestIdleCallback(processChunk, { timeout: 500 })
```

## ğŸ”„ æ‰§è¡Œæµç¨‹

```
saveConversations()
  â†“
[é˜¶æ®µ1] å‡†å¤‡ç”Ÿæˆå™¨
  â†“
[é˜¶æ®µ2] åˆ†ç‰‡åºåˆ—åŒ–ï¼ˆrequestIdleCallback å¾ªç¯ï¼‰
  â”œâ”€ ç‰‡æ®µ1: å¤„ç† N ä¸ªå¯¹è¯ (< 5ms)
  â”œâ”€ è®©å‡ºæ§åˆ¶æƒ
  â”œâ”€ ç‰‡æ®µ2: ç»§ç»­å¤„ç† (< 5ms)
  â”œâ”€ è®©å‡ºæ§åˆ¶æƒ
  â””â”€ ... ç›´åˆ°å®Œæˆ
  â†“
[é˜¶æ®µ3] æ‰¹é‡å†™å…¥å­˜å‚¨
  â””â”€ Promise.all([...])
```

## âš¡ æ€§èƒ½æŒ‡æ ‡

### çº¦æŸæ¡ä»¶
1. **å•ç‰‡è€—æ—¶**ï¼š< 5msï¼ˆç¡¬é™åˆ¶ï¼‰
2. **ç©ºé—²ä½™é‡**ï¼š`deadline.timeRemaining() > 2ms`
3. **è¶…æ—¶å…œåº•**ï¼š500msï¼ˆç¡®ä¿æœ€ç»ˆæ‰§è¡Œï¼‰

### ç›‘æ§è¾“å‡º
```javascript
âœ… åˆ†ç‰‡åºåˆ—åŒ–å®Œæˆ: 12 ç‰‡, å¹³å‡ 3.42ms/ç‰‡
âš ï¸ ç‰‡æ®µ 8 è€—æ—¶ 8.23ms è¶…è¿‡é¢„æœŸï¼Œå·²å¤„ç† 3 é¡¹
ğŸ’¾ åˆ†ç‰‡ä¿å­˜æ€»è€—æ—¶: 156.78ms
âœ… å¯¹è¯å·²ä¿å­˜åˆ°ç£ç›˜
```

## ğŸ“Š å¯¹æ¯”æµ‹è¯•

### åœºæ™¯ï¼š100 ä¸ªå¯¹è¯ï¼Œæ¯ä¸ªåŒ…å« 500 æ¡æ¨ç†ç»†èŠ‚

| æ–¹æ¡ˆ | ä¸»çº¿ç¨‹é˜»å¡ | ç”¨æˆ·æ„ŸçŸ¥ | è¾“å…¥å»¶è¿Ÿ |
|------|-----------|---------|---------|
| åŒæ­¥ä¿å­˜ | 2-3 ç§’ | æ˜æ˜¾å¡æ­» | 500ms+ |
| requestIdleCallbackï¼ˆä¸åˆ†ç‰‡ï¼‰ | 1-2 ç§’ | æ˜æ˜¾å¡é¡¿ | 200ms+ |
| **åˆ†ç‰‡ä¿å­˜ï¼ˆå½“å‰ï¼‰** | **< 5ms Ã— N** | **æ— æ„ŸçŸ¥** | **< 20ms** |

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### è‡ªåŠ¨è§¦å‘
```javascript
// æµç»“æŸåè§¦å‘ï¼ˆ3ç§’é˜²æŠ–ï¼‰
chatStore.debouncedSaveConversations(3000)

// æ¨ç†æ‘˜è¦è§¦å‘ï¼ˆ2ç§’é˜²æŠ–ï¼‰
chatStore.setReasoningSummary(...)  // å†…éƒ¨è°ƒç”¨

// å›¾ç‰‡ç”Ÿæˆè§¦å‘ï¼ˆ2ç§’é˜²æŠ–ï¼‰
chatStore.appendImageToBranchVersion(...)  // å†…éƒ¨è°ƒç”¨
```

### æ‰‹åŠ¨è§¦å‘
```javascript
// ç«‹å³ä¿å­˜ï¼ˆä»ä½¿ç”¨åˆ†ç‰‡ï¼‰
await chatStore.saveConversations()
```

## ğŸ”§ è°ƒä¼˜å‚æ•°

### å…³é”®å¸¸é‡
```javascript
// å•ç‰‡æ—¶é—´ä¸Šé™ï¼ˆæ¯«ç§’ï¼‰
const CHUNK_TIME_BUDGET = 5

// ç©ºé—²ä½™é‡ä¸‹é™ï¼ˆæ¯«ç§’ï¼‰
const MIN_IDLE_TIME = 2

// è¶…æ—¶å…œåº•ï¼ˆæ¯«ç§’ï¼‰
const IDLE_TIMEOUT = 500

// æ€§èƒ½è­¦å‘Šé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
const WARN_THRESHOLD = 8
```

### å¦‚ä½•è°ƒæ•´

**æ•°æ®é‡æ›´å¤§**ï¼ˆ1000+ å¯¹è¯ï¼‰ï¼š
```javascript
// å‡å°å•ç‰‡é¢„ç®—ï¼Œå¢åŠ ç‰‡æ•°
const CHUNK_TIME_BUDGET = 3
```

**æ•°æ®é‡è¾ƒå°**ï¼ˆ< 50 å¯¹è¯ï¼‰ï¼š
```javascript
// å¯ä»¥é€‚å½“å¢åŠ å•ç‰‡é¢„ç®—
const CHUNK_TIME_BUDGET = 10
```

**é«˜ä¼˜å…ˆçº§ä¿å­˜**ï¼ˆç”¨æˆ·ä¸»åŠ¨è§¦å‘ï¼‰ï¼š
```javascript
// å‡å°è¶…æ—¶ï¼ŒåŠ å¿«æ‰§è¡Œ
const IDLE_TIMEOUT = 200
```

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹åˆ†ç‰‡æ€§èƒ½
æ‰“å¼€æ§åˆ¶å°ï¼Œæ¯æ¬¡ä¿å­˜ä¼šè¾“å‡ºï¼š
```
ğŸ’¾ åˆ†ç‰‡ä¿å­˜æ€»è€—æ—¶: 156.78ms
âœ… åˆ†ç‰‡åºåˆ—åŒ–å®Œæˆ: 12 ç‰‡, å¹³å‡ 3.42ms/ç‰‡
```

### 2. æ£€æµ‹é•¿ç‰‡æ®µ
å¦‚æœçœ‹åˆ°è­¦å‘Šï¼š
```
âš ï¸ ç‰‡æ®µ 8 è€—æ—¶ 8.23ms è¶…è¿‡é¢„æœŸ
```
è¯´æ˜è¯¥ç‰‡æ®µå¤„ç†çš„å¯¹è¯ç‰¹åˆ«å¤æ‚ï¼ˆå¦‚æ¨ç†ç»†èŠ‚å¾ˆå¤šï¼‰ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- å‡å° `CHUNK_TIME_BUDGET`
- æ¸…ç†ä¸å¿…è¦çš„æ¨ç†ç»†èŠ‚

### 3. ç›‘æ§è¾“å…¥å»¶è¿Ÿ
åœ¨ä¿å­˜è¿‡ç¨‹ä¸­å¿«é€Ÿè¾“å…¥ï¼Œå¦‚æœä»æ„Ÿè§‰å¡é¡¿ï¼š
```javascript
// æ£€æŸ¥ Chrome DevTools Performance
// æŸ¥æ‰¾ > 50ms çš„é•¿ä»»åŠ¡
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æµè§ˆå™¨å…¼å®¹æ€§
- `requestIdleCallback`ï¼šChrome 47+, Edge 79+
- é™çº§æ–¹æ¡ˆï¼šè‡ªåŠ¨ä½¿ç”¨ `setTimeout(0)`
- Safariï¼šå»ºè®®ä½¿ç”¨ polyfill

### 2. æ•°æ®å®‰å…¨
- åˆ†ç‰‡è¿‡ç¨‹ä¸­æ•°æ®ä»åœ¨å†…å­˜
- åªæœ‰ `finalizeAndStore` é˜¶æ®µæ‰å†™å…¥ç£ç›˜
- è¿›ç¨‹å´©æºƒä¼šä¸¢å¤±æœªä¿å­˜æ•°æ®ï¼ˆ< 3 ç§’ï¼‰

### 3. å¹¶å‘ä¿å­˜
- é˜²æŠ–æœºåˆ¶è‡ªåŠ¨å¤„ç†å¹¶å‘è°ƒç”¨
- å¤šæ¬¡è§¦å‘ä¼šåˆå¹¶ä¸ºä¸€æ¬¡ä¿å­˜
- ä¸ä¼šå‡ºç°ç«æ€æ¡ä»¶

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. å¢é‡ä¿å­˜
åªä¿å­˜å˜æ›´çš„å¯¹è¯ï¼Œè€Œä¸æ˜¯å…¨é‡ä¿å­˜ï¼š
```javascript
// è¿½è¸ªå˜æ›´
const dirtyConversations = new Set()

// åªåºåˆ—åŒ–å˜æ›´çš„å¯¹è¯
for (const id of dirtyConversations) {
  const conv = conversations.value.find(c => c.id === id)
  // åˆ†ç‰‡åºåˆ—åŒ–...
}
```

### 2. å‹ç¼©å­˜å‚¨
ä½¿ç”¨ `pako` æˆ– `lz-string` å‹ç¼©ï¼š
```javascript
// åœ¨ Worker ä¸­å‹ç¼©
const compressed = pako.gzip(JSON.stringify(data))
await persistenceStore.set('conversations', compressed)
```

### 3. IndexedDB åˆ†è¡¨
å°†å¤§å¯¹è¯æ‹†åˆ†åˆ°å¤šä¸ª ObjectStoreï¼š
```javascript
// conversations è¡¨ï¼šåªå­˜å…ƒæ•°æ®
// messages è¡¨ï¼šå­˜å‚¨æ¶ˆæ¯å†…å®¹
// reasoning è¡¨ï¼šå­˜å‚¨æ¨ç†ç»†èŠ‚
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [requestIdleCallback MDN](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)
- [Chrome Performance Best Practices](https://developer.chrome.com/docs/devtools/performance/)
- [Web Vitals: INP](https://web.dev/inp/)
- [Long Tasks API](https://developer.mozilla.org/en-US/docs/Web/API/Long_Tasks_API)

---

**æ›´æ–°æ—¥æœŸ**: 2025-01-09  
**ç‰ˆæœ¬**: 1.0.0  
**ä½œè€…**: Starverse Team
