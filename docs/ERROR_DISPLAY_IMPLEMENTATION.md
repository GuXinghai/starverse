# OpenRouter é”™è¯¯ä¿¡æ¯å±•ç¤ºå®ç°å®Œæˆ âœ…

## ğŸ“‹ å®ç°æ¦‚è¿°

æ ¹æ® OpenRouter å®˜æ–¹é”™è¯¯ç å¯¹ç…§æ–‡æ¡£ï¼Œå®Œå–„äº†æ¶ˆæ¯æµä¸­çš„é”™è¯¯è¿”å›æ˜¾ç¤ºåŠŸèƒ½ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ¸…æ™°åœ°äº†è§£ API é”™è¯¯çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. **OpenRouterService.js - é”™è¯¯æ„å»ºå¢å¼º**

#### æ·»åŠ é”™è¯¯ç å¯¹ç…§è¡¨

åœ¨ `buildOpenRouterError` å‡½æ•°ä¸­æ·»åŠ äº†å®Œæ•´çš„ OpenRouter é”™è¯¯ç æ˜ å°„ï¼š

```javascript
const OPENROUTER_ERROR_MAP = {
  400: {
    name: 'Bad Request',
    officialMeaning: 'Bad Request (invalid or missing params, CORS)',
    typicalCauses: 'è¯·æ±‚ä½“ JSON éæ³•ï¼›ç¼ºå°‘å¿…å¡«å­—æ®µ...'
  },
  401: { ... },
  402: { ... },
  403: { ... },
  408: { ... },
  429: { ... },
  502: { ... },
  503: { ... }
}
```

#### å¢å¼ºé”™è¯¯å¯¹è±¡

é”™è¯¯å¯¹è±¡ç°åœ¨åŒ…å«ä»¥ä¸‹é™„åŠ ä¿¡æ¯ï¼š
- `statusName`: çŠ¶æ€ç åç§°ï¼ˆå¦‚ "Bad Request"ï¼‰
- `officialMeaning`: å®˜æ–¹é”™è¯¯å«ä¹‰
- `typicalCauses`: å…¸å‹è§¦å‘åŸå› ï¼ˆä¸­æ–‡è¯´æ˜ï¼‰
- `metadata`: å®Œæ•´çš„é”™è¯¯å…ƒæ•°æ®ï¼ˆå®¡æ ¸ä¿¡æ¯ã€ä¸Šæ¸¸é”™è¯¯ç­‰ï¼‰

### 2. **chat.ts - ç±»å‹å®šä¹‰æ‰©å±•**

æ‰©å±•äº† `MessageVersionMetadata` æ¥å£ï¼š

```typescript
export interface MessageVersionMetadata {
  // ç°æœ‰å­—æ®µ...
  errorStatusName?: string;           // é”™è¯¯çŠ¶æ€ç åç§°
  errorOfficialMeaning?: string;      // å®˜æ–¹é”™è¯¯å«ä¹‰
  errorTypicalCauses?: string;        // å…¸å‹è§¦å‘åŸå› 
  errorMetadata?: Record<string, any>; // é”™è¯¯å…ƒæ•°æ®
  // ...
}
```

### 3. **ChatView.vue - é”™è¯¯æ˜¾ç¤ºå¢å¼º**

#### æ›´æ–° `buildErrorMetadata` å‡½æ•°

å¢å¼ºäº†é”™è¯¯å…ƒæ•°æ®çš„æå–é€»è¾‘ï¼Œæ”¯æŒä»å¤šå±‚åµŒå¥—é”™è¯¯å¯¹è±¡ä¸­æå–ï¼š
- OpenRouter æ ‡å‡†é”™è¯¯ä¿¡æ¯
- é”™è¯¯å…ƒæ•°æ®ï¼ˆå¦‚å®¡æ ¸åŸå› ã€ä¸Šæ¸¸é”™è¯¯ç­‰ï¼‰

#### æ·»åŠ  `formatErrorDetails` å‡½æ•°

æ–°å¢çš„æ ¼å¼åŒ–å‡½æ•°æŒ‰ç…§æ–‡æ¡£è¦æ±‚çš„æ ¼å¼å¤„ç†é”™è¯¯ä¿¡æ¯ï¼š

```typescript
const formatErrorDetails = (metadata?: MessageVersionMetadata) => {
  // è¿”å›æ ¼å¼åŒ–åçš„é”™è¯¯è¯¦æƒ…å¯¹è±¡
  return {
    hasDetails: boolean,
    statusLine: string,        // "çŠ¶æ€ç ï¼š403 Forbiddenï¼Œ..."
    typicalCauses: string,     // å…¸å‹è§¦å‘åŸå› 
    message: string,           // åŸå§‹é”™è¯¯æ¶ˆæ¯
    metadataStr: string,       // JSON æ ¼å¼çš„å…ƒæ•°æ®
    retryable: boolean         // æ˜¯å¦å¯é‡è¯•
  }
}
```

#### æ·»åŠ é”™è¯¯ä¿¡æ¯å±•ç¤º UI

åœ¨æ¶ˆæ¯å†…å®¹åŒºåŸŸæ·»åŠ äº†ä¸“é—¨çš„é”™è¯¯ä¿¡æ¯å±•ç¤ºå—ï¼š

**å±•ç¤ºå†…å®¹ï¼š**
1. **çŠ¶æ€ç è¡Œ**: `çŠ¶æ€ç ï¼š<code> <åç§°>ï¼Œ<å®˜æ–¹å«ä¹‰>`
2. **å…¸å‹è§¦å‘åŸå› **: ä¸­æ–‡è§£é‡Šé”™è¯¯å‘ç”Ÿçš„å¸¸è§åŸå› 
3. **message**: åŸå§‹é”™è¯¯æ¶ˆæ¯ï¼ˆä¿æŒè‹±æ–‡åŸæ–‡ï¼‰
4. **metadata**: JSON æ ¼å¼çš„è¯¦ç»†å…ƒæ•°æ®
5. **é‡è¯•æç¤º**: å¦‚æœé”™è¯¯å¯é‡è¯•ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯

**æ ·å¼ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨çº¢è‰²ä¸»é¢˜ï¼ˆ`bg-red-50`, `border-red-200`ï¼‰åŒºåˆ†é”™è¯¯çŠ¶æ€
- ä½¿ç”¨ç­‰å®½å­—ä½“ï¼ˆ`font-mono`ï¼‰å±•ç¤ºåŸå§‹æ¶ˆæ¯å’Œ JSON
- åˆ†å±‚å±•ç¤ºï¼Œæ¸…æ™°çš„è§†è§‰å±‚æ¬¡
- å¯é‡è¯•é”™è¯¯æ˜¾ç¤ºé»„è‰²æç¤ºæ¡†

## ğŸ“ é”™è¯¯å±•ç¤ºæ ¼å¼ç¤ºä¾‹

### ç¤ºä¾‹ 1: 403 Forbiddenï¼ˆå†…å®¹å®¡æ ¸é”™è¯¯ï¼‰

```
âš ï¸ é”™è¯¯ä¿¡æ¯

çŠ¶æ€ç ï¼š403 Forbiddenï¼ŒYour chosen model requires moderation and your input was flagged

å…¸å‹è§¦å‘åŸå› ï¼š
æ‰€é€‰æ¨¡å‹å¯ç”¨äº†å†…å®¹å®¡æ ¸ï¼Œå½“å‰è¾“å…¥è¢«åˆ¤å®šè¿è§„ï¼›å¸¸è§äº Anthropic / OpenAI ç­‰å®‰å…¨ç­–ç•¥æ¯”è¾ƒä¸¥æ ¼çš„æ¨¡å‹ï¼›error.metadata ä¸­ä¼šåŒ…å« reasonsã€flagged_input ç­‰ä¿¡æ¯ã€‚

message:
Your chosen model requires moderation and your input was flagged

metadata:
{
  "reasons": ["sexual_content"],
  "flagged_input": "...",
  "provider_name": "moderation",
  "model_slug": "anthropic/claude-3.5-sonnet"
}
```

### ç¤ºä¾‹ 2: 429 Too Many Requestsï¼ˆé™æµé”™è¯¯ï¼‰

```
âš ï¸ é”™è¯¯ä¿¡æ¯

çŠ¶æ€ç ï¼š429 Too Many Requestsï¼ŒYou are being rate limited

å…¸å‹è§¦å‘åŸå› ï¼š
å‘½ä¸­ OpenRouter çš„è¯·æ±‚é¢‘ç‡é™åˆ¶æˆ– DDoS é˜²æŠ¤ï¼›å…è´¹ :free æ¨¡å‹æœ‰åˆ†é’Ÿ / æ—¥è°ƒç”¨ä¸Šé™ï¼›ä¹Ÿå¯èƒ½æ˜¯ credits å¾ˆå°‘ä½†çŸ­æ—¶é—´å†…è¯·æ±‚è¿‡äºå¯†é›†ã€‚

message:
OpenRouter é€Ÿç‡é™åˆ¶ï¼šè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… 60 ç§’åé‡è¯•

âš ï¸ æ­¤é”™è¯¯å¯ä»¥é‡è¯•ï¼Œè¯·ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
```

### ç¤ºä¾‹ 3: 402 Payment Requiredï¼ˆä½™é¢ä¸è¶³ï¼‰

```
âš ï¸ é”™è¯¯ä¿¡æ¯

çŠ¶æ€ç ï¼š402 Payment Requiredï¼ŒYour account or API key has insufficient credits. Add more credits and retry the request.

å…¸å‹è§¦å‘åŸå› ï¼š
è´¦æˆ·æˆ–å½“å‰ API Key å¯ç”¨ credits ä¸è¶³ï¼ˆåŒ…æ‹¬å…è´¹é¢å·²ç”¨å®Œï¼‰ï¼›å³ä¾¿æ˜¯ :free ç»“å°¾çš„å…è´¹çš„æ¨¡å‹ï¼Œå½“è´¦æˆ·æ•´ä½“ä¸ºè´Ÿä½™é¢æ—¶ä¹Ÿå¯èƒ½è¿”å› 402ã€‚

message:
Your account or API key has insufficient credits. Add more credits and retry the request.
```

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### é”™è¯¯ä¿¡æ¯æµè½¬è·¯å¾„

1. **OpenRouter API è¿”å›é”™è¯¯** â†’ HTTP çŠ¶æ€ç  + JSON å“åº”ä½“
2. **OpenRouterService.js è§£æ** â†’ è°ƒç”¨ `buildOpenRouterError` æ„å»ºç»“æ„åŒ–é”™è¯¯å¯¹è±¡
3. **ChatView.vue æ•è·é”™è¯¯** â†’ è°ƒç”¨ `buildErrorMetadata` æå–å…ƒæ•°æ®
4. **ä¿å­˜åˆ° Store** â†’ é”™è¯¯å…ƒæ•°æ®é™„åŠ åˆ°æ¶ˆæ¯ç‰ˆæœ¬çš„ `metadata` å­—æ®µ
5. **UI æ¸²æŸ“** â†’ è°ƒç”¨ `formatErrorDetails` æ ¼å¼åŒ–å¹¶å±•ç¤º

### å‘åå…¼å®¹æ€§

- âœ… ç°æœ‰é”™è¯¯å¤„ç†é€»è¾‘ä¿æŒä¸å˜
- âœ… ä»…åœ¨æœ‰æ–°å¢é”™è¯¯ä¿¡æ¯æ—¶æ‰å±•ç¤ºå¢å¼ºçš„é”™è¯¯è¯¦æƒ…
- âœ… æ—§ç‰ˆæœ¬çš„é”™è¯¯æ¶ˆæ¯ä»èƒ½æ­£å¸¸æ˜¾ç¤º

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨è®¡ç®—å±æ€§ç¼“å­˜æ ¼å¼åŒ–ç»“æœ
- ä»…åœ¨é”™è¯¯æ¶ˆæ¯ä¸Šæ‰§è¡Œæ ¼å¼åŒ–é€»è¾‘
- JSON åºåˆ—åŒ–é”™è¯¯æ—¶é™çº§ä¸ºå­—ç¬¦ä¸²å±•ç¤º

## âœ… éªŒè¯æ¸…å•

- [x] OpenRouter 8 ç§æ ‡å‡†é”™è¯¯ç å…¨éƒ¨æ”¯æŒï¼ˆ400/401/402/403/408/429/502/503ï¼‰
- [x] é”™è¯¯ä¿¡æ¯åŒ…å«ä¸­æ–‡è§£é‡Šï¼ˆå…¸å‹è§¦å‘åŸå› ï¼‰
- [x] ä¿ç•™åŸå§‹è‹±æ–‡æ¶ˆæ¯å’Œå…ƒæ•°æ®
- [x] UI æ¸…æ™°åŒºåˆ†é”™è¯¯çŠ¶æ€ï¼ˆçº¢è‰²ä¸»é¢˜ï¼‰
- [x] æ”¯æŒå¯é‡è¯•é”™è¯¯çš„æç¤º
- [x] ç±»å‹å®‰å…¨ï¼ˆTypeScript å®Œæ•´ç±»å‹å®šä¹‰ï¼‰
- [x] å‘åå…¼å®¹æ—§ç‰ˆæœ¬é”™è¯¯å¤„ç†
- [x] æ— ç¼–è¯‘é”™è¯¯

## ğŸ“š ç›¸å…³æ–‡æ¡£

- OpenRouter å®˜æ–¹é”™è¯¯ç æ–‡æ¡£ï¼ˆç”¨æˆ·æä¾›ï¼‰
- `MessageVersionMetadata` ç±»å‹å®šä¹‰: `src/types/chat.ts`
- é”™è¯¯æ„å»ºå‡½æ•°: `src/services/providers/OpenRouterService.js`
- é”™è¯¯å±•ç¤ºé€»è¾‘: `src/components/ChatView.vue`

## ğŸ¨ UI æˆªå›¾ä½ç½®

é”™è¯¯ä¿¡æ¯å±•ç¤ºä½ç½®ï¼š
- åœ¨æ¨ç†ç»†èŠ‚åŒºåŸŸï¼ˆå¦‚æœ‰ï¼‰ä¹‹å
- åœ¨æ¶ˆæ¯æ­£æ–‡å†…å®¹ä¹‹å‰
- ä»…åœ¨ AI å›å¤æ¶ˆæ¯ä¸­æ˜¾ç¤º
- ä»…åœ¨åŒ…å«é”™è¯¯å…ƒæ•°æ®æ—¶æ˜¾ç¤º

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **é”™è¯¯æ—¥å¿—è®°å½•**: å°†è¯¦ç»†é”™è¯¯ä¿¡æ¯è®°å½•åˆ°æœ¬åœ°æ—¥å¿—ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥
2. **é”™è¯¯ç»Ÿè®¡**: ç»Ÿè®¡å¸¸è§é”™è¯¯ç±»å‹ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
3. **æ™ºèƒ½å»ºè®®**: æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“çš„è§£å†³å»ºè®®ï¼ˆå¦‚ä½™é¢ä¸è¶³æ—¶å¼•å¯¼å……å€¼ï¼‰
4. **é”™è¯¯é‡è¯•ç­–ç•¥**: å¯¹äºå¯é‡è¯•çš„é”™è¯¯ï¼Œå®ç°è‡ªåŠ¨é‡è¯•æœºåˆ¶
5. **é”™è¯¯é€šçŸ¥**: é‡è¦é”™è¯¯ï¼ˆå¦‚è®¤è¯å¤±è´¥ï¼‰æ˜¾ç¤ºå…¨å±€é€šçŸ¥
