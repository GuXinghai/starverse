# Starverse æ¶æ„æ€»è§ˆ

> **æœ€åæ›´æ–°**: 2025å¹´12æœˆ3æ—¥  
> **æ¶æ„ç‰ˆæœ¬**: 1.0.0

---

## ğŸ¯ è®¾è®¡ç†å¿µ

Starverse é‡‡ç”¨**ä¸‰å±‚åˆ†ç¦»æ¶æ„**ï¼Œç»“åˆ Electron çš„å®‰å…¨æœ€ä½³å®è·µå’Œç°ä»£å‰ç«¯å¼€å‘æ¨¡å¼ï¼š

- **è¿›ç¨‹éš”ç¦»**: æ¸²æŸ“è¿›ç¨‹ã€ä¸»è¿›ç¨‹ã€Worker çº¿ç¨‹èŒè´£æ¸…æ™°
- **ç±»å‹å®‰å…¨**: TypeScript ä¸¥æ ¼æ¨¡å¼ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- **æ¨¡å—åŒ–**: Pinia Store + Repository æ¨¡å¼ï¼ŒèŒè´£å•ä¸€
- **æ€§èƒ½ä¼˜å…ˆ**: Worker çº¿ç¨‹æ•°æ®åº“æ“ä½œï¼Œé˜²æŠ–æŒä¹…åŒ–ï¼Œè™šæ‹Ÿæ»šåŠ¨

---

## ğŸ—ï¸ ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸²æŸ“è¿›ç¨‹ (Renderer Process) - src/                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Vue 3 UI   â”‚  â”‚ Pinia Stores â”‚  â”‚  Services    â”‚       â”‚
â”‚  â”‚  Components  â”‚â”€â”€â”‚  7ä¸ªæ¨¡å—åŒ–   â”‚â”€â”€â”‚  AI/DB/æœç´¢  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    IPC Bridge (preload.ts)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»è¿›ç¨‹ (Main Process) - electron/                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ åº”ç”¨ç”Ÿå‘½å‘¨æœŸ  â”‚  â”‚  IPC Handler â”‚  â”‚ Workerç®¡ç†å™¨  â”‚        â”‚
â”‚  â”‚  çª—å£æ§åˆ¶    â”‚â”€â”€â”‚  dbBridge    â”‚â”€â”€â”‚ çº¿ç¨‹æ± è°ƒåº¦    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                  â”‚                  â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    MessagePort é€šä¿¡
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker çº¿ç¨‹ (Worker Threads) - infra/db/                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ SQLite æ“ä½œ  â”‚  â”‚  Repository  â”‚  â”‚  FTS5 æœç´¢   â”‚        â”‚
â”‚  â”‚ better-sqliteâ”‚â”€â”€â”‚   æ•°æ®è®¿é—®   â”‚â”€â”€â”‚  å…¨æ–‡æ£€ç´¢    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

### æ¸²æŸ“è¿›ç¨‹ (src/)

```
src/
â”œâ”€â”€ components/              # Vue 3 ç»„ä»¶
â”‚   â”œâ”€â”€ atoms/               # åŸå­ç»„ä»¶ï¼ˆæŒ‰é’®ã€è¾“å…¥æ¡†ï¼‰
â”‚   â”œâ”€â”€ molecules/           # åˆ†å­ç»„ä»¶ï¼ˆå¤åˆæ§ä»¶ï¼Œé¢„ç•™ï¼‰
â”‚   â”œâ”€â”€ organisms/           # æœ‰æœºç»„ä»¶ï¼ˆåŠŸèƒ½æ¨¡å—ï¼Œé¢„ç•™ï¼‰
â”‚   â”œâ”€â”€ templates/           # é¡µé¢æ¨¡æ¿
â”‚   â”œâ”€â”€ chat/                # èŠå¤©å­ç³»ç»Ÿï¼ˆæ ¸å¿ƒåŠŸèƒ½åŒºï¼‰
â”‚   â”‚   â”œâ”€â”€ MessageList.vue
â”‚   â”‚   â”œâ”€â”€ ChatInput.vue
â”‚   â”‚   â”œâ”€â”€ MessageBranchController.vue
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ ChatView.vue         # ä¸»èŠå¤©ç•Œé¢ï¼ˆ5422è¡Œï¼Œæ ¸å¿ƒç»„ä»¶ï¼‰
â”‚   â”œâ”€â”€ TabbedChatView.vue   # å¤šæ ‡ç­¾é¡µç®¡ç†
â”‚   â”œâ”€â”€ ConversationList.vue # å¯¹è¯åˆ—è¡¨ä¸æœç´¢
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ stores/                  # Pinia çŠ¶æ€ç®¡ç†ï¼ˆ7ä¸ªæ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ index.ts             # useAppStore - å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ useConversationStore.ts  # å¯¹è¯ CRUD
â”‚   â”œâ”€â”€ useBranchStore.ts    # åˆ†æ”¯æ ‘ç®¡ç†
â”‚   â”œâ”€â”€ useModelStore.ts     # æ¨¡å‹é€‰æ‹©ä¸é…ç½®
â”‚   â”œâ”€â”€ usePersistenceStore.ts  # æŒä¹…åŒ–è°ƒåº¦
â”‚   â”œâ”€â”€ useProjectStore.ts   # é¡¹ç›®åˆ†ç±»
â”‚   â””â”€â”€ useProjectWorkspaceStore.ts  # é¡¹ç›®å·¥ä½œåŒº
â”‚
â”œâ”€â”€ composables/             # Vue ç»„åˆå¼å‡½æ•°ï¼ˆ10+ä¸ªï¼‰
â”‚   â”œâ”€â”€ useBranchNavigation.ts  # åˆ†æ”¯å¯¼èˆªé€»è¾‘
â”‚   â”œâ”€â”€ useMessageSending.ts    # æ¶ˆæ¯å‘é€é€»è¾‘
â”‚   â”œâ”€â”€ useScrollControl.ts     # æ»šåŠ¨æ§åˆ¶
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/                # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ aiChatService.js     # AI æœåŠ¡è·¯ç”±å™¨
â”‚   â”œâ”€â”€ providers/           # AI æä¾›å•†å®ç°
â”‚   â”‚   â”œâ”€â”€ GeminiService.js
â”‚   â”‚   â””â”€â”€ OpenRouterService.js
â”‚   â”œâ”€â”€ chatPersistence.ts   # èŠå¤©æŒä¹…åŒ–
â”‚   â”œâ”€â”€ searchService.ts     # æœç´¢æœåŠ¡ + DSL
â”‚   â””â”€â”€ db/                  # æ•°æ®åº“å®¢æˆ·ç«¯å°è£…ï¼ˆIPCè°ƒç”¨ï¼‰
â”‚
â”œâ”€â”€ types/                   # TypeScript ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ chat.ts, conversation.ts, store.ts
â”‚   â””â”€â”€ electron.d.ts        # Electron API ç±»å‹å£°æ˜
â”‚
â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°
    â”œâ”€â”€ electronBridge.ts    # Electron API æ¡¥æ¥
    â””â”€â”€ ipcSanitizer.js      # IPC æ•°æ®æ¸…ç†ï¼ˆç§»é™¤Vue Proxyï¼‰
```

### ä¸»è¿›ç¨‹ (electron/)

```
electron/
â”œâ”€â”€ main.ts                  # åº”ç”¨å…¥å£ï¼Œçª—å£åˆ›å»º
â”œâ”€â”€ preload.ts               # contextBridge API æš´éœ²
â”‚
â”œâ”€â”€ db/                      # æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ workerManager.ts     # Worker ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â””â”€â”€ worker.ts            # Worker çº¿ç¨‹å…¥å£
â”‚
â”œâ”€â”€ ipc/                     # IPC é€šä¿¡å±‚
â”‚   â”œâ”€â”€ dbBridge.ts          # æ•°æ®åº“ IPC Handler
â”‚   â””â”€â”€ openRouterBridge.ts  # æµå¼ AI å“åº” IPC Handler
â”‚
â”œâ”€â”€ services/                # ä¸»è¿›ç¨‹æœåŠ¡
â”‚   â””â”€â”€ inappBrowser.ts      # åº”ç”¨å†…æµè§ˆå™¨æœåŠ¡
â”‚
â””â”€â”€ types/                   # ä¸»è¿›ç¨‹ TypeScript ç±»å‹
```

### åŸºç¡€è®¾æ–½å±‚ (infra/)

```
infra/
â””â”€â”€ db/                      # æ•°æ®åº“åŸºç¡€è®¾æ–½
    â”œâ”€â”€ worker.ts            # Worker çº¿ç¨‹æ•°æ®åº“æ“ä½œå®ç°
    â”œâ”€â”€ schema.sql           # æ•°æ®åº“ Schemaï¼ˆFTS5è™šæ‹Ÿè¡¨ï¼‰
    â”œâ”€â”€ types.ts             # æ•°æ®åº“ç±»å‹å®šä¹‰
    â”œâ”€â”€ validation.ts        # æ•°æ®éªŒè¯
    â”œâ”€â”€ errors.ts            # é”™è¯¯å®šä¹‰
    â””â”€â”€ repo/                # Repository æ¨¡å¼æ•°æ®è®¿é—®å±‚
        â”œâ”€â”€ convoRepo.ts     # å¯¹è¯å¢åˆ æ”¹æŸ¥
        â”œâ”€â”€ messageRepo.ts   # æ¶ˆæ¯å­˜å‚¨ + åˆ†æ”¯å…³ç³»
        â”œâ”€â”€ projectRepo.ts   # é¡¹ç›®å…ƒæ•°æ®ç®¡ç†
        â””â”€â”€ searchRepo.ts    # FTS5 å…¨æ–‡æœç´¢
```

---

## ğŸ”‘ æ ¸å¿ƒè®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ Worker çº¿ç¨‹ï¼Ÿ

**é—®é¢˜**: SQLite åŒæ­¥æ“ä½œä¼šé˜»å¡ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹çš„äº‹ä»¶å¾ªç¯

**è§£å†³æ–¹æ¡ˆ**: 
- æ•°æ®åº“æ“ä½œåœ¨ç‹¬ç«‹çš„ Worker çº¿ç¨‹æ‰§è¡Œ
- é€šè¿‡ `MessagePort` ä¸ä¸»è¿›ç¨‹é€šä¿¡
- æ¸²æŸ“è¿›ç¨‹é€šè¿‡ IPC é—´æ¥è°ƒç”¨ Worker

**æ•ˆæœ**: UI å§‹ç»ˆæµç•…ï¼Œå³ä½¿æ‰§è¡Œå¤§é‡æ•°æ®åº“æ“ä½œ

è¯¦è§: [å†³ç­–è®°å½• - ä¸ºä»€ä¹ˆä½¿ç”¨ SQLite Worker çº¿ç¨‹](../decisions/003-sqlite-worker.md)

---

### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ Pinia æ¨¡å—åŒ– Storeï¼Ÿ

**é—®é¢˜**: å•ä¸ªå·¨å‹ Storeï¼ˆ2500+ è¡Œï¼‰éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**:
- æ‹†åˆ†ä¸º 7 ä¸ªèŒè´£å•ä¸€çš„ Store
- Store é—´é€šè¿‡ `import` ç›´æ¥è°ƒç”¨ï¼Œé¿å…äº‹ä»¶æ€»çº¿
- ä½¿ç”¨ `computed` è€Œé `getters`ï¼ˆComposition API é£æ ¼ï¼‰

**Store èŒè´£åˆ’åˆ†**:
```
useAppStore          â†’ å…¨å±€é…ç½®ï¼ˆAPI Keyã€Providerã€ä¸»é¢˜ï¼‰
  â”œâ”€ useConversationStore â†’ å¯¹è¯ CRUD + å¤šæ ‡ç­¾é¡µ
  â”‚    â””â”€ useBranchStore  â†’ åˆ†æ”¯æ ‘çŠ¶æ€ï¼ˆç‰ˆæœ¬åˆ‡æ¢ã€è·¯å¾„è®¡ç®—ï¼‰
  â”œâ”€ useModelStore        â†’ æ¨¡å‹é€‰æ‹© + å‚æ•°é…ç½®
  â”œâ”€ usePersistenceStore  â†’ æŒä¹…åŒ–è°ƒåº¦å™¨ï¼ˆé˜²æŠ–ä¿å­˜ï¼‰
  â”œâ”€ useProjectStore      â†’ é¡¹ç›®åˆ†ç±»ç®¡ç†
  â””â”€ useProjectWorkspaceStore â†’ é¡¹ç›®å·¥ä½œåŒºçŠ¶æ€
```

---

### 3. ä¸ºä»€ä¹ˆä½¿ç”¨ Repository æ¨¡å¼ï¼Ÿ

**é—®é¢˜**: ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®åº“å®ç°è€¦åˆï¼Œéš¾ä»¥å•å…ƒæµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**:
- `infra/db/repo/` æä¾›ç‹¬ç«‹çš„æ•°æ®è®¿é—®å±‚
- Repository ä¸ Electron è§£è€¦ï¼Œå¯åœ¨ Node.js ç¯å¢ƒæµ‹è¯•
- ä¸šåŠ¡ä»£ç è°ƒç”¨ Repository æ–¹æ³•ï¼Œä¸ç›´æ¥å†™ SQL

**ç¤ºä¾‹**:
```typescript
// âŒ ä¸æ¨èï¼šç›´æ¥å†™ SQL
const result = await db.query('SELECT * FROM conversations WHERE id = ?', [id])

// âœ… æ¨èï¼šä½¿ç”¨ Repository
import { convoRepo } from '@/infra/db/repo'
const conversation = await convoRepo.getById(id)
```

---

### 4. ä¸ºä»€ä¹ˆé‡‡ç”¨ç­–ç•¥æ¨¡å¼å®ç°å¤šæä¾›å•†ï¼Ÿ

**é—®é¢˜**: æ”¯æŒå¤šä¸ª AI æä¾›å•†ï¼ˆGemini, OpenRouterï¼‰ï¼Œéœ€çµæ´»åˆ‡æ¢

**è§£å†³æ–¹æ¡ˆ**:
- `aiChatService.js` ä½œä¸ºç»Ÿä¸€è·¯ç”±å™¨
- å„ Provider å®ç° `IAIProvider` æ¥å£
- æ ¹æ® `activeProvider` åŠ¨æ€è·¯ç”±

**æ¥å£å®šä¹‰**:
```typescript
interface IAIProvider {
  listAvailableModels(apiKey: string): Promise<Model[]>
  streamChatResponse(
    apiKey: string,
    history: Message[],
    model: string,
    userMessage: string,
    signal: AbortSignal
  ): AsyncGenerator<string>
}
```

è¯¦è§: [å†³ç­–è®°å½• - ä¸ºä»€ä¹ˆé‡‡ç”¨ç­–ç•¥æ¨¡å¼](../decisions/005-multi-provider.md)

---

## ğŸ“Š æ•°æ®æµ

### ç”¨æˆ·å‘é€æ¶ˆæ¯çš„å®Œæ•´æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ ModernChatInput.vue  
*æ³¨ï¼šChatInputArea.vue å·²å½’æ¡£*
    â†“
useChatInput.ts (composable)
    â†“ emit('send')
ChatView.vue â†’ performSendMessage()
    â†“
1. å‡†å¤‡ä¸Šä¸‹æ–‡ï¼ˆconversationId, generationTokenï¼‰
2. å‰ç½®æ£€æŸ¥ï¼ˆAPI Key, å¹¶å‘ç”Ÿæˆï¼‰
3. å›ºåŒ–æ¶ˆæ¯åˆ°æ•°æ®åº“
    â†“ IPC call
ä¸»è¿›ç¨‹ dbBridge â†’ Worker çº¿ç¨‹ â†’ SQLite INSERT
    â†“ MessagePort
è¿”å› messageId
    â†“
4. è°ƒç”¨ AI æœåŠ¡
aiChatService.streamChatResponse()
    â†“ æ ¹æ® activeProvider è·¯ç”±
GeminiService / OpenRouterService
    â†“ HTTP SSE æµå¼å“åº”
5. é€ token è¿½åŠ åˆ° UI
    â†“
6. æµå¼å“åº”ç»“æŸï¼Œæ›´æ–°æ•°æ®åº“
    â†“ IPC call
ä¸»è¿›ç¨‹ dbBridge â†’ Worker çº¿ç¨‹ â†’ SQLite UPDATE
    â†“
7. æŒä¹…åŒ–é˜²æŠ–è§¦å‘ï¼ˆ500msï¼‰
usePersistenceStore.scheduleSave()
    â†“ IPC call
ä¸»è¿›ç¨‹ dbBridge â†’ Worker çº¿ç¨‹ â†’ æ‰¹é‡ä¿å­˜
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### Electron å®‰å…¨é…ç½®

```typescript
// electron/main.ts
const mainWindow = new BrowserWindow({
  webPreferences: {
    contextIsolation: true,        // âœ… ä¸Šä¸‹æ–‡éš”ç¦»
    nodeIntegration: false,        // âœ… ç¦ç”¨ Node.js é›†æˆ
    webSecurity: true,             // âœ… å¯ç”¨ Web å®‰å…¨
    preload: path.join(__dirname, '../preload/index.js')
  }
})
```

### IPC ç™½åå•æœºåˆ¶

```typescript
// electron/preload.ts
contextBridge.exposeInMainWorld('electronAPI', {
  // ä»…æš´éœ²å¿…éœ€çš„ API
  db: {
    query: (sql, params) => ipcRenderer.invoke('db:query', sql, params),
    execute: (sql, params) => ipcRenderer.invoke('db:execute', sql, params)
  },
  openRouter: {
    streamChat: (options) => ipcRenderer.invoke('openrouter:stream-chat', options)
  }
})
```

### XSS é˜²æŠ¤

```typescript
// æ‰€æœ‰ç”¨æˆ·ç”Ÿæˆçš„ HTML å†…å®¹ç»è¿‡ DOMPurify æ¸…ç†
import DOMPurify from 'dompurify'

const cleanHtml = DOMPurify.sanitize(userGeneratedHtml, {
  ALLOWED_TAGS: ['p', 'b', 'i', 'code', 'pre', 'a'],
  ALLOWED_ATTR: ['href', 'class']
})
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. Worker çº¿ç¨‹éš”ç¦»
- **é—®é¢˜**: SQLite åŒæ­¥æ“ä½œé˜»å¡ UI
- **æ–¹æ¡ˆ**: æ•°æ®åº“æ“ä½œåœ¨ Worker çº¿ç¨‹æ‰§è¡Œ
- **æ•ˆæœ**: UI å§‹ç»ˆ 60fps

### 2. æŒä¹…åŒ–é˜²æŠ–
- **é—®é¢˜**: é¢‘ç¹ IPC é€šä¿¡å¯¼è‡´æ€§èƒ½ä¸‹é™
- **æ–¹æ¡ˆ**: 500ms é˜²æŠ–ï¼Œåˆå¹¶å¤šæ¬¡ä¿å­˜ä¸ºå•æ¬¡æ‰¹é‡æ“ä½œ
- **æ•ˆæœ**: å‡å°‘ 75% IPC è°ƒç”¨

### 3. Markdown æ¸²æŸ“ç¼“å­˜
- **é—®é¢˜**: é‡å¤æ¸²æŸ“ç›¸åŒæ¶ˆæ¯æµªè´¹ CPU
- **æ–¹æ¡ˆ**: ç¼“å­˜å·²æ¸²æŸ“çš„ HTMLï¼Œä½¿ç”¨æ¶ˆæ¯ ID ä½œä¸º key
- **æ•ˆæœ**: é•¿å¯¹è¯æ»šåŠ¨æ€§èƒ½æå‡ 60%

### 4. è™šæ‹Ÿæ»šåŠ¨ï¼ˆè®¡åˆ’ä¸­ï¼‰
- **é—®é¢˜**: é•¿å¯¹è¯ï¼ˆ1000+ æ¶ˆæ¯ï¼‰DOM èŠ‚ç‚¹è¿‡å¤š
- **æ–¹æ¡ˆ**: ä½¿ç”¨ `vue-virtual-scroller` ä»…æ¸²æŸ“å¯è§åŒºåŸŸ
- **é¢„æœŸ**: æ”¯æŒ 10000+ æ¶ˆæ¯çš„æµç•…æ»šåŠ¨

è¯¦è§: [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../guides/performance-optimization.md)

---

## ğŸ§ª æµ‹è¯•æ¶æ„

### å•å…ƒæµ‹è¯• (Vitest + @testing-library/vue)

```
tests/unit/
â”œâ”€â”€ stores/               # Store å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ app.spec.ts
â”‚   â”œâ”€â”€ conversation.spec.ts
â”‚   â””â”€â”€ branch.spec.ts
â”œâ”€â”€ composables/          # Composable å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ useBranchNavigation.spec.ts
â”‚   â””â”€â”€ useMessageSending.spec.ts
â””â”€â”€ services/             # Service å•å…ƒæµ‹è¯•
    â”œâ”€â”€ aiChatService.spec.ts
    â””â”€â”€ searchService.spec.ts
```

### ç»„ä»¶æ–‡æ¡£ (Storybook)

```
src/stories/
â”œâ”€â”€ Button.stories.ts
â”œâ”€â”€ ChatInput.stories.ts
â””â”€â”€ MessageBranchController.stories.ts
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åˆ†æ”¯å¯¹è¯ç³»ç»Ÿè®¾è®¡](branch-system.md)
- [AI æä¾›å•†æ¶æ„](ai-providers.md)
- [æ•°æ®åº“è®¾è®¡](database.md)
- [Pinia Store æ¶æ„](state-management.md)
- [Markdown æ¸²æŸ“ä¸å®‰å…¨](rendering.md)

---

## ğŸ”„ æ¶æ„æ¼”è¿›

### v0.0.0 (å½“å‰ç‰ˆæœ¬)
- âœ… ä¸‰å±‚åˆ†ç¦»æ¶æ„
- âœ… Pinia æ¨¡å—åŒ– Store
- âœ… Worker çº¿ç¨‹æ•°æ®åº“
- âœ… å¤šæä¾›å•† AI é›†æˆ

### v0.1.0 (è®¡åˆ’ä¸­)
- [ ] ChatView.vue æ‹†åˆ†ä¸ºå¤šä¸ªå­ç»„ä»¶
- [ ] è™šæ‹Ÿæ»šåŠ¨æ”¯æŒé•¿å¯¹è¯
- [ ] å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

---

**ç»´æŠ¤è€…**: @GuXinghai  
**æœ€åå®¡æŸ¥**: 2025å¹´12æœˆ3æ—¥
