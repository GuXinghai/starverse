# Test 2.2: 推理模式配置功能测试

**测试日期**: 2025年11月27日  
**测试范围**: Phase 2.2 - useReasoningControl composable  
**相关文件**: 
- `src/composables/useReasoningControl.ts` (367 行)
- `src/components/ChatView.vue` (已集成)

---

## 📋 测试概述

测试推理模式（Reasoning Mode）的完整功能，包括：
- 推理模式开关（visible/off 切换）
- Reasoning Effort 等级选择（low/medium/high）
- Reasoning Visibility 模式选择（visible/hidden）
- 模型支持检测（11 个关键词检测）
- 对话切换时的状态持久化
- OpenRouter 提供商限制

---

## ✅ 测试用例

### **Test Case 1: 推理模式开关切换**

#### 前置条件
1. 启动应用，进入任意对话
2. 在模型选择器中选择支持推理的模型（如 `deepseek/deepseek-r1`）
3. 确保当前提供商为 OpenRouter

#### 测试步骤
1. 在工具栏找到 "推理模式" 按钮（🧠 图标）
2. 点击按钮，观察按钮状态变化
3. 再次点击按钮，观察状态恢复

#### 预期结果
- **第一次点击**: 
  - 按钮从激活状态变为灰色
  - Tooltip 从 "关闭推理模式" 变为 "启用推理模式"
  - 按钮文本变为 "OFF"
- **第二次点击**:
  - 按钮恢复激活状态
  - Tooltip 变回 "关闭推理模式"
  - 按钮显示 effort 级别（如 "Medium"）

#### 验证点
- [ ] 按钮视觉状态正确切换（颜色变化）
- [ ] Tooltip 文本正确更新
- [ ] 按钮文本正确显示（OFF 或 effort 级别）
- [ ] 点击响应流畅，无延迟

---

### **Test Case 2: Reasoning Effort 等级选择**

#### 前置条件
1. 推理模式已启用（visible 状态）
2. 使用支持推理的模型

#### 测试步骤
1. 点击推理模式按钮旁的下拉菜单图标
2. 观察弹出的选项列表
3. 依次选择 "Low"、"Medium"、"High" 三个选项
4. 每次选择后观察按钮文本变化

#### 预期结果
- **下拉菜单显示**:
  - 显示 3 个选项：Low、Medium、High
  - 当前选中的选项有勾选标记
  - 每个选项有中文说明
- **选择 Low**:
  - 按钮文本变为 "Low"
  - 配置已保存到对话数据
- **选择 Medium**:
  - 按钮文本变为 "Medium"
  - 配置已保存
- **选择 High**:
  - 按钮文本变为 "High"
  - 配置已保存

#### 验证点
- [ ] 下拉菜单正确显示 3 个选项
- [ ] 当前选中项有视觉标记
- [ ] 按钮文本立即更新
- [ ] 状态已持久化到 conversationStore

---

### **Test Case 3: Reasoning Visibility 模式选择**

#### 前置条件
1. 推理模式已启用
2. 使用支持推理的模型

#### 测试步骤
1. 点击推理模式按钮旁的齿轮图标（⚙️）
2. 观察弹出的 visibility 选项
3. 选择 "Hidden"（隐藏推理过程）
4. 选择 "Visible"（显示推理过程）

#### 预期结果
- **下拉菜单显示**:
  - 显示 2 个选项：Visible、Hidden
  - 当前选中项有勾选标记
- **选择 Hidden**:
  - 配置更新为 hidden
  - 按钮仍显示 effort 级别
  - Tooltip 显示 "(隐藏推理过程)"
- **选择 Visible**:
  - 配置更新为 visible
  - Tooltip 显示 "(显示推理过程)"

#### 验证点
- [ ] Visibility 选项正确显示
- [ ] 选项切换响应及时
- [ ] Tooltip 正确反映当前模式
- [ ] 配置已保存

---

### **Test Case 4: 模型支持检测 - 支持推理的模型**

#### 前置条件
1. 当前提供商为 OpenRouter
2. 准备测试以下模型（从 11 个关键词中选择）

#### 测试步骤
测试以下模型是否正确显示推理模式按钮：

| 模型 ID 示例 | 关键词 | 预期结果 |
|-------------|--------|----------|
| `deepseek/deepseek-r1` | `r1` | ✅ 显示 |
| `anthropic/claude-3-opus-thinking` | `thinking` | ✅ 显示 |
| `openai/o1-preview` | `o1` | ✅ 显示 |
| `openai/o3-mini` | `o3` | ✅ 显示 |
| `google/gemini-2.0-flash-thinking` | `thinking` | ✅ 显示 |
| `qwen/qwq-32b` | `qwq` | ✅ 显示 |

#### 预期结果
- 所有包含关键词的模型都应显示推理模式按钮
- 按钮默认状态为启用（visible）
- Effort 默认为 "Medium"

#### 验证点
- [ ] 关键词 `r1`, `thinking`, `o1`, `o3` 检测正常
- [ ] 关键词 `qwq`, `deepthink`, `reasoning` 检测正常
- [ ] 其他关键词 (`extended-thinking`, `reason`, `chain-of-thought`, `cot`) 检测正常

---

### **Test Case 5: 模型支持检测 - 不支持推理的模型**

#### 前置条件
1. 当前提供商为 OpenRouter

#### 测试步骤
测试以下模型是否正确隐藏推理模式按钮：

| 模型 ID 示例 | 预期结果 |
|-------------|----------|
| `openai/gpt-4o` | ❌ 隐藏 |
| `anthropic/claude-3.5-sonnet` | ❌ 隐藏 |
| `google/gemini-2.0-flash` | ❌ 隐藏 |
| `meta-llama/llama-3.1-70b` | ❌ 隐藏 |

#### 预期结果
- 不包含推理关键词的模型不显示推理模式按钮
- 工具栏布局正常，其他按钮位置不受影响

#### 验证点
- [ ] 普通模型不显示推理按钮
- [ ] 切换到不支持模型时按钮消失
- [ ] 切换回支持模型时按钮重新出现

---

### **Test Case 6: 对话切换时的状态持久化**

#### 前置条件
1. 创建两个对话：对话 A 和对话 B
2. 两个对话都使用支持推理的模型

#### 测试步骤
1. 在对话 A 中：
   - 启用推理模式（visible）
   - 设置 Effort 为 "High"
   - 设置 Visibility 为 "Hidden"
2. 切换到对话 B
3. 在对话 B 中保持默认配置
4. 切换回对话 A

#### 预期结果
- **对话 A 第一次配置**:
  - 推理模式按钮显示 "High"
  - Tooltip 显示 "(隐藏推理过程)"
- **切换到对话 B**:
  - 显示对话 B 的默认配置（Medium, Visible）
- **切换回对话 A**:
  - 配置恢复为 "High" + "Hidden"
  - 按钮状态正确显示

#### 验证点
- [ ] 每个对话的推理配置独立存储
- [ ] 切换对话时配置正确恢复
- [ ] 不同对话的配置互不影响
- [ ] 重启应用后配置依然保留

---

### **Test Case 7: OpenRouter 提供商限制**

#### 前置条件
1. 准备多个提供商：OpenRouter、Anthropic、Google

#### 测试步骤
1. 选择支持推理的模型（如 `deepseek-r1`）
2. 切换到 OpenRouter 提供商
3. 观察推理模式按钮是否显示
4. 切换到 Anthropic 提供商
5. 观察推理模式按钮是否隐藏
6. 切换回 OpenRouter

#### 预期结果
- **OpenRouter 提供商**:
  - 推理模式按钮显示
  - 功能正常可用
- **其他提供商（Anthropic/Google）**:
  - 推理模式按钮隐藏
  - 即使模型 ID 包含关键词也不显示

#### 验证点
- [ ] OpenRouter 提供商时按钮显示
- [ ] 非 OpenRouter 提供商时按钮隐藏
- [ ] 提供商切换响应及时
- [ ] 提示信息清晰（如有）

---

### **Test Case 8: 生成消息时的状态锁定**

#### 前置条件
1. 推理模式已启用
2. 使用支持推理的模型

#### 测试步骤
1. 输入一条消息："解释量子纠缠原理"
2. 点击发送按钮
3. 在消息生成过程中：
   - 尝试点击推理模式按钮
   - 尝试点击 effort 下拉菜单
   - 尝试点击 visibility 下拉菜单
4. 等待消息生成完成
5. 再次尝试点击按钮

#### 预期结果
- **生成过程中**:
  - 推理模式按钮禁用（灰色或不可点击）
  - 下拉菜单无法打开
  - 鼠标悬停显示 "生成中..." 或类似提示
- **生成完成后**:
  - 所有按钮恢复可用状态
  - 配置保持不变

#### 验证点
- [ ] 生成中推理按钮被禁用
- [ ] 下拉菜单无法操作
- [ ] 视觉反馈清晰（灰色、禁用样式）
- [ ] 生成完成后恢复正常

---

### **Test Case 9: API 请求参数验证**

#### 前置条件
1. 启用推理模式
2. 配置特定 effort 和 visibility
3. 打开浏览器开发者工具（Network 面板）

#### 测试步骤
1. 配置推理模式：
   - Effort: "High"
   - Visibility: "Visible"
2. 发送一条消息
3. 在 Network 面板中查看 API 请求
4. 检查请求 payload 中的 reasoning 参数

#### 预期结果
请求体应包含以下参数：
```json
{
  "reasoning": {
    "effort": "high",
    "type": "enabled:visible"
  }
  // ... 其他参数
}
```

#### 验证点
- [ ] `reasoning.effort` 正确传递
- [ ] `reasoning.type` 格式正确
- [ ] Visibility "hidden" 时为 `"enabled:hidden"`
- [ ] 推理模式关闭时不包含 reasoning 参数

---

### **Test Case 10: 边界情况测试**

#### 测试步骤

**场景 1: 快速切换**
1. 快速连续点击推理模式按钮 10 次
2. 观察是否有状态错乱

**场景 2: 快速切换 effort**
1. 快速连续切换 Low/Medium/High
2. 检查最终状态是否正确

**场景 3: 模型切换时保持配置**
1. 配置推理模式为 High
2. 切换到另一个支持推理的模型
3. 检查配置是否保持

#### 预期结果
- 所有操作响应稳定，无抖动
- 最终状态与最后一次操作一致
- 无控制台错误

#### 验证点
- [ ] 快速点击无状态错乱
- [ ] 无内存泄漏或性能问题
- [ ] 无控制台错误或警告

---

## 🐛 已知问题检查

基于 Phase 2.1 测试经验，特别检查：

- [ ] 对话切换时状态是否正确恢复（类似图像生成的 bug）
- [ ] 推理模式是否会影响其他功能（附件、图像生成等）
- [ ] 长对话中推理模式性能是否正常
- [ ] 分支对话是否继承推理配置

---

## 📊 测试结果记录

| 测试用例 | 状态 | 发现问题 | 备注 |
|---------|------|---------|------|
| Test Case 1: 开关切换 | ⏳ 待测试 | - | - |
| Test Case 2: Effort 选择 | ⏳ 待测试 | - | - |
| Test Case 3: Visibility 选择 | ⏳ 待测试 | - | - |
| Test Case 4: 支持推理的模型 | ⏳ 待测试 | - | - |
| Test Case 5: 不支持推理的模型 | ⏳ 待测试 | - | - |
| Test Case 6: 状态持久化 | ⏳ 待测试 | - | - |
| Test Case 7: 提供商限制 | ⏳ 待测试 | - | - |
| Test Case 8: 生成中锁定 | ⏳ 待测试 | - | - |
| Test Case 9: API 参数验证 | ⏳ 待测试 | - | - |
| Test Case 10: 边界情况 | ⏳ 待测试 | - | - |

---

## 🎯 测试重点

1. **状态持久化** - 对话切换时配置恢复（优先级：⭐⭐⭐）
2. **模型检测** - 11 个关键词准确识别（优先级：⭐⭐⭐）
3. **提供商限制** - 仅 OpenRouter 可用（优先级：⭐⭐）
4. **API 参数** - 请求格式正确（优先级：⭐⭐⭐）
5. **用户体验** - 响应流畅，反馈清晰（优先级：⭐⭐）

---

## 📝 测试完成标准

- ✅ 所有 10 个测试用例通过
- ✅ 无控制台错误或警告
- ✅ 对话切换时状态正确恢复
- ✅ API 请求参数格式正确
- ✅ 用户交互流畅，无卡顿

---

**开始测试时间**: _____  
**完成测试时间**: _____  
**测试人员**: _____  
**测试结论**: ⏳ 待完成
