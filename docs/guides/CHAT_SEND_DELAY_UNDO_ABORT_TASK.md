# 任务卡：聊天发送延时 + 撤回 + 中止流式逻辑

## 任务名称
为聊天发送引入「可配置延时 + 撤回（Undo Send）+ 流式中止」统一逻辑

## 当前行为（现状）
- 用户在输入框中输入文本（可选图片/文件）点击发送。
- 输入内容立即复制成一条新的 user 消息并渲染在聊天列表。
- 输入框被清空。
- 直接调用 OpenRouter API 并开始流式回复。
- 虽然已有“停止生成”之类逻辑，但：
  - 发送与中止的状态机不够清晰；
  - 缺乏发送延时与撤回机制；
  - 未区分“请求尚未收到首 token”与“流式过程中”的中止语义。

## 问题 / 痛点
1. 用户误触发送后无法撤回，体验不佳。
2. 发送 / 中止状态混乱：
   - 请求发出前、中、后没有清晰分段；
   - UI 按钮语义（撤回 vs 中止）不一致，竞态条件未系统化处理。
3. 逻辑散布在 `useMessageSending`、`chatStore`、`aiChatService` 等多处，维护困难。
4. 当前阶段不考虑计费，仅希望先稳住交互与状态机。

## 目标行为（改完后希望的效果）
以单条用户发送为单位，建立明确的阶段与行为：

1. 点击发送后：
   - 文本/图片/文件复制到新的 user 消息；
   - 输入区域清空；
   - 在消息列表插入一条“正在发送中……”的系统提示消息；
   - 启动可配置延时计时器（单位毫秒，配置后 >= 0，0 表示立即发送）。
2. 延时计时器运行期间（phase = `delay`）：
   - 用户可点击“撤回”：
     - 取消延时；
     - 从列表移除 user 消息和系统提示；
     - 输入内容恢复到输入区域；
   - 不发起 OpenRouter 请求。
3. 延时结束瞬间（phase 从 `delay` 进入 `requesting`）：
   - 状态切换需原子完成，避免“倒计时结束 + 撤回”竞态。
   - 进入发送后：
     - 更新提示消息：“发送完成，等待流式响应……”；
     - 按钮从“撤回”切换为“中止”；
     - 调用 OpenRouter（保持现有 `aiChatService` 流式逻辑）。
4. 请求发出但未得第一个 token（phase = `requesting`）：
   - 点击“中止”会：
     - 使用 AbortController 取消请求；
     - 清除系统提示消息；
     - 补一个空的 assistant 消息壳，方便展示“重试 / 重新生成”；
     - 保留原 user 消息。
5. 收到首个流式 token（phase = `streaming`）：
   - 系统提示消失；
   - 创建或填充 assistant 消息，开始追加内容；
   - “中止”按钮继续存在，语义为“停止后续输出”。
6. 流式过程中点击“中止”（phase = `streaming`）：
   - AbortController 停止后续 chunk；
   - 保留已生成的 assistant 内容；
   - 可在消息中加提示（如“已中止 · 重试”）。
7. 流式正常结束（phase = `completed`）：
   - assistant 消息保留完整；
   - 所有中止类控制恢复默认状态（例如变为“重新生成”）。
8. 暂不处理计费/usage 统计，后续再补。

## 相关模块 / 文件（粗略）
- `src/composables/useMessageSending.ts`：发送按钮逻辑入口，负责延时/撤回/中止调度。
- `src/stores/chatStore.(ts|js)`：消息列表与状态维护，需要扩展 message 的 phase 字段。
- `src/services/aiChatService.(ts|js)`：封装 OpenRouter 调用，包含流式与 AbortController 逻辑。
- UI 相关组件（`ChatInput.vue`、`ChatMessageList.vue`、`ChatMessageItem.vue` 等）：负责按钮、提示与状态展示。

## 硬约束
- 不调整数据库 schema 或历史对话存储格式。
- 不改动 OpenRouter 请求核心参数（只在现有链路上挂 AbortController）。
- 优先做增量修改，避免无关文件的大改动。
- 不在本任务中加入计费 / usage 统计逻辑。

## 非目标（本轮不做）
- 不实现多步撤销或复杂草稿管理，仅支持一次性短延时撤回。
- 不触碰已有的防抖逻辑，延时机制与防抖分层处理。
- 不引入新的 UI 框架或大规模界面改版。
- 不做计费/usage 展示；计划后续任务单独处理。
