# 删除分支功能测试指南

> **测试目的**: 验证删除分支功能修复是否成功  
> **服务器地址**: http://localhost:5174/  
> **测试日期**: 2025年11月28日

---

## 🧪 测试清单

### ✅ 核心修复测试

#### 测试 1: 删除当前版本并验证持久化
**目标**: 验证删除当前版本后刷新仍保持删除状态

**步骤**:
1. 打开应用 http://localhost:5174/
2. 创建一个新对话
3. 发送消息 "测试消息 1"
4. 编辑消息创建新版本 "测试消息 1 - 版本 2"
5. 点击删除按钮 → 选择 "删除当前分支"
6. **刷新应用** (Ctrl+R 或 F5)
7. ✅ 验证: 版本 2 应该消失，只剩版本 1

**预期结果**:
- 删除操作立即生效
- 刷新后删除状态保持
- 不会出现"版本 2 又回来了"的情况

---

#### 测试 2: 删除所有版本并验证持久化
**目标**: 验证删除整个分支后刷新仍保持删除状态

**步骤**:
1. 创建新对话
2. 发送消息 "要删除的消息"
3. 等待 AI 回复
4. 点击用户消息的删除按钮 → 选择 "删除所有分支"
5. **刷新应用** (Ctrl+R 或 F5)
6. ✅ 验证: 该消息及其 AI 回复都应消失

**预期结果**:
- 用户消息和 AI 回复都被删除
- 刷新后删除状态保持
- 对话树结构正确更新

---

#### 测试 3: 切换版本并验证持久化
**目标**: 验证版本切换后刷新仍保持切换状态

**步骤**:
1. 创建有多个版本的消息
2. 切换到版本 2（点击 "→" 按钮）
3. **刷新应用** (Ctrl+R 或 F5)
4. ✅ 验证: 应该仍显示版本 2

**预期结果**:
- 版本切换立即生效
- 刷新后仍显示选中的版本
- currentVersionIndex 正确保存

---

#### 测试 4: 编辑消息并验证持久化
**目标**: 验证编辑消息后刷新内容仍保持

**步骤**:
1. 发送消息 "原始内容"
2. 点击编辑按钮
3. 修改为 "编辑后的内容"
4. 提交编辑
5. **刷新应用** (Ctrl+R 或 F5)
6. ✅ 验证: 应该显示 "编辑后的内容"

**预期结果**:
- 编辑操作立即生效
- 刷新后内容保持修改状态
- 不会回滚到原始内容

---

### ✅ 推理功能测试

#### 测试 5: 推理模式数据持久化
**目标**: 验证推理模式的数据能正确保存

**步骤**:
1. 创建新对话
2. 启用推理模式（如果支持）
3. 发送消息触发推理
4. 等待推理完成
5. **刷新应用** (Ctrl+R 或 F5)
6. ✅ 验证: 推理数据（reasoning_detail、reasoning_summary）应该保留

**预期结果**:
- 推理细节正确显示
- 推理摘要正确保存
- 刷新后推理数据不丢失

---

### ✅ 综合场景测试

#### 测试 6: 删除分支后切换对话
**目标**: 验证删除操作不影响其他对话

**步骤**:
1. 创建对话 A 和对话 B
2. 在对话 A 中删除一个分支
3. 切换到对话 B
4. 再切换回对话 A
5. ✅ 验证: 对话 A 的删除状态仍保持

**预期结果**:
- 对话切换不影响删除状态
- 内存中的状态与持久化状态一致

---

#### 测试 7: 批量操作持久化
**目标**: 验证连续多次操作都能正确保存

**步骤**:
1. 创建新对话
2. 发送 5 条消息
3. 依次删除第 2、4 条消息
4. 编辑第 3 条消息
5. 切换第 1 条消息的版本
6. **刷新应用** (Ctrl+R 或 F5)
7. ✅ 验证: 所有操作结果都应保持

**预期结果**:
- 所有删除操作保持
- 编辑结果保持
- 版本切换状态保持
- 没有操作丢失

---

### ✅ 边界条件测试

#### 测试 8: 删除唯一版本
**目标**: 验证删除分支的唯一版本时行为正确

**步骤**:
1. 发送只有 1 个版本的消息
2. 点击删除 → 选择 "删除当前分支"
3. ✅ 验证: 整个分支应被删除（因为只有 1 个版本）
4. **刷新应用**
5. ✅ 验证: 分支仍然不存在

**预期结果**:
- 唯一版本被删除时，整个分支被移除
- 刷新后状态正确

---

#### 测试 9: 删除根分支
**目标**: 验证删除对话的第一条消息时行为正确

**步骤**:
1. 创建新对话
2. 发送第一条消息
3. 删除该消息（删除所有版本）
4. ✅ 验证: 对话变为空对话
5. **刷新应用**
6. ✅ 验证: 对话仍为空

**预期结果**:
- 根分支可以被删除
- 删除后对话树结构正确
- 刷新后状态保持

---

## 🐛 已知问题排查

### 问题 1: 删除后刷新又出现
**原因**: 缺少 `persistenceStore.markConversationDirty(conversationId)` 调用  
**状态**: ✅ 已修复

### 问题 2: 版本切换不保存
**原因**: `switchBranchVersion` 缺少持久化调用  
**状态**: ✅ 已修复

### 问题 3: 编辑内容不保存
**原因**: `updateBranchParts` 缺少持久化调用  
**状态**: ✅ 已修复

### 问题 4: 推理数据不保存
**原因**: 推理相关函数缺少持久化调用  
**状态**: ✅ 已修复

---

## 📊 测试报告模板

```
测试时间: ___________
测试人员: ___________

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 删除当前版本持久化 | ☐ 通过 ☐ 失败 | |
| 删除所有版本持久化 | ☐ 通过 ☐ 失败 | |
| 切换版本持久化 | ☐ 通过 ☐ 失败 | |
| 编辑消息持久化 | ☐ 通过 ☐ 失败 | |
| 推理数据持久化 | ☐ 通过 ☐ 失败 | |
| 删除后切换对话 | ☐ 通过 ☐ 失败 | |
| 批量操作持久化 | ☐ 通过 ☐ 失败 | |
| 删除唯一版本 | ☐ 通过 ☐ 失败 | |
| 删除根分支 | ☐ 通过 ☐ 失败 | |

总结: ___________________________
```

---

## 🔧 调试技巧

### 查看持久化日志
打开浏览器开发者工具（F12），查看 Console 输出：
- 应该看到 `[PersistenceStore] Conversation marked dirty: xxx`
- 应该看到 `[PersistenceStore] Saving conversation: xxx`

### 检查数据文件
数据保存在 Electron 应用数据目录，可以手动检查：
```
Windows: %APPDATA%\starverse\conversations\
```

### 强制刷新
如果怀疑缓存问题，使用硬刷新：
- Windows: Ctrl+Shift+R 或 Ctrl+F5

---

## ✅ 测试通过标准

1. **所有 9 个测试项通过**
2. **刷新后状态保持正确**
3. **无控制台错误**
4. **持久化日志正常**
5. **数据文件正确更新**

---

**测试完成后请更新**: docs/BRANCH_DELETE_FIX.md  
**如有问题请报告**: 在 GitHub Issues 中创建新问题
