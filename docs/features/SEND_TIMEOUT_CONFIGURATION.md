# è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨é…ç½®åŠŸèƒ½

## æ¦‚è¿°

ä¸ºäº†é˜²æ­¢æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­çš„"å¹½çµä»»åŠ¡"ï¼ˆGhost Taskï¼‰é—®é¢˜ï¼ŒStarverse å®ç°äº†è¶…æ—¶ä¿æŠ¤æœºåˆ¶ã€‚æ­¤åŠŸèƒ½å…è®¸ç”¨æˆ·è‡ªå®šä¹‰è¶…æ—¶æ—¶é•¿æˆ–å®Œå…¨ç¦ç”¨è¶…æ—¶ä¿æŠ¤ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. å¯é…ç½®çš„è¶…æ—¶æ—¶é•¿

- **é»˜è®¤å€¼**: 60000ms (60ç§’)
- **å¯é…ç½®èŒƒå›´**: 0 - 300000ms (0ç§’ - 5åˆ†é’Ÿ)
- **ç¦ç”¨é€‰é¡¹**: è®¾ç½®ä¸º 0 å¯å®Œå…¨ç¦ç”¨è¶…æ—¶ä¿æŠ¤

### 2. è¶…æ—¶è¡Œä¸º

å½“æ¶ˆæ¯å‘é€è¶…è¿‡é…ç½®çš„è¶…æ—¶æ—¶é•¿æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. è‡ªåŠ¨å¼ºåˆ¶é‡ç½®å‘é€çŠ¶æ€
2. æ¸…ç†æ‰€æœ‰ç›¸å…³çš„å®šæ—¶å™¨å’Œç½‘ç»œè¯·æ±‚
3. æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
4. è®°å½•é”™è¯¯æ—¥å¿—ä¾¿äºè°ƒè¯•

**é‡è¦ï¼š** ä¸€æ—¦æ”¶åˆ°æœåŠ¡å™¨çš„ç¬¬ä¸€ä¸ªæµå¼å“åº” chunkï¼Œè¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨ä¼šç«‹å³è‡ªåŠ¨æ¸…é™¤ã€‚è¿™æ„å‘³ç€ï¼š
- âœ… è¶…æ—¶ä¿æŠ¤ä»…é’ˆå¯¹**è¿æ¥é˜¶æ®µ**ï¼ˆç­‰å¾…æœåŠ¡å™¨å“åº”ï¼‰
- âœ… ä¸€æ—¦å¼€å§‹æ¥æ”¶æ•°æ®ï¼Œå³ä½¿æµå¼è¿‡ç¨‹å¾ˆæ…¢ä¹Ÿä¸ä¼šè§¦å‘è¶…æ—¶
- âœ… é¿å…äº†æ­£å¸¸çš„é•¿æ—¶é—´ç”Ÿæˆä»»åŠ¡è¢«è¯¯åˆ¤ä¸ºè¶…æ—¶

### 3. UI é…ç½®ç•Œé¢

ç”¨æˆ·å¯ä»¥åœ¨"è®¾ç½® > é«˜çº§è®¾ç½®"ä¸­é…ç½®è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨ï¼š
- è¾“å…¥æ¡†æ”¯æŒæ•°å€¼è¾“å…¥ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
- å®æ—¶æ˜¾ç¤ºå½“å‰è®¾ç½®ï¼ˆè½¬æ¢ä¸ºç§’ï¼‰
- ä¸€é”®ä¿å­˜æŒ‰é’®
- å‹å¥½çš„è¯´æ˜æ–‡å­—å’Œæ¨èå€¼

## æŠ€æœ¯å®ç°

### 1. çŠ¶æ€ç®¡ç† (src/stores/index.ts)

```typescript
// è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨ï¼ˆæ¯«ç§’ï¼Œ0 ä¸ºç¦ç”¨ï¼‰
const sendTimeoutMs = ref<number>(60000)

// ä¿å­˜è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨
const setSendTimeoutMs = async (value: number) => {
  const normalized = Math.max(0, Number(value) || 60000)
  await persistenceStore.set('sendTimeoutMs', normalized)
  sendTimeoutMs.value = normalized
}
```

### 2. æ¶ˆæ¯å‘é€é€»è¾‘ (src/composables/useMessageSending.ts)

```typescript
function startSendTimeout() {
  const timeoutMs = appStore.sendTimeoutMs ?? 60000
  
  // å¦‚æœé…ç½®ä¸º 0ï¼Œä¸å¯åŠ¨è¶…æ—¶ä¿æŠ¤
  if (timeoutMs <= 0) {
    console.log('[useMessageSending] âš ï¸ è¶…æ—¶ä¿æŠ¤å·²ç¦ç”¨ (sendTimeoutMs = 0)')
    return
  }
  
  sendTimeoutTimer = window.setTimeout(() => {
    console.error(`[useMessageSending] â±ï¸ å‘é€è¶…æ—¶ï¼è‡ªåŠ¨å¼ºåˆ¶é‡ç½®çŠ¶æ€ (${timeoutMs}ms)`)
    forceResetSendingState()
    sendError.value = `å‘é€è¶…æ—¶ï¼ˆ${Math.round(timeoutMs / 1000)}ç§’æ— å“åº”ï¼‰ï¼Œå·²è‡ªåŠ¨é‡ç½®çŠ¶æ€`
  }, timeoutMs)
}

// æ”¶åˆ°ç¬¬ä¸€ä¸ªæµå¼ chunk åç«‹å³æ¸…é™¤è¶…æ—¶ä¿æŠ¤
const firstResult = await iterator.next()
if (!firstResult.done) {
  clearSendTimeout() // â† å…³é”®ï¼šç¡®è®¤æœåŠ¡å™¨å“åº”åæ¸…é™¤å®šæ—¶å™¨
  console.log('[useMessageSending] âœ… å·²æ”¶åˆ°æµå¼å“åº”ï¼Œæ¸…é™¤è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨')
  await processStreamChunk(firstResult.value, targetConversationId, aiBranchId)
}
```

**æ¸…é™¤æ—¶æœº**ï¼š
- âœ… æ”¶åˆ°ç¬¬ä¸€ä¸ªæµå¼ chunk åï¼ˆæ­£å¸¸æµç¨‹ï¼‰
- âœ… å‘ç”Ÿé”™è¯¯æ—¶ï¼ˆæ¸…ç†èµ„æºï¼‰
- âŒ ä¸åœ¨æµå¼å®Œæˆæ—¶æ¸…é™¤ï¼ˆå› ä¸ºå·²ç»åœ¨ç¬¬ä¸€ä¸ª chunk æ¸…é™¤äº†ï¼‰

### 3. UI é…ç½®ç•Œé¢ (src/components/SettingsView.vue)

- å“åº”å¼è¾“å…¥æ¡†ç»‘å®šåˆ° `sendTimeoutMs`
- è‡ªåŠ¨æ ¼å¼åŒ–ä¸ºæœ€æ¥è¿‘çš„åƒä½æ•°ï¼ˆ1000ms æ­¥è¿›ï¼‰
- æ˜¾ç¤ºå®æ—¶é¢„è§ˆï¼ˆç§’ä¸ºå•ä½ï¼‰
- ç‹¬ç«‹ä¿å­˜æŒ‰é’®è§¦å‘æŒä¹…åŒ–

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: æ ‡å‡†ä½¿ç”¨ï¼ˆæ¨èï¼‰

**é…ç½®**: 60000ms (60ç§’)

é€‚ç”¨äºå¤§å¤šæ•°ç”¨æˆ·å’Œç½‘ç»œç¯å¢ƒï¼Œå¹³è¡¡äº†å“åº”é€Ÿåº¦å’Œå®¹é”™èƒ½åŠ›ã€‚

### åœºæ™¯ 2: é•¿æ—¶é—´ç”Ÿæˆä»»åŠ¡

**é…ç½®**: 120000ms - 300000ms (2-5åˆ†é’Ÿ)

é€‚ç”¨äºï¼š
- ä½¿ç”¨æ¨ç†å¢å¼ºæ¨¡å‹ï¼ˆå¦‚ OpenAI o1ï¼‰
- å¤„ç†å¤§é‡ä¸Šä¸‹æ–‡çš„å¯¹è¯
- ç½‘ç»œæ¡ä»¶è¾ƒå·®çš„ç¯å¢ƒ

### åœºæ™¯ 3: ç¦ç”¨è¶…æ—¶ä¿æŠ¤

**é…ç½®**: 0ms

é€‚ç”¨äºï¼š
- è°ƒè¯•å’Œå¼€å‘ç¯å¢ƒ
- ç¡®ä¿¡ç½‘ç»œç¨³å®šçš„åœºæ™¯
- éœ€è¦å¤„ç†æé•¿æ—¶é—´ä»»åŠ¡

âš ï¸ **è­¦å‘Š**: ç¦ç”¨è¶…æ—¶ä¿æŠ¤åï¼Œå¦‚æœé‡åˆ°çœŸå®çš„ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨æ— å“åº”ï¼ŒçŠ¶æ€å°†ä¸ä¼šè‡ªåŠ¨æ¢å¤ï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯åº”ç”¨ã€‚

## é…ç½®æŒä¹…åŒ–

é…ç½®é€šè¿‡ electron-store æŒä¹…åŒ–å­˜å‚¨ï¼š

- **å­˜å‚¨ä½ç½®**: `%APPDATA%/starverse/config.json` (Windows)
- **å­—æ®µå**: `sendTimeoutMs`
- **æ•°æ®ç±»å‹**: Number
- **å‘åå…¼å®¹**: æ—§ç‰ˆæœ¬åº”ç”¨ä¼šä½¿ç”¨é»˜è®¤å€¼ 60000ms

## ç›¸å…³æ–‡ä»¶

- `src/stores/index.ts` - çŠ¶æ€ç®¡ç†å’ŒæŒä¹…åŒ–
- `src/composables/useMessageSending.ts` - è¶…æ—¶ä¿æŠ¤é€»è¾‘
## æ—¥å¿—è¾“å‡º

å¯ç”¨è¶…æ—¶ä¿æŠ¤æ—¶çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
[useMessageSending] â° å·²å¯åŠ¨è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨ï¼ˆ60000ms = 60ç§’ï¼‰
```

æ”¶åˆ°æµå¼å“åº”åçš„æ—¥å¿—ç¤ºä¾‹ï¼ˆæ­£å¸¸æµç¨‹ï¼‰ï¼š

```
[useMessageSending] ğŸ‰ æ”¶åˆ°ç¬¬ä¸€ä¸ª chunk
[useMessageSending] âœ… å·²æ”¶åˆ°æµå¼å“åº”ï¼Œæ¸…é™¤è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨
[useMessageSending] â° å·²æ¸…é™¤è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨
```

è¶…æ—¶è§¦å‘æ—¶çš„æ—¥å¿—ç¤ºä¾‹ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰ï¼š

```
[useMessageSending] â±ï¸ å‘é€è¶…æ—¶ï¼è‡ªåŠ¨å¼ºåˆ¶é‡ç½®çŠ¶æ€ (60000ms)
[useMessageSending] ğŸš¨ forceResetSendingState: å¼ºåˆ¶é‡ç½®çŠ¶æ€
[useMessageSending] âœ… çŠ¶æ€å·²å¼ºåˆ¶é‡ç½®
```
å¯ç”¨è¶…æ—¶ä¿æŠ¤æ—¶çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
[useMessageSending] â° å·²å¯åŠ¨è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨ï¼ˆ60000ms = 60ç§’ï¼‰
```

è¶…æ—¶è§¦å‘æ—¶çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
[useMessageSending] â±ï¸ å‘é€è¶…æ—¶ï¼è‡ªåŠ¨å¼ºåˆ¶é‡ç½®çŠ¶æ€ (60000ms)
[useMessageSending] ğŸš¨ forceResetSendingState: å¼ºåˆ¶é‡ç½®çŠ¶æ€
[useMessageSending] âœ… çŠ¶æ€å·²å¼ºåˆ¶é‡ç½®
```

ç¦ç”¨è¶…æ—¶ä¿æŠ¤æ—¶çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
[useMessageSending] âš ï¸ è¶…æ—¶ä¿æŠ¤å·²ç¦ç”¨ (sendTimeoutMs = 0)
```

## ç‰ˆæœ¬å†å²

- **v0.10.0** (2025-01): åˆå§‹å®ç°ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¶…æ—¶æ—¶é•¿
- **æœªæ¥è®¡åˆ’**: 
  - æ ¹æ®æ¨¡å‹ç±»å‹è‡ªåŠ¨è°ƒæ•´è¶…æ—¶æ—¶é•¿
  - ç½‘ç»œè´¨é‡æ£€æµ‹è‡ªé€‚åº”è¶…æ—¶
  - è¶…æ—¶é‡è¯•æœºåˆ¶

## å‚è€ƒèµ„æ–™

- [å¹½çµä»»åŠ¡ Bug ä¿®å¤æ–‡æ¡£](../FIX_GHOST_TASK_COMPLETE.md)
- [æ¶ˆæ¯å‘é€æ¶æ„](../MODERN_CHAT_INPUT_IMPLEMENTATION.md)
- [é…ç½®ç®¡ç†è§„èŒƒ](../CONFIG_GOVERNANCE.md)
