# ä¿®å¤å¹½çµä»»åŠ¡ Bugï¼ˆGhost Task Stallï¼‰

## é—®é¢˜æè¿°

### ç—‡çŠ¶
ç”¨æˆ·ç‚¹å‡»å‘é€åï¼š
- âœ… UI åˆ›å»ºäº†æ¶ˆæ¯æ°”æ³¡ï¼ˆUser + Assistantï¼‰
- âŒ æ²¡æœ‰å®é™…å‘èµ·ç½‘ç»œè¯·æ±‚
- âŒ UI æ°¸è¿œå¡åœ¨"å‘é€ä¸­"çŠ¶æ€
- âŒ åç»­ç‚¹å‡»å‘é€æŒ‰é’®æ— å“åº”

### æ ¹æœ¬åŸå› 
å¹¶å‘çŠ¶æ€ç®¡ç†å­˜åœ¨è‡´å‘½ç¼ºé™·ï¼š

1. **çŠ¶æ€ä¸åŒ¹é…ï¼ˆContext Mismatchï¼‰**
   - å…¨å±€ `pendingSend` ä¿ç•™äº†æ—§ä»»åŠ¡çš„å¼•ç”¨
   - æ–°ä»»åŠ¡åˆ›å»ºæ—¶æ£€æµ‹åˆ°å…¨å±€çŠ¶æ€å·²å ç”¨
   - æ–°ä»»åŠ¡åˆ›å»ºäº† UI ä½†**æ²¡æœ‰å‘èµ·è¯·æ±‚**å°±é€€å‡º
   - `finishPendingSend` å‘ç°ä¸Šä¸‹æ–‡ä¸åŒ¹é…ï¼Œ**é™é»˜è¿”å›**
   - ç»“æœï¼šUI æœ‰æ°”æ³¡ä½†æ²¡æœ‰è¯·æ±‚ï¼ŒçŠ¶æ€æ°¸ä¹…å¡æ­»

2. **ç¼ºä¹è¶…æ—¶ä¿æŠ¤**
   - å¦‚æœç½‘ç»œè¯·æ±‚æŒ‚èµ·ï¼ˆä»£ç†å¤±æ•ˆã€API æ— å“åº”ï¼‰
   - æ²¡æœ‰æœºåˆ¶å¼ºåˆ¶æ¸…ç†çŠ¶æ€
   - ç”¨æˆ·æ— æ³•æ¢å¤ï¼Œåªèƒ½åˆ·æ–°é¡µé¢

3. **finally å—æ‰§è¡Œæ—¶æœºé—®é¢˜**
   - åœ¨æŸäº›æƒ…å†µä¸‹ï¼ˆæŠ›å‡ºå¼‚å¸¸ã€æå‰ returnï¼‰ï¼Œ`finally` å—ä¼šåœ¨ UI åˆ›å»ºåç«‹å³æ‰§è¡Œ
   - å¦‚æœæ­¤æ—¶ `pendingSend` ä¸åŒ¹é…ï¼ŒçŠ¶æ€æ— æ³•æ­£ç¡®æ¸…ç†

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. å¹½çµä»»åŠ¡æ£€æµ‹ä¸æ¸…ç† âœ…

**æ–‡ä»¶**: `src/composables/useMessageSending.ts`

**ä½ç½®**: `performSendMessage` å‡½æ•°å¼€å§‹å¤„

```typescript
// ğŸ›¡ï¸ å¹¶å‘ä¿æŠ¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¹½çµä»»åŠ¡ï¼ˆè„çŠ¶æ€ï¼‰
if (pendingSend.value) {
  const existingCtx = pendingSend.value
  
  // å¦‚æœæ˜¯æ­£åœ¨è°ƒåº¦çš„ä»»åŠ¡ï¼Œé˜»æ­¢é‡å¤å‘é€
  if (existingCtx.state === 'scheduled') {
    console.warn('[useMessageSending] âš ï¸ æ£€æµ‹åˆ°æ­£åœ¨è°ƒåº¦çš„ä»»åŠ¡ï¼Œé˜»æ­¢é‡å¤å‘é€')
    return { success: false, error: 'å·²å­˜åœ¨ä¸€ä¸ªå¾…å‘é€çš„æ¶ˆæ¯' }
  }
  
  // ğŸš¨ æ£€æµ‹å¹½çµä»»åŠ¡ï¼šçŠ¶æ€æ˜¯ 'sent' ä½†æ²¡æœ‰å¯¹åº”çš„ç½‘ç»œè¯·æ±‚
  if (existingCtx.state === 'sent') {
    console.error('[useMessageSending] ğŸš¨ æ£€æµ‹åˆ°å¹½çµä»»åŠ¡ï¼ˆè„çŠ¶æ€ï¼‰ï¼Œå¼ºåˆ¶æ¸…ç†')
    
    // å¼ºåˆ¶æ¸…ç†ï¼šå–æ¶ˆè®¡æ—¶å™¨ã€æ¸…ç©ºå…¨å±€çŠ¶æ€
    if (existingCtx.timerId != null) {
      clearTimeout(existingCtx.timerId)
    }
    pendingSend.value = null
    
    // é‡ç½®å‘é€çŠ¶æ€
    isSending.value = false
    isStreaming.value = false
    
    console.log('[useMessageSending] âœ… å¹½çµä»»åŠ¡å·²æ¸…ç†ï¼Œç»§ç»­æ­£å¸¸å‘é€æµç¨‹')
  }
}
```

**æ•ˆæœ**ï¼š
- åœ¨æ¯æ¬¡å‘é€å‰è‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†è„çŠ¶æ€
- é˜²æ­¢å¹½çµä»»åŠ¡å ç”¨å…¨å±€é”

---

### 2. ä¸Šä¸‹æ–‡ä¸åŒ¹é…å¼ºåˆ¶æ¥ç®¡ âœ…

**æ–‡ä»¶**: `src/composables/useMessageSending.ts`

**ä½ç½®**: `finishPendingSend` å‡½æ•°

```typescript
// ğŸš¨ æ£€æµ‹ä¸åŒ¹é…ï¼šå½“å‰ä¸Šä¸‹æ–‡ä¸å…¨å±€çŠ¶æ€ä¸ä¸€è‡´
if (!pendingSend.value || pendingSend.value !== ctx) {
  console.error('[useMessageSending] ğŸš¨ finishPendingSend: ä¸Šä¸‹æ–‡ä¸åŒ¹é…ï¼')
  
  // ğŸ›¡ï¸ å¼ºåˆ¶æ¸…ç†å¹½çµä»»åŠ¡ï¼šå¦‚æœå½“å‰ä»»åŠ¡å·²ç»åˆ›å»ºäº† UI åˆ†æ”¯ï¼Œå¿…é¡»å¤„ç†
  if (ctx.state === 'scheduled') {
    console.error('[useMessageSending] ğŸ”§ å¼ºåˆ¶æ¸…ç†å¹½çµä»»åŠ¡å¹¶æ¥ç®¡å‘é€æµç¨‹')
    
    // æ¥ç®¡ï¼šå°†å½“å‰ä¸Šä¸‹æ–‡è®¾ç½®ä¸ºå…¨å±€çŠ¶æ€
    pendingSend.value = ctx
    
    // ç»§ç»­æ­£å¸¸æµç¨‹ï¼ˆä¸è¦ returnï¼‰
  } else {
    // å¦‚æœå·²ç»æ˜¯ 'sent' æˆ– 'cancelled'ï¼Œè¯´æ˜å·²ç»å¤„ç†è¿‡äº†
    console.warn('[useMessageSending] âš ï¸ ä»»åŠ¡å·²å¤„ç†ï¼Œè·³è¿‡')
    return ctx.completionPromise
  }
}
```

**æ•ˆæœ**ï¼š
- ä¸å†é™é»˜å¤±è´¥
- å¼ºåˆ¶æ¥ç®¡å¹½çµä»»åŠ¡ï¼Œç¡®ä¿ UI æœ‰å¯¹åº”çš„ç½‘ç»œè¯·æ±‚

---

### 3. è¶…æ—¶è‡ªåŠ¨é‡ç½®æœºåˆ¶ âœ…

**æ–‡ä»¶**: `src/composables/useMessageSending.ts`

**æ–°å¢åŠŸèƒ½**ï¼š

#### 3.1 è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨
```typescript
// ğŸ›¡ï¸ è¶…æ—¶ä¿æŠ¤ï¼šé˜²æ­¢å¹½çµä»»åŠ¡æ°¸ä¹…å ç”¨çŠ¶æ€
const SEND_TIMEOUT_MS = 60000 // 60 ç§’

function startSendTimeout() {
  sendTimeoutTimer = window.setTimeout(() => {
    console.error('[useMessageSending] â±ï¸ å‘é€è¶…æ—¶ï¼è‡ªåŠ¨å¼ºåˆ¶é‡ç½®çŠ¶æ€')
    forceResetSendingState()
    
    sendError.value = 'å‘é€è¶…æ—¶ï¼ˆ60ç§’æ— å“åº”ï¼‰ï¼Œå·²è‡ªåŠ¨é‡ç½®çŠ¶æ€'
  }, SEND_TIMEOUT_MS)
}
```

#### 3.2 å¼ºåˆ¶é‡ç½®çŠ¶æ€æ–¹æ³•
```typescript
function forceResetSendingState() {
  console.warn('[useMessageSending] ğŸš¨ forceResetSendingState: å¼ºåˆ¶é‡ç½®çŠ¶æ€')
  
  // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
  if (sendTimeoutTimer) clearTimeout(sendTimeoutTimer)
  
  // å–æ¶ˆç½‘ç»œè¯·æ±‚
  if (abortController.value) abortController.value.abort()
  
  // æ¸…ç† pendingSend
  if (pendingSend.value) {
    if (pendingSend.value.timerId) clearTimeout(pendingSend.value.timerId)
    pendingSend.value.resolveCompletion({ success: false, error: 'Force reset' })
    pendingSend.value = null
  }
  
  // é‡ç½®æ‰€æœ‰çŠ¶æ€æ ‡å¿—
  isSending.value = false
  isStreaming.value = false
  streamingBranchId.value = null
}
```

**æ•ˆæœ**ï¼š
- 60 ç§’æ— å“åº”è‡ªåŠ¨æ¢å¤
- æš´éœ² `forceResetSendingState` ä¾›ç´§æ€¥æ¢å¤ä½¿ç”¨

---

### 4. finally å—å¼ºåŒ–æ¸…ç† âœ…

**æ–‡ä»¶**: `src/composables/useMessageSending.ts`

**ä½ç½®**: `sendMessageCore` å‡½æ•°çš„ `finally` å—

```typescript
} finally {
  // ğŸ›¡ï¸ å¼ºåˆ¶æ¸…ç†ï¼šç¡®ä¿çŠ¶æ€ä¸ä¼šæ³„æ¼
  console.log('[useMessageSending] ğŸ§¹ finally: æ¸…ç†å‘é€çŠ¶æ€')
  
  // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
  clearSendTimeout()
  
  isSending.value = false
  abortController.value = null
  
  // å¦‚æœ pendingSend è¿˜æŒ‡å‘å½“å‰ä»»åŠ¡ï¼Œæ¸…ç©ºå®ƒ
  if (pendingSend.value?.conversationId === targetConversationId) {
    console.log('[useMessageSending] ğŸ§¹ finally: æ¸…ç† pendingSend æ®‹ç•™')
    pendingSend.value = null
  }
}
```

**æ•ˆæœ**ï¼š
- æ— è®ºæˆåŠŸ/å¤±è´¥/å¼‚å¸¸ï¼Œéƒ½å¼ºåˆ¶æ¸…ç†çŠ¶æ€
- é˜²æ­¢çŠ¶æ€æ³„æ¼åˆ°ä¸‹ä¸€æ¬¡å‘é€

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šå¹½çµä»»åŠ¡æ£€æµ‹
1. æ¨¡æ‹Ÿï¼šé¡µé¢çƒ­é‡è½½å `pendingSend` æ®‹ç•™
2. æ“ä½œï¼šç‚¹å‡»å‘é€
3. é¢„æœŸï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†å¹½çµä»»åŠ¡ï¼Œæ­£å¸¸å‘é€

### æµ‹è¯•åœºæ™¯ 2ï¼šè¶…æ—¶è‡ªåŠ¨æ¢å¤
1. æ¨¡æ‹Ÿï¼šæ–­å¼€ç½‘ç»œ/ç¦ç”¨ä»£ç†
2. æ“ä½œï¼šç‚¹å‡»å‘é€
3. é¢„æœŸï¼š60 ç§’åè‡ªåŠ¨é‡ç½®çŠ¶æ€ï¼Œæ˜¾ç¤ºè¶…æ—¶é”™è¯¯

### æµ‹è¯•åœºæ™¯ 3ï¼šä¸Šä¸‹æ–‡ä¸åŒ¹é…æ¥ç®¡
1. æ¨¡æ‹Ÿï¼šå¹¶å‘ç‚¹å‡»å‘é€æŒ‰é’®ï¼ˆå¿«é€ŸåŒå‡»ï¼‰
2. æ“ä½œï¼šç¬¬äºŒæ¬¡ç‚¹å‡»æ£€æµ‹åˆ°å…¨å±€çŠ¶æ€è¢«å ç”¨
3. é¢„æœŸï¼š
   - æ—§ç‰ˆï¼šç¬¬äºŒæ¬¡ç‚¹å‡»è¢«æ‹’ç»ï¼Œè¿”å›"å·²å­˜åœ¨å¾…å‘é€æ¶ˆæ¯"
   - æ–°ç‰ˆï¼šå¦‚æœç¬¬ä¸€æ¬¡ä»»åŠ¡æ˜¯å¹½çµä»»åŠ¡ï¼Œè‡ªåŠ¨æ¸…ç†å¹¶æ¥ç®¡

---

## ç”¨æˆ·ä¾§å¿«é€Ÿæ¢å¤æ–¹æ³•

å¦‚æœçŠ¶æ€ä»ç„¶å¡æ­»ï¼ˆç½•è§æƒ…å†µï¼‰ï¼Œç”¨æˆ·å¯ä»¥ï¼š

### æ–¹æ³• 1ï¼šç­‰å¾…è‡ªåŠ¨æ¢å¤ï¼ˆæ¨èï¼‰
- ç­‰å¾… 60 ç§’ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡ç½®

### æ–¹æ³• 2ï¼šæµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
```javascript
// å¼ºåˆ¶é‡ç½®çŠ¶æ€
location.reload()  // æœ€ç®€å•çš„æ–¹æ³•
```

### æ–¹æ³• 3ï¼šæ¸…ç†æ•°æ®ï¼ˆå½»åº•æ–¹æ¡ˆï¼‰
```powershell
# Windows PowerShell
cd d:\Starverse
.\clear-all-data.ps1

# é‡å¯åº”ç”¨
npm run dev
```

---

## æ—¥å¿—è¿½è¸ªå…³é”®è¯

ä¿®å¤åæ–°å¢çš„æ—¥å¿—æ ‡è®°ï¼š

- `ğŸš¨ æ£€æµ‹åˆ°å¹½çµä»»åŠ¡` â†’ è‡ªåŠ¨æ¸…ç†è§¦å‘
- `ğŸ”§ å¼ºåˆ¶æ¸…ç†å¹½çµä»»åŠ¡å¹¶æ¥ç®¡` â†’ ä¸Šä¸‹æ–‡æ¥ç®¡è§¦å‘
- `â±ï¸ å‘é€è¶…æ—¶ï¼` â†’ 60 ç§’è¶…æ—¶è§¦å‘
- `ğŸ§¹ finally: æ¸…ç†å‘é€çŠ¶æ€` â†’ finally å—æ‰§è¡Œ
- `â° å·²å¯åŠ¨è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨` â†’ è¶…æ—¶ä¿æŠ¤å¯åŠ¨
- `â° å·²æ¸…é™¤è¶…æ—¶ä¿æŠ¤å®šæ—¶å™¨` â†’ è¯·æ±‚å®Œæˆï¼Œå®šæ—¶å™¨æ¸…ç†

---

## ç›¸å…³æ–‡ä»¶

- **æ ¸å¿ƒä¿®å¤**: `src/composables/useMessageSending.ts` (+120 è¡Œ)
- **è¯Šæ–­æ–‡æ¡£**: `docs/DEBUG_MESSAGE_SENDING_STALL.md` (å·²æ›´æ–°)
- **æµ‹è¯•ç”¨ä¾‹**: `tests/unit/composables/useMessageSending.test.ts` (å¾…è¡¥å……)

---

## ç‰ˆæœ¬å†å²

- **v0.9.0** - é—®é¢˜é¦–æ¬¡å‘ç°
- **v0.9.1** - ä¿®å¤å®æ–½ï¼ˆæœ¬æ¬¡æäº¤ï¼‰
  - å¹½çµä»»åŠ¡æ£€æµ‹ä¸æ¸…ç† âœ…
  - ä¸Šä¸‹æ–‡ä¸åŒ¹é…æ¥ç®¡ âœ…
  - 60 ç§’è¶…æ—¶è‡ªåŠ¨é‡ç½® âœ…
  - finally å—å¼ºåŒ–æ¸…ç† âœ…

---

## åç»­ä¼˜åŒ–æ–¹å‘

- [ ] æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–å¹¶å‘åœºæ™¯
- [ ] UI å±‚é¢æ˜¾ç¤º"è¶…æ—¶æ¢å¤"æç¤ºï¼ˆç”¨æˆ·å‹å¥½ï¼‰
- [ ] è®°å½•å¤±è´¥åŸå› åˆ°å¯¹è¯å†å²ï¼ˆä¾¿äºæ’æŸ¥ï¼‰
- [ ] æ·»åŠ "æ’¤é”€å‘é€"æŒ‰é’®ï¼ˆç½‘ç»œè¯·æ±‚å‰ï¼‰
- [ ] ä½¿ç”¨ Mutex/Lock åº“æ›¿ä»£æ‰‹åŠ¨çŠ¶æ€ç®¡ç†
